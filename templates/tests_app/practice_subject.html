{% extends 'base.html' %}
{% load static icon_tags %}

{% block title %}{{ subject.name }} â€” Mashq | TestMakon{% endblock %}

{% block extra_css %}
<style>
    {% include 'includes/_sidebar_css.html' %}

    body { background: var(--gray-50); }

    /* ===== PAGE HEADER ===== */
    .ps-hero {
        background: var(--white);
        border-bottom: 1px solid var(--gray-200);
        padding: 1.25rem 0 0;
        margin-bottom: 1.5rem;
    }
    .ps-breadcrumb {
        display: flex; align-items: center; gap: 6px;
        font-size: 0.78rem; color: var(--gray-400); font-weight: 500;
        margin-bottom: 1rem;
    }
    .ps-breadcrumb a { color: var(--gray-400); text-decoration: none; transition: color 0.15s; }
    .ps-breadcrumb a:hover { color: var(--primary-dark); }
    .ps-breadcrumb i { font-size: 0.65rem; }

    .ps-hero-inner {
        display: flex; align-items: flex-end; justify-content: space-between; gap: 1rem;
    }
    .ps-hero-left { display: flex; align-items: center; gap: 14px; padding-bottom: 1.25rem; }
    .ps-hero-icon {
        width: 52px; height: 52px; border-radius: 14px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; flex-shrink: 0;
    }
    .ps-hero-title {
        font-size: 1.4rem; font-weight: 900; color: var(--dark); margin: 0 0 3px;
    }
    .ps-hero-meta {
        font-size: 0.78rem; color: var(--gray-500); font-weight: 500;
        display: flex; align-items: center; gap: 10px;
    }
    .ps-hero-meta span { display: inline-flex; align-items: center; gap: 4px; }
    .ps-hero-tabs {
        display: flex; gap: 2px;
    }
    .ps-hero-tab {
        padding: 8px 16px; font-size: 0.8rem; font-weight: 700; border-radius: 8px 8px 0 0;
        cursor: pointer; transition: all 0.15s; color: var(--gray-400);
        border: none; background: transparent;
    }
    .ps-hero-tab.active {
        color: var(--primary-dark); background: var(--gray-50);
        box-shadow: inset 0 -2px 0 var(--primary);
    }

    /* ===== LAYOUT ===== */
    .ps-layout {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 16px;
        align-items: start;
    }
    @media (max-width: 900px) {
        .ps-layout { grid-template-columns: 1fr; }
        .ps-sidebar { position: static !important; order: -1; }
        .ps-hero-tabs { display: none; }
    }

    /* ===== TOPICS CARD ===== */
    .ps-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 14px;
        overflow: hidden;
    }
    .ps-card-head {
        padding: 14px 16px;
        border-bottom: 1px solid var(--gray-100);
        display: flex; align-items: center; justify-content: space-between;
    }
    .ps-card-head-title {
        font-size: 0.82rem; font-weight: 800; color: var(--dark);
        display: flex; align-items: center; gap: 6px;
    }
    .ps-card-head-title i { color: var(--primary); }
    .ps-card-head-cnt {
        font-size: 0.72rem; font-weight: 600; color: var(--gray-400);
        background: var(--gray-100); padding: 3px 10px; border-radius: 20px;
    }

    /* ===== ALL TOPICS OPTION ===== */
    .ps-all-item {
        display: flex; align-items: center; gap: 12px;
        padding: 14px 16px;
        cursor: pointer; transition: background 0.15s;
        border-bottom: 1px solid var(--gray-100);
        background: #FAFCFF;
    }
    .ps-all-item:hover { background: rgba(139,197,64,0.04); }
    .ps-all-item.selected { background: rgba(139,197,64,0.07); }
    .ps-all-radio {
        width: 18px; height: 18px; border-radius: 50%;
        border: 2px solid var(--gray-300); flex-shrink: 0;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.15s;
    }
    .ps-all-item.selected .ps-all-radio {
        border-color: var(--primary); background: var(--primary);
    }
    .ps-all-item.selected .ps-all-radio::after {
        content: ''; width: 6px; height: 6px;
        background: white; border-radius: 50%;
    }
    .ps-all-label { font-size: 0.88rem; font-weight: 700; color: var(--dark); flex: 1; }
    .ps-all-badge {
        font-size: 0.7rem; font-weight: 700;
        background: rgba(139,197,64,0.12); color: var(--primary-dark);
        padding: 3px 10px; border-radius: 20px;
    }

    /* ===== TOPIC LIST ===== */
    .ps-topics-list { padding: 8px; display: flex; flex-direction: column; gap: 3px; }

    .ps-topic {
        display: flex; align-items: center; gap: 10px;
        padding: 10px 10px; border-radius: 10px;
        cursor: pointer; transition: all 0.15s;
        border: 1.5px solid transparent;
        position: relative;
    }
    .ps-topic:hover { background: var(--gray-50); border-color: var(--gray-200); }
    .ps-topic.selected {
        background: rgba(139,197,64,0.07);
        border-color: rgba(139,197,64,0.35);
    }

    .ps-topic-num {
        width: 26px; height: 26px; border-radius: 7px;
        background: var(--gray-100); color: var(--gray-400);
        font-size: 0.7rem; font-weight: 800;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; transition: all 0.15s;
    }
    .ps-topic.selected .ps-topic-num {
        background: var(--primary); color: white;
    }

    .ps-topic-body { flex: 1; min-width: 0; }
    .ps-topic-name {
        font-size: 0.83rem; font-weight: 700; color: var(--dark);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .ps-topic.selected .ps-topic-name { color: var(--primary-dark); }

    .ps-topic-cnt {
        font-size: 0.68rem; font-weight: 700;
        color: var(--gray-400); background: var(--gray-100);
        padding: 2px 8px; border-radius: 12px; white-space: nowrap; flex-shrink: 0;
    }
    .ps-topic.selected .ps-topic-cnt {
        background: rgba(139,197,64,0.15); color: var(--primary-dark);
    }

    /* ===== SIDEBAR ===== */
    .ps-sidebar { position: sticky; top: 88px; }

    .ps-settings-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 14px;
        overflow: hidden;
    }
    .ps-settings-head {
        padding: 14px 16px;
        border-bottom: 1px solid var(--gray-100);
        font-size: 0.82rem; font-weight: 800; color: var(--dark);
        display: flex; align-items: center; gap: 6px;
    }
    .ps-settings-head i { color: var(--gray-400); }
    .ps-settings-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 16px; }

    /* Setting group */
    .ps-sg-label {
        font-size: 0.7rem; font-weight: 800; color: var(--gray-400);
        text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;
    }
    .ps-sg-options { display: flex; gap: 6px; flex-wrap: wrap; }
    .ps-sg-pill {
        padding: 6px 12px; border-radius: 8px;
        border: 1.5px solid var(--gray-200); background: var(--white);
        font-size: 0.78rem; font-weight: 700; color: var(--dark-600);
        cursor: pointer; transition: all 0.15s; user-select: none;
    }
    .ps-sg-pill:hover { border-color: var(--gray-300); background: var(--gray-50); }
    .ps-sg-pill.active {
        border-color: var(--primary); background: rgba(139,197,64,0.1);
        color: var(--primary-dark);
    }

    /* Difficulty specific */
    .ps-sg-pill[data-val="easy"] { border-left: 3px solid #10B981; }
    .ps-sg-pill[data-val="medium"] { border-left: 3px solid #F59E0B; }
    .ps-sg-pill[data-val="hard"] { border-left: 3px solid #EF4444; }
    .ps-sg-pill[data-val="all"] { border-left: 3px solid var(--gray-300); }

    /* Mode pills */
    .ps-mode-list { display: flex; flex-direction: column; gap: 5px; }
    .ps-mode-item {
        display: flex; align-items: center; gap: 10px;
        padding: 9px 12px; border-radius: 10px;
        border: 1.5px solid var(--gray-200);
        cursor: pointer; transition: all 0.15s; user-select: none;
    }
    .ps-mode-item:hover { border-color: var(--gray-300); background: var(--gray-50); }
    .ps-mode-item.active {
        border-color: var(--primary); background: rgba(139,197,64,0.08);
    }
    .ps-mode-icon {
        width: 30px; height: 30px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.9rem; flex-shrink: 0;
        background: var(--gray-100); color: var(--gray-400);
        transition: all 0.15s;
    }
    .ps-mode-item.active .ps-mode-icon { background: rgba(139,197,64,0.15); color: var(--primary-dark); }
    .ps-mode-body { flex: 1; }
    .ps-mode-title { font-size: 0.8rem; font-weight: 800; color: var(--dark); margin-bottom: 1px; }
    .ps-mode-desc { font-size: 0.68rem; color: var(--gray-400); font-weight: 500; }
    .ps-mode-check {
        width: 16px; height: 16px; border-radius: 50%;
        border: 2px solid var(--gray-300); flex-shrink: 0; transition: all 0.15s;
        display: flex; align-items: center; justify-content: center;
    }
    .ps-mode-item.active .ps-mode-check { border-color: var(--primary); background: var(--primary); }
    .ps-mode-item.active .ps-mode-check::after {
        content: ''; width: 5px; height: 5px; background: white; border-radius: 50%;
    }

    /* Summary */
    .ps-summary {
        background: var(--gray-50); border-radius: 10px;
        padding: 10px 12px; display: flex; flex-direction: column; gap: 6px;
    }
    .ps-sum-row {
        display: flex; align-items: center; justify-content: space-between;
        font-size: 0.78rem;
    }
    .ps-sum-label { color: var(--gray-400); font-weight: 500; }
    .ps-sum-val { color: var(--dark); font-weight: 800; }

    /* Start button */
    .ps-start-btn {
        width: 100%; padding: 13px;
        background: var(--gradient-primary); border: none;
        color: white; border-radius: 12px;
        font-size: 0.95rem; font-weight: 800;
        cursor: pointer; transition: all 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        box-shadow: 0 4px 14px rgba(139,197,64,0.3);
    }
    .ps-start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139,197,64,0.4); }
    .ps-start-btn:active { transform: translateY(0); }

    /* Empty */
    .ps-empty {
        padding: 3rem 2rem; text-align: center;
        color: var(--gray-400); font-size: 0.85rem;
    }
    .ps-empty i { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
</style>
{% endblock %}

{% block content %}
<!-- Hero -->
<div class="ps-hero">
    <div class="container">
        <div class="ps-breadcrumb">
            <a href="{% url 'tests_app:tests_list' %}">Testlar</a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'tests_app:question_bank' %}">Savol banki</a>
            <i class="bi bi-chevron-right"></i>
            <span>{{ subject.name }}</span>
        </div>
        <div class="ps-hero-inner">
            <div class="ps-hero-left">
                <div class="ps-hero-icon" style="background: {{ subject.color }}18;">
                    {% subject_icon subject 52 %}
                </div>
                <div>
                    <h1 class="ps-hero-title">{{ subject.name }}</h1>
                    <div class="ps-hero-meta">
                        <span><i class="bi bi-journal-text"></i> {{ total_questions }} ta savol</span>
                        <span><i class="bi bi-collection"></i> {{ topics.count }} ta mavzu</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content -->
<div class="container pb-5">
    <form action="{% url 'tests_app:practice_start' %}" method="post" id="practiceForm">
        {% csrf_token %}
        <input type="hidden" name="subject_id" value="{{ subject.id }}">
        <input type="hidden" name="topic_id" id="topicInput" value="">
        <input type="hidden" name="question_count" id="countInput" value="10">
        <input type="hidden" name="difficulty" id="difficultyInput" value="all">
        <input type="hidden" name="mode" id="modeInput" value="practice">

        <div class="ps-layout">
            <!-- Topics -->
            <div>
                <div class="ps-card">
                    <div class="ps-card-head">
                        <div class="ps-card-head-title">
                            <i class="bi bi-collection"></i> Mavzu tanlang
                        </div>
                        <span class="ps-card-head-cnt">{{ topics.count }} mavzu</span>
                    </div>

                    <!-- All topics -->
                    <div class="ps-all-item selected" data-topic="">
                        <div class="ps-all-radio"></div>
                        <span class="ps-all-label">ðŸ“š Barcha mavzular</span>
                        <span class="ps-all-badge">{{ total_questions }} savol</span>
                    </div>

                    <!-- Topic list -->
                    {% if topics %}
                    <div class="ps-topics-list">
                        {% for topic in topics %}
                        <div class="ps-topic" data-topic="{{ topic.id }}" data-name="{{ topic.name }}">
                            <div class="ps-topic-num">{{ forloop.counter }}</div>
                            <div class="ps-topic-body">
                                <div class="ps-topic-name">{{ topic.name }}</div>
                            </div>
                            <span class="ps-topic-cnt">{{ topic.questions_count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="ps-empty">
                        <i class="bi bi-inbox"></i>
                        Mavzular qo'shilmagan
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="ps-sidebar">
                <div class="ps-settings-card">
                    <div class="ps-settings-head">
                        <i class="bi bi-sliders2"></i> Test sozlamalari
                    </div>
                    <div class="ps-settings-body">

                        <!-- Count -->
                        <div>
                            <div class="ps-sg-label">Savollar soni</div>
                            <div class="ps-sg-options">
                                <div class="ps-sg-pill active" data-group="count" data-val="10">10</div>
                                <div class="ps-sg-pill" data-group="count" data-val="20">20</div>
                                <div class="ps-sg-pill" data-group="count" data-val="30">30</div>
                                <div class="ps-sg-pill" data-group="count" data-val="50">50</div>
                            </div>
                        </div>

                        <!-- Difficulty -->
                        <div>
                            <div class="ps-sg-label">Qiyinlik darajasi</div>
                            <div class="ps-sg-options">
                                <div class="ps-sg-pill active" data-group="diff" data-val="all">Barchasi</div>
                                <div class="ps-sg-pill" data-group="diff" data-val="easy">Oson</div>
                                <div class="ps-sg-pill" data-group="diff" data-val="medium">O'rta</div>
                                <div class="ps-sg-pill" data-group="diff" data-val="hard">Qiyin</div>
                            </div>
                        </div>

                        <!-- Mode -->
                        <div>
                            <div class="ps-sg-label">Mashq turi</div>
                            <div class="ps-mode-list">
                                <div class="ps-mode-item active" data-mode="practice">
                                    <div class="ps-mode-icon"><i class="bi bi-journal-check"></i></div>
                                    <div class="ps-mode-body">
                                        <div class="ps-mode-title">Oddiy mashq</div>
                                        <div class="ps-mode-desc">Javobni ko'rsatadi</div>
                                    </div>
                                    <div class="ps-mode-check"></div>
                                </div>
                                <div class="ps-mode-item" data-mode="timed">
                                    <div class="ps-mode-icon"><i class="bi bi-stopwatch"></i></div>
                                    <div class="ps-mode-body">
                                        <div class="ps-mode-title">Vaqt bilan</div>
                                        <div class="ps-mode-desc">Savol boshiga 2 daqiqa</div>
                                    </div>
                                    <div class="ps-mode-check"></div>
                                </div>
                                <div class="ps-mode-item" data-mode="exam">
                                    <div class="ps-mode-icon"><i class="bi bi-mortarboard"></i></div>
                                    <div class="ps-mode-body">
                                        <div class="ps-mode-title">Imtihon rejimi</div>
                                        <div class="ps-mode-desc">Oxirida natija ko'rinadi</div>
                                    </div>
                                    <div class="ps-mode-check"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="ps-summary">
                            <div class="ps-sum-row">
                                <span class="ps-sum-label">Mavzu</span>
                                <span class="ps-sum-val" id="sumTopic">Barcha</span>
                            </div>
                            <div class="ps-sum-row">
                                <span class="ps-sum-label">Savollar</span>
                                <span class="ps-sum-val" id="sumCount">10 ta</span>
                            </div>
                            <div class="ps-sum-row">
                                <span class="ps-sum-label">Taxminiy vaqt</span>
                                <span class="ps-sum-val" id="sumTime">~20 daq</span>
                            </div>
                        </div>

                        <button type="submit" class="ps-start-btn">
                            <i class="bi bi-play-fill"></i> Mashqni boshlash
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Topic selection
    const allItem = document.querySelector('.ps-all-item');
    const topics = document.querySelectorAll('.ps-topic');

    function selectTopic(el, id, name) {
        allItem.classList.remove('selected');
        topics.forEach(t => t.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('topicInput').value = id;
        document.getElementById('sumTopic').textContent = name;
    }

    allItem.addEventListener('click', () => selectTopic(allItem, '', 'Barcha'));
    topics.forEach(t => {
        t.addEventListener('click', () => selectTopic(t, t.dataset.topic, t.dataset.name));
    });

    // Count & Difficulty pills
    document.querySelectorAll('.ps-sg-pill').forEach(pill => {
        pill.addEventListener('click', function () {
            const group = this.dataset.group;
            document.querySelectorAll(`.ps-sg-pill[data-group="${group}"]`).forEach(p => p.classList.remove('active'));
            this.classList.add('active');

            if (group === 'count') {
                document.getElementById('countInput').value = this.dataset.val;
                document.getElementById('sumCount').textContent = this.dataset.val + ' ta';
                updateTime();
            } else {
                document.getElementById('difficultyInput').value = this.dataset.val;
            }
        });
    });

    // Mode
    document.querySelectorAll('.ps-mode-item').forEach(item => {
        item.addEventListener('click', function () {
            document.querySelectorAll('.ps-mode-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('modeInput').value = this.dataset.mode;
            updateTime();
        });
    });

    function updateTime() {
        const count = parseInt(document.getElementById('countInput').value);
        const mode = document.getElementById('modeInput').value;
        const mins = mode === 'exam' ? count : count * 2;
        document.getElementById('sumTime').textContent = `~${mins} daq`;
    }
</script>
{% endblock %}
