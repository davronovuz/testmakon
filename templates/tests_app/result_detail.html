{% extends 'base.html' %}
{% load static %}

{% block title %}Natija Tahlili | TestMakon{% endblock %}

{% block extra_css %}
<style>
    @media (max-width: 991px) {
        .result-sticky-sidebar {
            position: static !important;
            max-height: none !important;
            overflow-y: visible !important;
        }
        .result-map-grid {
            grid-template-columns: repeat(8, 1fr) !important;
        }
    }
    @media (max-width: 575px) {
        .section-sm { padding-top: 0.75rem; }
        .card-body.p-4 { padding: 1rem !important; }
        .result-header-stats { display: none !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white border-bottom shadow-sm sticky-top" style="top: 70px; z-index: 99;">
    <div class="container py-3">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'tests_app:my_results' %}" class="btn btn-light btn-sm rounded-circle">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h6 class="fw-bold mb-0">{{ attempt.test.title }}</h6>
                    <small class="text-muted">{{ attempt.started_at|date:"d.m.Y H:i" }}</small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="d-none d-md-block text-end">
                    <small class="text-muted d-block fw-bold text-uppercase" style="font-size: 0.65rem;">Natija</small>
                    <span class="h5 fw-bold {% if attempt.percentage >= 60 %}text-success{% else %}text-danger{% endif %} mb-0">
                        {{ attempt.percentage|floatformat:1 }}%
                    </span>
                </div>
                <div class="vr d-none d-md-block"></div>
                <div class="d-none d-md-block text-end">
                    <small class="text-muted d-block fw-bold text-uppercase" style="font-size: 0.65rem;">Ball</small>
                    <span class="h5 fw-bold text-dark mb-0">{{ attempt.correct_answers }}/{{ attempt.total_questions }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-sm bg-light">
    <div class="container-fluid px-lg-5"> <div class="row g-4">
            <div class="col-lg-3 order-2 order-lg-1">
                <div class="card border-0 shadow-sm sticky-top result-sticky-sidebar" style="top: 160px; max-height: calc(100vh - 180px); overflow-y: auto;">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h6 class="fw-bold mb-0">Savollar Xaritasi</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="d-flex gap-2 mb-3 justify-content-center text-center small">
                            <div><span class="badge bg-success w-100 mb-1">{{ attempt.correct_answers }}</span><br>To'g'ri</div>
                            <div><span class="badge bg-danger w-100 mb-1">{{ attempt.wrong_answers }}</span><br>Xato</div>
                            <div><span class="badge bg-warning w-100 mb-1">{{ attempt.skipped_questions }}</span><br>Bo'sh</div>
                        </div>

                        <div class="d-grid" style="grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            {% for ans in answers %}
                                <a href="#q{{ ans.question.id }}"
                                   class="btn btn-sm fw-bold border-0
                                   {% if ans.is_correct %}btn-success{% elif not ans.selected_answer %}btn-warning text-dark{% else %}btn-danger{% endif %}"
                                   style="width: 100%; aspect-ratio: 1;">
                                    {{ forloop.counter }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- AI Panel -->
                <div class="card border-0 shadow-sm mt-3" style="border-radius:14px; overflow:hidden;">
                    <div class="card-body p-3" style="background:linear-gradient(135deg,rgba(139,197,64,0.08),rgba(107,168,50,0.04)); border:1px solid rgba(139,197,64,0.15);">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div style="width:32px; height:32px; background:var(--gradient-primary,linear-gradient(135deg,#8BC540,#6BA832)); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-size:0.9rem; flex-shrink:0;">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div>
                                <div class="fw-bold" style="font-size:0.82rem; color:#1E293B;">AI Tahlil</div>
                                <div style="font-size:0.7rem; color:#64748B;">Natijangizga asoslangan</div>
                            </div>
                        </div>
                        {% if attempt.percentage < 60 %}
                        <p style="font-size:0.78rem; color:#475569; margin-bottom:0.75rem; line-height:1.5;">
                            <i class="bi bi-lightbulb-fill text-warning me-1"></i>
                            Xato savollaringizni tahlil qilib, <strong>Smart Test</strong> bilan zaif joylarni mustahkamlaing.
                        </p>
                        {% else %}
                        <p style="font-size:0.78rem; color:#475569; margin-bottom:0.75rem; line-height:1.5;">
                            <i class="bi bi-check-circle-fill text-success me-1"></i>
                            Yaxshi natija! <strong>Progress</strong> sahifasida DTM bashoratini ko'ring.
                        </p>
                        {% endif %}
                        <div class="d-flex flex-column gap-1">
                            <a href="{% url 'ai_core:smart_test_generate' %}" class="btn btn-sm w-100 fw-bold" style="background:var(--gradient-primary,linear-gradient(135deg,#8BC540,#6BA832)); color:white; border-radius:8px; font-size:0.78rem; border:none;">
                                <i class="bi bi-lightning-charge-fill me-1"></i>AI Smart Test
                            </a>
                            <a href="{% url 'ai_core:progress_dashboard' %}" class="btn btn-sm w-100 fw-bold" style="background:rgba(59,130,246,0.1); color:#2563EB; border:1px solid rgba(59,130,246,0.2); border-radius:8px; font-size:0.78rem;">
                                <i class="bi bi-bar-chart-line me-1"></i>Progress ko'rish
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9 order-1 order-lg-2">
                <div class="d-flex flex-column gap-4">
                    {% for ans in answers %}
                    <div id="q{{ ans.question.id }}" class="card border-0 shadow-sm rounded-4 overflow-hidden scroll-margin-top" style="scroll-margin-top: 160px;">

                        <div class="card-header py-3 px-4 border-bottom-0 d-flex justify-content-between align-items-center
                                    {% if ans.is_correct %}bg-success bg-opacity-10{% else %}bg-danger bg-opacity-10{% endif %}">
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-white text-dark shadow-sm border rounded-pill px-3">
                                    #{{ forloop.counter }}
                                </span>
                                <span class="fw-bold {% if ans.is_correct %}text-success{% else %}text-danger{% endif %}">
                                    {% if ans.is_correct %}
                                        <i class="bi bi-check-circle-fill me-1"></i> To'g'ri
                                    {% else %}
                                        <i class="bi bi-x-circle-fill me-1"></i> Noto'g'ri
                                    {% endif %}
                                </span>
                            </div>
                            <small class="text-muted">ID: {{ ans.question.id }}</small>
                        </div>

                        <div class="card-body p-4">
                            <h5 class="lh-base text-dark mb-4">{{ ans.question.text|linebreaksbr }}</h5>

                            {% if ans.question.image %}
                                <img src="{{ ans.question.image.url }}" class="img-fluid rounded border mb-4" style="max-height: 300px;">
                            {% endif %}

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="p-3 rounded-3 h-100 border
                                        {% if ans.is_correct %}border-success bg-success bg-opacity-10{% else %}border-danger bg-danger bg-opacity-10{% endif %}">
                                        <small class="text-muted d-block text-uppercase fw-bold mb-2">Sizning javobingiz</small>
                                        <div class="d-flex align-items-start gap-2">
                                            {% if ans.is_correct %}
                                                <i class="bi bi-check-circle-fill text-success mt-1"></i>
                                            {% else %}
                                                <i class="bi bi-x-circle-fill text-danger mt-1"></i>
                                            {% endif %}
                                            <span class="fw-bold text-dark">
                                                {{ ans.selected_answer.text|default:"Javob belgilanmagan" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                {% if not ans.is_correct %}
                                <div class="col-md-6">
                                    <div class="p-3 rounded-3 h-100 border border-success bg-success bg-opacity-10">
                                        <small class="text-success d-block text-uppercase fw-bold mb-2">To'g'ri javob</small>
                                        <div class="d-flex align-items-start gap-2">
                                            <i class="bi bi-check-circle-fill text-success mt-1"></i>
                                            <div>
                                                {% for opt in ans.question.answers.all %}
                                                    {% if opt.is_correct %}
                                                        <span class="fw-bold text-dark">{{ opt.text }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            {% if ans.question.explanation %}
                            <div class="mt-4">
                                <button class="btn btn-light text-primary fw-bold d-flex align-items-center gap-2"
                                        type="button" data-bs-toggle="collapse" data-bs-target="#exp{{ ans.id }}">
                                    <i class="bi bi-lightbulb-fill"></i> Tushuntirishni ko'rish
                                </button>
                                <div class="collapse mt-3" id="exp{{ ans.id }}">
                                    <div class="card card-body bg-light border-0 shadow-inner">
                                        <h6 class="fw-bold text-dark mb-2">Yechim:</h6>
                                        <div class="text-muted">{{ ans.question.explanation|linebreaks }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-3 text-end">
                                <a href="{% url 'tests_app:save_question' question_id=ans.question.id %}?next={{ request.path }}"
                                   class="btn btn-link text-muted text-decoration-none btn-sm">
                                    <i class="bi bi-bookmark"></i> Savolni saqlash
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}