{% extends 'base.html' %}
{% load static %}

{% block title %}Test Ishlash | TestMakon{% endblock %}

{% block extra_css %}
<style>
    /* Fokus rejimi uchun maxsus stillar */
    body { background-color: #f8fafc; }

    /* Navbar va Footerni yashirish yoki minimallashtirish (ixtiyoriy) */
    .navbar, .footer { display: none !important; }

    .test-header {
        background: white;
        height: 70px;
        box-shadow: 0 4px 20px -5px rgba(0,0,0,0.1);
        position: fixed;
        top: 0; left: 0; right: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
    }

    .question-container {
        margin-top: 100px;
        margin-bottom: 80px;
        max-width: 900px;
    }

    /* Timer Styles */
    .timer-box {
        background: var(--dark);
        color: white;
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: 700;
        font-family: monospace;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
    }
    .timer-box.warning { background: #ef4444; animation: pulse 1s infinite; }

    /* Answer Cards */
    .answer-option {
        position: relative;
        padding: 1.25rem 1.5rem;
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .answer-option:hover {
        border-color: var(--primary-light);
        background: var(--gray-50);
        transform: translateY(-2px);
    }

    .answer-option.selected {
        border-color: var(--primary);
        background: var(--primary-glow);
        box-shadow: 0 4px 12px var(--primary-glow);
    }

    .answer-radio {
        width: 24px;
        height: 24px;
        border: 2px solid var(--gray-400);
        border-radius: 50%;
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .answer-option.selected .answer-radio {
        border-color: var(--primary);
        border-width: 6px;
    }

    /* Progress Bar */
    .progress-track {
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        overflow: hidden;
        flex-grow: 1;
        margin: 0 20px;
    }
    .progress-fill {
        height: 100%;
        background: var(--gradient-primary);
        transition: width 0.5s ease;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .test-header { padding: 0 1rem; height: 60px; }
        .question-container { margin-top: 80px; padding: 0 1rem; }
        .answer-option { padding: 1rem; }
        .desktop-only { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<header class="test-header">
    <div class="d-flex align-items-center gap-3">
        <a href="{% url 'core:dashboard' %}" class="btn btn-light btn-sm rounded-circle shadow-sm" title="Chiqish" onclick="return confirm('Testni to\'xtatmoqchimisiz? Natijalar saqlanmaydi.');">
            <i class="bi bi-x-lg"></i>
        </a>
        <div class="d-flex flex-column">
            <span class="fw-bold text-dark small">{{ attempt.test.title|truncatechars:30 }}</span>
            <div class="d-flex align-items-center gap-2 small text-muted desktop-only">
                <span>{{ attempt.test.subject.name }}</span>
                <span>â€¢</span>
                <span>{{ current_index|add:"1" }} / {{ total_questions }}</span>
            </div>
        </div>
    </div>

    <div class="progress-track desktop-only" style="max-width: 300px;">
        <div class="progress-fill" style="width: {% widthratio current_index total_questions 100 %}%"></div>
    </div>

    <div class="timer-box" id="timer">
        <i class="bi bi-stopwatch"></i>
        <span id="time-display">00:00</span>
    </div>
</header>

<div class="container question-container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form method="post" action="{% url 'tests_app:test_submit_answer' uuid=attempt.uuid %}" id="questionForm">
                {% csrf_token %}
                <input type="hidden" name="question_id" value="{{ question.id }}">
                <input type="hidden" name="time_spent" id="time_spent" value="0">

                <div class="card border-0 shadow-lg rounded-4 mb-4 overflow-hidden animate__animated animate__fadeIn">
                    <div class="card-body p-4 p-md-5">
                        <div class="d-flex justify-content-between mb-4">
                            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2 rounded-pill">
                                Savol {{ current_index|add:"1" }}
                            </span>
                            <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">
                                {{ question.points }} Ball
                            </span>
                        </div>

                        <h4 class="fw-bold text-dark mb-4 lh-base" style="font-size: 1.35rem;">
                            {{ question.text|linebreaksbr }}
                        </h4>

                        {% if question.image %}
                        <div class="mb-4 text-center">
                            <img src="{{ question.image.url }}" class="img-fluid rounded-3 border shadow-sm" style="max-height: 400px;" alt="Question Image">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="row g-3">
                    {% for answer in answers %}
                    <div class="col-12 col-md-6">
                        <label class="answer-option h-100" onclick="selectAnswer(this)">
                            <div class="answer-radio"></div>
                            <input type="radio" name="answer_id" value="{{ answer.id }}" class="d-none" required>

                            <div class="flex-grow-1">
                                {% if answer.image %}
                                    <img src="{{ answer.image.url }}" class="img-fluid rounded mb-2 d-block" style="max-height: 150px;">
                                {% endif %}
                                <span class="fw-medium text-dark-700" style="font-size: 1.05rem;">{{ answer.text }}</span>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-between align-items-center mt-5">
                    <div class="text-muted small">
                        {% if current_index > 0 %}
                            {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold shadow-primary rounded-pill d-flex align-items-center gap-2">
                        {% if current_index|add:"1" == total_questions %}
                            Yakunlash <i class="bi bi-check-circle-fill"></i>
                        {% else %}
                            Keyingi <i class="bi bi-arrow-right"></i>
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Timer Logic
    let totalSeconds = {{ remaining_time }};
    let timeSpent = 0;
    const timerDisplay = document.getElementById('time-display');
    const timerBox = document.getElementById('timer');
    const timeSpentInput = document.getElementById('time_spent');

    function updateTimer() {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Warning state
        if (totalSeconds < 60) {
            timerBox.classList.add('warning');
        }

        if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            document.getElementById('questionForm').submit(); // Auto submit
        } else {
            totalSeconds--;
            timeSpent++;
            timeSpentInput.value = timeSpent;
        }
    }

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer(); // Initial call

    // Selection UI Logic
    function selectAnswer(element) {
        // Remove selected class from all
        document.querySelectorAll('.answer-option').forEach(el => el.classList.remove('selected'));
        // Add to clicked
        element.classList.add('selected');
        // Check the radio inside (redundant but safe)
        const radio = element.querySelector('input[type="radio"]');
        radio.checked = true;
    }
</script>
{% endblock %}