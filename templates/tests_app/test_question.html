{% extends 'base.html' %}
{% load static %}

{% block title %}Test Jarayoni | TestMakon{% endblock %}

{% block extra_css %}
<style>
    /* 1. Asosiy Ekran Sozlamalari */
    body { background-color: #f8fafc; height: 100vh; overflow: hidden; }
    .navbar, .footer { display: none !important; } /* Standart menyuni yashirish */

    /* 2. Grid Layout (Chap va O'ng tomon) */
    .exam-wrapper {
        display: grid;
        grid-template-columns: 1fr 320px;
        height: 100vh;
    }

    /* --- CHAP TOMON (Savol qismi) --- */
    .question-area {
        overflow-y: auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #f1f5f9;
    }

    .question-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        width: 100%;
        max-width: 900px;
        padding: 40px;
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
    }

    /* Toolbar (AI, Chat, Save tugmalari) */
    .tools-bar {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 900px;
        margin-bottom: 20px;
    }

    .tool-btn {
        border: none;
        background: white;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 600;
        color: var(--dark-600);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.2s;
        display: flex; align-items: center; gap: 8px;
        font-size: 0.9rem;
        cursor: pointer;
    }
    .tool-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

    .btn-ai { color: var(--primary-dark); border: 1px solid rgba(139,197,64,0.3); }
    .btn-ai:hover { background: var(--gradient-primary); color: white; border-color: transparent; }

    /* ========== AI MODAL ========== */
    .ai-mheader {
        display: flex; align-items: center; justify-content: space-between;
        padding: 1rem 1.5rem;
        background: var(--gradient-primary);
    }
    .ai-mavatar {
        width: 40px; height: 40px; border-radius: 12px;
        background: rgba(255,255,255,0.22);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.15rem; color: white;
    }
    .ai-mname { font-size: 1rem; font-weight: 700; color: white; }
    .ai-msub  { font-size: 0.72rem; color: rgba(255,255,255,0.75); margin-top: 0.1rem; }
    .ai-status-dot {
        display: inline-block; width: 6px; height: 6px; border-radius: 50%;
        background: #4ADE80; margin-right: 4px; animation: sPulse 2s infinite;
    }
    @keyframes sPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .ai-mclose {
        width: 32px; height: 32px; border-radius: 9px; border: none;
        background: rgba(255,255,255,0.18); color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.85rem; cursor: pointer; transition: background 0.2s;
    }
    .ai-mclose:hover { background: rgba(255,255,255,0.32); }

    /* Warning step */
    .ai-warning {
        padding: 2rem 1.5rem; text-align: center;
    }
    .ai-warning-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .ai-warning h5 { font-size: 1.05rem; font-weight: 800; color: var(--dark); margin-bottom: 0.5rem; }
    .ai-warning p  { font-size: 0.88rem; color: var(--gray-500); margin-bottom: 1.5rem; line-height: 1.6; }
    .ai-warning-penalty {
        display: inline-block; background: rgba(239,68,68,0.1);
        color: #DC2626; font-weight: 700; padding: 0.2rem 0.6rem;
        border-radius: 6px; font-size: 0.9rem;
    }
    .ai-warning-btns { display: flex; flex-direction: column; gap: 0.65rem; }
    .ai-warn-confirm {
        padding: 0.75rem; border: none; border-radius: 10px;
        background: var(--gradient-primary); color: white;
        font-weight: 700; font-size: 0.92rem; cursor: pointer;
        transition: all 0.2s; box-shadow: var(--shadow-primary);
    }
    .ai-warn-confirm:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(139,197,64,0.4); }
    .ai-warn-cancel {
        padding: 0.7rem; border: 1px solid var(--gray-200); border-radius: 10px;
        background: var(--gray-50); color: var(--dark-600);
        font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s;
    }
    .ai-warn-cancel:hover { background: var(--gray-100); }

    /* Chat area */
    .ai-qpreview {
        padding: 0.85rem 1.5rem;
        background: rgba(139,197,64,0.06);
        border-bottom: 1px solid var(--gray-200);
    }
    .ai-qlabel {
        font-size: 0.68rem; font-weight: 700; color: var(--primary-dark);
        text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem;
    }
    .ai-qtext {
        font-size: 0.85rem; color: var(--dark); line-height: 1.5;
        display: -webkit-box; -webkit-line-clamp: 3;
        -webkit-box-orient: vertical; overflow: hidden;
    }
    .ai-chat-body {
        height: 320px; overflow-y: auto; padding: 1.25rem;
        display: flex; flex-direction: column; gap: 1rem;
        scroll-behavior: smooth;
    }
    .ai-chat-body::-webkit-scrollbar { width: 4px; }
    .ai-chat-body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .ai-loading {
        display: flex; align-items: center; gap: 0.75rem;
    }
    .ai-loading-avatar {
        width: 30px; height: 30px; border-radius: 9px; flex-shrink: 0;
        background: var(--gradient-primary);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.82rem; color: white;
    }
    .ai-dots { display: flex; gap: 5px; align-items: center; }
    .ai-dot {
        width: 7px; height: 7px; border-radius: 50%;
        background: var(--primary); animation: aBounce 1.2s infinite;
    }
    .ai-dot:nth-child(2) { animation-delay: 0.15s; }
    .ai-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes aBounce { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-7px);opacity:1} }

    .ai-bot-msg { display: flex; gap: 0.65rem; align-items: flex-start; animation: aFade 0.3s ease; }
    @keyframes aFade { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
    .ai-bot-avatar {
        width: 30px; height: 30px; border-radius: 9px; flex-shrink: 0;
        background: var(--gradient-primary);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.82rem; color: white;
    }
    .ai-bot-bubble {
        flex: 1; background: rgba(139,197,64,0.07);
        border: 1px solid rgba(139,197,64,0.18);
        border-radius: 4px 14px 14px 14px;
        padding: 0.8rem 1rem; font-size: 0.875rem;
        color: var(--dark); line-height: 1.7;
    }
    .ai-user-msg  { display: flex; justify-content: flex-end; animation: aFade 0.3s ease; }
    .ai-user-bubble {
        background: var(--gray-100); border: 1px solid var(--gray-200);
        border-radius: 14px 4px 14px 14px;
        padding: 0.7rem 1rem; font-size: 0.875rem;
        color: var(--dark); max-width: 85%; line-height: 1.6;
    }
    .ai-chat-footer {
        padding: 0.875rem 1.5rem;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
    }
    .ai-input-row { display: flex; gap: 0.5rem; align-items: center; }
    .ai-cinput {
        flex: 1; padding: 0.6rem 1rem;
        border: 1px solid var(--gray-200); border-radius: 50px;
        font-size: 0.875rem; font-family: inherit;
        background: white; color: var(--dark); outline: none; transition: all 0.2s;
    }
    .ai-cinput:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
    .ai-csend {
        width: 36px; height: 36px; border-radius: 50%; border: none;
        background: var(--gradient-primary); color: white; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.85rem; flex-shrink: 0; transition: all 0.2s;
    }
    .ai-csend:hover { transform: scale(1.08); box-shadow: var(--shadow-primary); }
    .ai-csend:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }
    .ai-disclaimer { font-size: 0.68rem; color: var(--gray-400); text-align: center; margin-top: 0.45rem; }

    .btn-save { color: #F59E0B; }
    .btn-report { color: #EF4444; }

    /* Javob Variantlari */
    .option-card {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 15px;
        background: white;
    }

    .option-card:hover { border-color: #cbd5e1; background: #f8fafc; }

    .option-card.selected {
        border-color: var(--primary);
        background: rgba(139, 197, 64, 0.05);
        box-shadow: 0 0 0 1px var(--primary);
    }

    .option-key {
        width: 32px; height: 32px;
        border-radius: 8px;
        background: #e2e8f0;
        color: #64748b;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .option-card.selected .option-key {
        background: var(--primary); color: white;
    }

    /* --- O'NG TOMON (Sidebar) --- */
    .sidebar-panel {
        background: white;
        border-left: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        padding: 20px;
        height: 100vh;
        z-index: 100;
        box-shadow: -5px 0 20px rgba(0,0,0,0.02);
    }

    .timer-display {
        background: var(--dark);
        color: white;
        font-family: 'Courier New', monospace;
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .timer-display.danger { background: #EF4444; animation: pulse 1s infinite; }

    .q-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        overflow-y: auto;
        flex-grow: 1;
        padding-bottom: 20px;
        align-content: start;
    }

    .q-cell {
        aspect-ratio: 1;
        display: flex; align-items: center; justify-content: center;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        color: #64748b;
        text-decoration: none;
    }

    .q-cell:hover { background: #e2e8f0; transform: translateY(-1px); }
    .q-cell.current { border: 2px solid var(--primary); color: var(--primary); background: white; }
    .q-cell.answered { background: var(--primary); color: white; border-color: var(--primary); }

    /* Mobil Moslashuv */
    @media (max-width: 992px) {
        .exam-wrapper { grid-template-columns: 1fr; }
        .sidebar-panel {
            position: fixed; right: -100%; top: 0;
            transition: 0.3s; width: 280px;
        }
        .sidebar-panel.active { right: 0; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
        .question-area { padding-top: 80px; padding-left: 1rem; padding-right: 1rem; }
        .mobile-header { display: flex !important; }
    }

    .mobile-header {
        display: none; position: fixed; top: 0; left: 0; right: 0;
        height: 60px; background: white; z-index: 99;
        align-items: center; justify-content: space-between; padding: 0 20px;
        border-bottom: 1px solid #e2e8f0;
    }
</style>
{% endblock %}

{% block content %}

<div class="mobile-header">
    <div class="fw-bold text-truncate" style="max-width: 200px;">{{ attempt.test.title }}</div>
    <div class="d-flex align-items-center gap-3">
        <span class="badge bg-dark" id="mobileTimer">00:00</span>
        <button class="btn btn-light border" onclick="toggleSidebar()"><i class="bi bi-grid-fill"></i></button>
    </div>
</div>

<div class="exam-wrapper">
    <main class="question-area">

        <div class="tools-bar">
            <div class="d-flex gap-2">
                <button type="button" class="tool-btn btn-ai" data-bs-toggle="modal" data-bs-target="#aiModal">
                    <i class="bi bi-stars"></i> AI Yordam
                </button>
                <button type="button" class="tool-btn btn-chat" data-bs-toggle="offcanvas" data-bs-target="#commentsCanvas">
                    <i class="bi bi-chat-text"></i> Chat
                </button>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'tests_app:save_question' question_id=question.id %}?next={{ request.path }}" class="tool-btn btn-save text-decoration-none" title="Savolni saqlash">
                    <i class="bi bi-bookmark"></i>
                </a>
                <button type="button" class="tool-btn btn-report" title="Xatolik haqida xabar">
                    <i class="bi bi-flag"></i>
                </button>
            </div>
        </div>

        <form method="post" action="{% url 'tests_app:test_submit_answer' uuid=attempt.uuid %}" id="mainForm" class="w-100 d-flex flex-column align-items-center">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="time_spent" id="time_spent" value="0">
            <input type="hidden" name="used_ai" id="used_ai" value="false">

            <div class="question-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">Savol #{{ current_index|add:"1" }}</span>
                    <span class="fw-bold text-primary">{{ question.points }} Ball</span>
                </div>

                <h4 class="fw-bold text-dark lh-base mb-4" style="font-size: 1.25rem;">
                    {{ question.text|linebreaksbr }}
                </h4>

                {% if question.image %}
                    <div class="text-center mb-4">
                        <img src="{{ question.image.url }}" class="img-fluid rounded-3 border" style="max-height: 350px;">
                    </div>
                {% endif %}

                <div class="options-list">
                    {% for answer in answers %}
                    <label class="option-card {% if answer.id == selected_answer_id %}selected{% endif %}" onclick="selectOption(this)">
                        <input type="radio" name="answer_id" value="{{ answer.id }}" class="d-none"
                               {% if answer.id == selected_answer_id %}checked{% endif %}>
                        <div class="option-key">
                            {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% else %}E{% endif %}
                        </div>
                        <div class="flex-grow-1 fw-medium text-dark">{{ answer.text }}</div>
                        {% if answer.image %}
                            <img src="{{ answer.image.url }}" class="rounded" style="height: 40px;">
                        {% endif %}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="d-flex justify-content-between w-100 max-w-900 mt-2">
                {% if current_index > 0 %}
                <a href="{% url 'tests_app:test_question_jump' uuid=attempt.uuid question_index=current_index %}" class="btn btn-white border px-4 py-2 fw-bold text-muted">
                    <i class="bi bi-arrow-left me-2"></i> Oldingi
                </a>
                {% else %}
                <div></div>
                {% endif %}

                {% if current_index|add:"1" < total_questions %}
                <button type="submit" class="btn btn-primary px-5 py-2 fw-bold shadow-primary">
                    Keyingi <i class="bi bi-arrow-right ms-2"></i>
                </button>
                {% else %}
                <button type="button" class="btn btn-success px-5 py-2 fw-bold shadow-success" data-bs-toggle="modal" data-bs-target="#finishModal">
                    Yakunlash <i class="bi bi-check-circle-fill ms-2"></i>
                </button>
                {% endif %}
            </div>
        </form>
    </main>

    <aside class="sidebar-panel" id="sidebar">
        <div class="d-flex justify-content-between align-items-center d-lg-none mb-4">
            <h5 class="fw-bold m-0">Menu</h5>
            <button class="btn-close" onclick="toggleSidebar()"></button>
        </div>

        <div class="timer-display" id="desktopTimer">00:00</div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted fw-bold text-uppercase">Savollar xaritasi</small>
            <span class="badge bg-light text-dark border">{{ total_questions }} ta</span>
        </div>

        <div class="q-grid">
            {% for q_map in questions_map %}
            <a href="{% url 'tests_app:test_question_jump' uuid=attempt.uuid question_index=q_map.index %}"
               class="q-cell {{ q_map.status }}">
                {{ q_map.index }}
            </a>
            {% endfor %}
        </div>

        <div class="mt-auto pt-3 border-top">
            <button class="btn btn-outline-danger w-100 fw-bold py-2" data-bs-toggle="modal" data-bs-target="#exitModal">
                <i class="bi bi-box-arrow-right me-2"></i> Chiqish
            </button>
        </div>
    </aside>
</div>

<div class="modal fade" id="aiModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

            <!-- Header -->
            <div class="ai-mheader">
                <div class="d-flex align-items-center gap-3">
                    <div class="ai-mavatar"><i class="bi bi-stars"></i></div>
                    <div>
                        <div class="ai-mname">AI Yordamchi</div>
                        <div class="ai-msub"><span class="ai-status-dot"></span>Gemini AI ¬∑ Shaxsiy mentor</div>
                    </div>
                </div>
                <button type="button" class="ai-mclose" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Step 1: Warning -->
            <div id="aiWarning" class="ai-warning">
                <div class="ai-warning-icon">ü§î</div>
                <h5>AI yordamdan foydalanasizmi?</h5>
                <p>
                    Agar AI yordamidan foydalansangiz, bu savol uchun beriladigan ball
                    <span class="ai-warning-penalty">50% ga kamayadi</span>.
                    <br>Mustaqil yechishga harakat qildingizmi?
                </p>
                <div class="ai-warning-btns">
                    <button class="ai-warn-confirm" onclick="confirmAI()">
                        <i class="bi bi-stars me-2"></i>Roziman, AI yordam bersin
                    </button>
                    <button class="ai-warn-cancel" data-bs-dismiss="modal">
                        O'zim yechaman
                    </button>
                </div>
            </div>

            <!-- Step 2: AI Chat -->
            <div id="aiChat" class="d-none">
                <div class="ai-qpreview">
                    <div class="ai-qlabel"><i class="bi bi-question-circle me-1"></i>Joriy savol</div>
                    <div class="ai-qtext">{{ question.text|truncatechars:250 }}</div>
                </div>

                <div class="ai-chat-body" id="aiChatBody"></div>

                <div class="ai-chat-footer">
                    <div class="ai-input-row">
                        <input type="text" class="ai-cinput" id="aiChatInput"
                               placeholder="Qo'shimcha savol yozing..."
                               onkeydown="if(event.key==='Enter'){sendAIFollow();event.preventDefault();}">
                        <button class="ai-csend" id="aiCSendBtn" onclick="sendAIFollow()">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                    <div class="ai-disclaimer">‚ö†Ô∏è AI xato qilishi mumkin. Javobni o'zingiz tekshiring.</div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="commentsCanvas">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">Munozara</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body bg-light p-0">
        <div class="p-3 d-flex flex-column gap-3" style="height: calc(100vh - 130px); overflow-y: auto;">
            <div class="text-center text-muted small py-5">
                <i class="bi bi-chat-square-dots display-4 d-block mb-3 opacity-25"></i>
                Hozircha fikrlar yo'q. Birinchi bo'lib yozing!
            </div>
        </div>
        <div class="p-3 bg-white border-top position-absolute bottom-0 w-100">
            <div class="input-group">
                <input type="text" class="form-control bg-light" placeholder="Fikringizni yozing...">
                <button class="btn btn-primary"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="finishModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-4 text-center">
                <i class="bi bi-check-circle-fill text-success display-4 mb-3"></i>
                <h4 class="fw-bold">Testni yakunlaysizmi?</h4>
                <p class="text-muted">Barcha belgilanmagan javoblar xato deb hisoblanadi.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Qaytish</button>
                    <a href="{% url 'tests_app:test_finish' uuid=attempt.uuid %}" class="btn btn-success px-4 fw-bold">Ha, Yakunlash</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-4 text-center">
                <i class="bi bi-pause-circle-fill text-warning display-4 mb-3"></i>
                <h4 class="fw-bold">Chiqishni xohlaysizmi?</h4>
                <p class="text-muted">Test jarayoni saqlanadi va keyinroq davom ettirishingiz mumkin.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Yo'q</button>
                    <a href="{% url 'core:dashboard' %}" class="btn btn-warning px-4">Ha, Chiqish</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 1. Timer Logic
    let totalSeconds = {{ remaining_time }};
    const timerEls = [document.getElementById('desktopTimer'), document.getElementById('mobileTimer')];

    setInterval(() => {
        if(totalSeconds <= 0) {
            window.location.href = "{% url 'tests_app:test_finish' uuid=attempt.uuid %}";
            return;
        }
        totalSeconds--;
        const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const s = (totalSeconds % 60).toString().padStart(2, '0');

        timerEls.forEach(el => {
            if(el) {
                el.textContent = `${m}:${s}`;
                if(totalSeconds < 300) el.classList.add('danger'); // Last 5 mins warning
            }
        });
    }, 1000);

    // 2. UI Actions
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    function selectOption(card) {
        document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        card.querySelector('input').checked = true;
    }

    // ==========================================
    // AI LOGIC ‚Äî Gemini + Pre-fetch
    // ==========================================
    var _aiUrl     = '{% url "ai_core:api_quick_answer" %}';
    var _aiSubject = '{{ attempt.test.subject.name|escapejs }}';
    var _aiQText   = '{{ question.text|escapejs }}';
    var _aiAnswers = [{% for a in answers %}'{% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% else %}E{% endif %}) {{ a.text|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    var _aiCache   = null;   // prefetch natijasi
    var _aiFlight  = false;  // so'rov ketayotganmi
    var _aiLoading = false;  // chat uchun

    function _getCsrf() {
        var v = '; ' + document.cookie;
        var p = v.split('; csrftoken=');
        return p.length === 2 ? p.pop().split(';').shift() : '';
    }

    function _buildPrompt() {
        var p = _aiQText;
        if (_aiAnswers.length) p += '\n\nJavob variantlari:\n' + _aiAnswers.join('\n');
        p += '\n\nBu savolni qisqacha tushuntir va yechish yo\'lini ko\'rsat. To\'g\'ri javobni to\'g\'ridan-to\'g\'ri aytma ‚Äî o\'quvchi o\'zi tushunsin.';
        return p;
    }

    // Sahifa yuklanishi bilan background da tayyorlab qo'yish
    (function prefetch() {
        if (_aiFlight || _aiCache) return;
        _aiFlight = true;
        fetch(_aiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': _getCsrf()},
            body: JSON.stringify({question: _buildPrompt(), subject: _aiSubject})
        })
        .then(function(r) { return r.json(); })
        .then(function(d) { if (d.answer) _aiCache = d.answer; })
        .catch(function() {})
        .finally(function() { _aiFlight = false; });
    })();

    function _addBotMsg(text) {
        var body = document.getElementById('aiChatBody');
        var el = document.createElement('div');
        el.className = 'ai-bot-msg';
        el.innerHTML = '<div class="ai-bot-avatar"><i class="bi bi-stars"></i></div>' +
            '<div class="ai-bot-bubble">' + text.replace(/\n/g, '<br>') + '</div>';
        body.appendChild(el);
        body.scrollTop = body.scrollHeight;
    }

    function _addUserMsg(text) {
        var body = document.getElementById('aiChatBody');
        var el = document.createElement('div');
        el.className = 'ai-user-msg';
        el.innerHTML = '<div class="ai-user-bubble">' +
            text.replace(/[<>]/g, function(c){ return c==='<'?'&lt;':'&gt;'; }) + '</div>';
        body.appendChild(el);
        body.scrollTop = body.scrollHeight;
    }

    function _showDots() {
        var body = document.getElementById('aiChatBody');
        var el = document.createElement('div');
        el.className = 'ai-loading'; el.id = 'aiDotsEl';
        el.innerHTML = '<div class="ai-loading-avatar"><i class="bi bi-stars"></i></div>' +
            '<div class="ai-dots"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>';
        body.appendChild(el);
        body.scrollTop = body.scrollHeight;
    }

    function _removeDots() {
        var el = document.getElementById('aiDotsEl');
        if (el) el.remove();
    }

    function _fetchChat(prompt) {
        if (_aiLoading) return;
        _aiLoading = true;
        document.getElementById('aiCSendBtn').disabled = true;
        _showDots();
        fetch(_aiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': _getCsrf()},
            body: JSON.stringify({question: prompt, subject: _aiSubject})
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            _removeDots();
            _addBotMsg(d.answer || 'Kechirasiz, xatolik yuz berdi.');
        })
        .catch(function() {
            _removeDots();
            _addBotMsg('Tarmoq xatosi. Qayta urinib ko\'ring.');
        })
        .finally(function() {
            _aiLoading = false;
            document.getElementById('aiCSendBtn').disabled = false;
        });
    }

    // Foydalanuvchi "Roziman" ni bosdi
    function confirmAI() {
        document.getElementById('aiWarning').classList.add('d-none');
        document.getElementById('aiChat').classList.remove('d-none');
        document.getElementById('used_ai').value = 'true';

        if (_aiCache) {
            // Tayyor ‚Äî darhol ko'rsat
            _addBotMsg(_aiCache);
        } else if (_aiFlight) {
            // So'rov ketayotgan ‚Äî polling
            _showDots();
            (function wait() {
                if (_aiCache) {
                    _removeDots();
                    _addBotMsg(_aiCache);
                } else if (_aiFlight) {
                    setTimeout(wait, 400);
                } else {
                    _removeDots();
                    _fetchChat(_buildPrompt());
                }
            })();
        } else {
            // Prefetch xato berdi ‚Äî to'g'ridan-to'g'ri so'ra
            _fetchChat(_buildPrompt());
        }
    }

    // Modal yopilganda warning ni qaytarish (keyingi ochilish uchun)
    document.getElementById('aiModal').addEventListener('hidden.bs.modal', function() {
        if (!document.getElementById('used_ai').value === 'true') {
            document.getElementById('aiWarning').classList.remove('d-none');
            document.getElementById('aiChat').classList.add('d-none');
        }
    });

    // Follow-up savollar
    function sendAIFollow() {
        var inp = document.getElementById('aiChatInput');
        var text = inp.value.trim();
        if (!text || _aiLoading) return;
        inp.value = '';
        _addUserMsg(text);
        _fetchChat(text);
    }
</script>
{% endblock %}