{% extends 'base.html' %}
{% load static %}

{% block title %}Testlar boshqaruvi | TestMakon{% endblock %}
{% block meta_description %}Staff panel — testlar ro'yxati va boshqaruvi{% endblock %}

{% block extra_css %}
<style>
.mg-page { max-width:1200px; margin:0 auto; padding:2rem 1rem; }
.mg-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem; }
.mg-title { font-size:1.4rem; font-weight:900; color:var(--dark); margin:0; }
.mg-card { background:#fff; border:1px solid var(--gray-200); border-radius:16px; overflow:hidden; }
.mg-filters { display:flex; gap:0.75rem; flex-wrap:wrap; margin-bottom:1.25rem; }
.mg-input { padding:0.5rem 0.9rem; border:1px solid var(--gray-200); border-radius:8px; font-size:0.85rem; outline:none; color:var(--dark); background:#fff; }
.mg-input:focus { border-color:var(--primary); }
.mg-table { width:100%; border-collapse:collapse; }
.mg-table th { padding:0.65rem 1rem; font-size:0.72rem; font-weight:700; color:var(--gray-500); text-transform:uppercase; background:var(--gray-50); border-bottom:1px solid var(--gray-100); text-align:left; white-space:nowrap; }
.mg-table td { padding:0.75rem 1rem; border-bottom:1px solid var(--gray-100); font-size:0.85rem; color:var(--dark-600); vertical-align:middle; }
.mg-table tr:last-child td { border-bottom:none; }
.mg-table tr:hover td { background:var(--gray-50); }
.mg-badge { display:inline-block; padding:0.2rem 0.55rem; border-radius:6px; font-size:0.72rem; font-weight:700; }
.mg-badge.active { background:rgba(139,197,64,0.12); color:#16A34A; }
.mg-badge.inactive { background:rgba(239,68,68,0.1); color:#DC2626; }
.mg-badge.premium { background:rgba(251,191,36,0.12); color:#D97706; }
.mg-badge.type { background:rgba(99,102,241,0.1); color:#4F46E5; }
.mg-actions { display:flex; gap:0.4rem; }
.mg-btn { display:inline-flex; align-items:center; gap:0.3rem; padding:0.3rem 0.65rem; border-radius:7px; font-size:0.78rem; font-weight:700; text-decoration:none; border:none; cursor:pointer; transition:opacity 0.15s; }
.mg-btn:hover { opacity:0.8; }
.mg-btn.primary { background:var(--gradient-primary); color:#fff; }
.mg-btn.outline { background:#fff; border:1px solid var(--gray-200); color:var(--dark-600); }
.mg-btn.danger { background:rgba(239,68,68,0.1); color:#DC2626; }
.mg-btn.blue { background:rgba(37,99,235,0.1); color:#2563EB; }
.mg-empty { text-align:center; padding:3rem 1rem; color:var(--gray-400); }
.mg-pagination { display:flex; gap:0.4rem; justify-content:center; padding:1rem; }
.mg-pagination a, .mg-pagination span { padding:0.35rem 0.7rem; border-radius:7px; font-size:0.82rem; font-weight:700; text-decoration:none; border:1px solid var(--gray-200); color:var(--dark-600); }
.mg-pagination .current { background:var(--gradient-primary); color:#fff; border-color:transparent; }
</style>
{% endblock %}

{% block content %}
<div style="background:var(--gray-50); min-height:100vh;">
<div class="mg-page">

  <div class="mg-header">
    <div>
      <h1 class="mg-title"><i class="bi bi-journal-richtext me-2" style="color:var(--primary);"></i>Testlar boshqaruvi</h1>
      <div style="font-size:0.8rem; color:var(--gray-500); margin-top:0.2rem;">Jami {{ page.paginator.count }} ta test</div>
    </div>
    <div style="display:flex; gap:0.5rem;">
      <a href="{% url 'core:admin_analytics' %}" class="mg-btn outline"><i class="bi bi-bar-chart"></i> Analytics</a>
      <a href="{% url 'tests_app:manage_test_create' %}" class="mg-btn primary"><i class="bi bi-plus-lg"></i> Yangi test</a>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="mg-filters">
    <input type="text" name="q" value="{{ q }}" placeholder="Qidirish..." class="mg-input" style="min-width:220px;">
    <select name="subject" class="mg-input">
      <option value="">Barcha fanlar</option>
      {% for s in subjects %}
      <option value="{{ s.id }}" {% if selected_subject == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>
    <select name="type" class="mg-input">
      <option value="">Barcha turlar</option>
      {% for val, label in test_types %}
      <option value="{{ val }}" {% if selected_type == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="mg-btn primary"><i class="bi bi-search"></i> Filter</button>
    {% if q or selected_subject or selected_type %}
    <a href="{% url 'tests_app:manage_tests_list' %}" class="mg-btn outline">Tozalash</a>
    {% endif %}
  </form>

  <!-- Table -->
  <div class="mg-card">
    <div style="overflow-x:auto;">
      <table class="mg-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Sarlavha</th>
            <th>Fan</th>
            <th>Turi</th>
            <th>Savollar</th>
            <th>Vaqt</th>
            <th>Holat</th>
            <th>Sana</th>
            <th>Amallar</th>
          </tr>
        </thead>
        <tbody>
          {% for test in page %}
          <tr>
            <td style="color:var(--gray-400); font-weight:700;">{{ forloop.counter }}</td>
            <td>
              <div style="font-weight:700; color:var(--dark);">{{ test.title|truncatechars:40 }}</div>
              {% if test.is_premium %}<span class="mg-badge premium"><i class="bi bi-star-fill"></i> Premium</span>{% endif %}
            </td>
            <td style="color:var(--gray-600);">{{ test.subject.name|default:"—" }}</td>
            <td><span class="mg-badge type">{{ test.get_test_type_display }}</span></td>
            <td style="font-weight:700;">{{ test.testquestion_set.count }}</td>
            <td style="color:var(--gray-500);">{{ test.time_limit }} min</td>
            <td>
              {% if test.is_active %}
              <span class="mg-badge active"><i class="bi bi-circle-fill" style="font-size:0.6rem;"></i> Faol</span>
              {% else %}
              <span class="mg-badge inactive">Nofaol</span>
              {% endif %}
            </td>
            <td style="color:var(--gray-400); font-size:0.78rem; white-space:nowrap;">{{ test.created_at|date:"d.m.Y" }}</td>
            <td>
              <div class="mg-actions">
                <a href="{% url 'tests_app:manage_test_questions' slug=test.slug %}" class="mg-btn blue" title="Savollar"><i class="bi bi-list-ul"></i></a>
                <a href="{% url 'tests_app:manage_test_edit' slug=test.slug %}" class="mg-btn outline" title="Tahrirlash"><i class="bi bi-pencil"></i></a>
                <form method="post" action="{% url 'tests_app:manage_test_delete' slug=test.slug %}" onsubmit="return confirm('Rostdan o\'chirmoqchimisiz?')">
                  {% csrf_token %}
                  <button type="submit" class="mg-btn danger" title="O'chirish"><i class="bi bi-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9"><div class="mg-empty"><i class="bi bi-journal-x" style="font-size:2rem; display:block; margin-bottom:0.5rem;"></i>Testlar topilmadi</div></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page.has_other_pages %}
    <div class="mg-pagination">
      {% if page.has_previous %}<a href="?page={{ page.previous_page_number }}&q={{ q }}&subject={{ selected_subject }}&type={{ selected_type }}">&laquo;</a>{% endif %}
      {% for num in page.paginator.page_range %}
        {% if page.number == num %}<span class="current">{{ num }}</span>
        {% elif num > page.number|add:"-3" and num < page.number|add:"3" %}<a href="?page={{ num }}&q={{ q }}&subject={{ selected_subject }}&type={{ selected_type }}">{{ num }}</a>
        {% endif %}
      {% endfor %}
      {% if page.has_next %}<a href="?page={{ page.next_page_number }}&q={{ q }}&subject={{ selected_subject }}&type={{ selected_type }}">&raquo;</a>{% endif %}
    </div>
    {% endif %}
  </div>

</div>
</div>
{% endblock %}
