{% extends 'base.html' %}
{% load static %}

{% block title %}Test | {{ test.title }} | TestMakon{% endblock %}

{% block extra_css %}
<style>
    /* ========== RESET FOR TEST PAGE ========== */
    .page-content {
        padding: 0;
    }

    /* Hide default navbar and footer in test fullscreen mode */
    .test-fullscreen .navbar,
    .test-fullscreen .footer {
        display: none;
    }

    /* ========== TEST LAYOUT ========== */
    .test-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background: var(--gray-50);
    }

    /* ========== TOP BAR ========== */
    .test-topbar {
        background: var(--white);
        border-bottom: 1px solid var(--gray-200);
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-sm);
    }

    .test-topbar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .test-back-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--gray-100);
        border-radius: var(--radius);
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-600);
        transition: all 0.2s;
    }

    .test-back-btn:hover {
        background: var(--gray-200);
        color: var(--dark);
    }

    .test-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
    }

    .test-subject-badge {
        padding: 0.35rem 0.75rem;
        background: var(--primary-glow);
        color: var(--primary-dark);
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .test-topbar-center {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    /* Timer */
    .test-timer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--gray-100);
        border-radius: var(--radius);
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
    }

    .test-timer.warning {
        background: #FEF3C7;
        color: #D97706;
    }

    .test-timer.danger {
        background: #FEE2E2;
        color: #DC2626;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .test-timer i {
        font-size: 1rem;
    }

    /* Progress */
    .test-progress-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .test-progress-text {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-600);
    }

    .test-progress-bar {
        width: 120px;
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        overflow: hidden;
    }

    .test-progress-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .test-topbar-right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .test-topbar-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: var(--gray-100);
        border: none;
        border-radius: var(--radius);
        color: var(--dark-600);
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-topbar-btn:hover {
        background: var(--gray-200);
        color: var(--dark);
    }

    .test-topbar-btn.active {
        background: var(--primary-glow);
        color: var(--primary-dark);
    }

    .test-finish-btn {
        padding: 0.6rem 1.25rem;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-finish-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-primary);
    }

    /* ========== MAIN CONTENT ========== */
    .test-main {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* ========== LEFT SIDEBAR — Question Navigator ========== */
    .test-sidebar {
        width: 280px;
        min-width: 280px;
        background: var(--white);
        border-right: 1px solid var(--gray-200);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
        z-index: 50;
    }

    .test-sidebar.collapsed {
        width: 0;
        min-width: 0;
        overflow: hidden;
        border-right: none;
    }

    .sidebar-header {
        padding: 1.25rem 1.25rem 1rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .sidebar-test-title {
        font-size: 0.92rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.4rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .sidebar-test-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .sidebar-subject-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: rgba(139, 197, 64, 0.1);
        color: var(--primary-dark);
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0.25rem 0.65rem;
        border-radius: 50px;
    }

    .sidebar-subject-badge .dot {
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
    }

    .sidebar-difficulty {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray-500);
    }

    /* Sidebar Timer */
    .sidebar-timer {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .sidebar-timer-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.15rem;
    }

    .sidebar-timer-block {
        background: var(--dark);
        color: var(--white);
        font-size: 1.3rem;
        font-weight: 900;
        padding: 0.45rem 0.6rem;
        border-radius: 10px;
        min-width: 46px;
        text-align: center;
        font-variant-numeric: tabular-nums;
    }

    .sidebar-timer-sep {
        font-size: 1.2rem;
        font-weight: 900;
        color: var(--dark);
        padding: 0 0.1rem;
        animation: timer-blink 1s ease-in-out infinite;
    }

    @keyframes timer-blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .sidebar-timer-label {
        text-align: center;
        font-size: 0.72rem;
        color: var(--gray-500);
        font-weight: 600;
        margin-top: 0.4rem;
    }

    .sidebar-timer.timer-warning .sidebar-timer-block {
        background: #D97706;
    }

    .sidebar-timer.timer-danger .sidebar-timer-block {
        background: #DC2626;
        animation: timer-pulse 1s ease-in-out infinite;
    }

    @keyframes timer-pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.3); }
        50% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
    }

    /* Sidebar Question Grid */
    .sidebar-questions {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
    }

    .sidebar-questions::-webkit-scrollbar { width: 4px; }
    .sidebar-questions::-webkit-scrollbar-track { background: transparent; }
    .sidebar-questions::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 4px;
    }

    .sidebar-questions-label {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
    }

    .sidebar-question-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
    }

    .sidebar-q-btn {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid var(--gray-200);
        border-radius: 10px;
        background: var(--white);
        color: var(--dark-600);
        font-weight: 700;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .sidebar-q-btn:hover {
        border-color: var(--primary);
        background: rgba(139, 197, 64, 0.05);
        transform: scale(1.05);
    }

    .sidebar-q-btn.current {
        background: var(--dark);
        color: var(--white);
        border-color: var(--dark);
        box-shadow: 0 4px 12px -3px rgba(15, 23, 42, 0.35);
    }

    .sidebar-q-btn.answered {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
    }

    .sidebar-q-btn.bookmarked {
        background: #FEF3C7;
        color: #92400E;
        border-color: #FBBF24;
    }

    .sidebar-q-btn.bookmarked::after {
        content: '';
        position: absolute;
        top: 3px;
        right: 3px;
        width: 6px;
        height: 6px;
        background: #FBBF24;
        border-radius: 50%;
    }

    /* answered + bookmarked both */
    .sidebar-q-btn.answered.bookmarked {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
    }

    .sidebar-q-btn.answered.bookmarked::after {
        background: #FBBF24;
    }

    .sidebar-q-btn.unanswered {
        background: var(--gray-100);
        border-color: var(--gray-200);
    }

    /* Legend */
    .sidebar-legend {
        padding: 0.85rem 1.25rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
    }

    .sidebar-legend-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--gray-500);
    }

    .sidebar-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    .sidebar-legend-dot.current { background: var(--dark); }
    .sidebar-legend-dot.answered { background: var(--primary); }
    .sidebar-legend-dot.bookmarked { background: #FBBF24; }
    .sidebar-legend-dot.unanswered {
        background: var(--white);
        border: 2px solid var(--gray-300);
    }

    /* Sidebar Footer */
    .sidebar-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--gray-200);
    }

    .sidebar-finish-btn {
        width: 100%;
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
        font-weight: 800;
        font-size: 0.88rem;
        padding: 0.7rem;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: 0 6px 20px -6px rgba(239, 68, 68, 0.4);
    }

    .sidebar-finish-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -6px rgba(239, 68, 68, 0.5);
    }

    /* ========== TOOLS PANEL (Overlay on left) ========== */
    .test-tools-panel {
        width: 400px;
        background: var(--white);
        border-right: 1px solid var(--gray-200);
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        z-index: 60;
    }

    .test-tools-panel.collapsed {
        width: 0;
        min-width: 0;
        overflow: hidden;
        border-right: none;
    }

    .test-tools-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .test-tools-tabs {
        display: flex;
        gap: 0.5rem;
    }

    .test-tools-tab {
        padding: 0.5rem 1rem;
        background: var(--gray-100);
        border: none;
        border-radius: var(--radius);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-600);
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-tools-tab.active {
        background: var(--dark);
        color: var(--white);
    }

    .test-tools-tab:hover:not(.active) {
        background: var(--gray-200);
    }

    .test-tools-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gray-100);
        border: none;
        border-radius: var(--radius);
        color: var(--dark-600);
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-tools-close:hover {
        background: var(--gray-200);
    }

    .test-tools-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    /* Calculator Embed */
    .test-calculator {
        width: 100%;
        height: 400px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        overflow: hidden;
    }

    .test-calculator iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Formula Sheet */
    .test-formula-sheet {
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
    }

    .test-formula-group {
        margin-bottom: 1.5rem;
    }

    .test-formula-group h4 {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .test-formula-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        font-size: 0.9rem;
    }

    .test-formula-item code {
        background: var(--white);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        color: var(--primary-dark);
    }

    /* Periodic Table */
    .test-periodic-table {
        width: 100%;
        height: 500px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        overflow: hidden;
    }

    .test-periodic-table iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Map */
    .test-map-view {
        width: 100%;
        height: 450px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        overflow: hidden;
    }

    .test-map-view iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Formula Accordion */
    .formula-accordion-btn {
        width: 100%;
        text-align: left;
        padding: 0.6rem 0.75rem;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--dark);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        transition: all 0.2s;
    }

    .formula-accordion-btn:hover {
        background: var(--gray-100);
    }

    .formula-accordion-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .formula-accordion-body {
        display: none;
        padding: 0.5rem 0;
    }

    .formula-accordion-body.show {
        display: block;
    }

    /* Constants Table */
    .constants-table {
        width: 100%;
        font-size: 0.85rem;
        border-collapse: collapse;
    }

    .constants-table th {
        background: var(--gray-100);
        padding: 0.5rem 0.75rem;
        text-align: left;
        font-weight: 700;
        font-size: 0.8rem;
        color: var(--dark-600);
        border-bottom: 2px solid var(--gray-200);
    }

    .constants-table td {
        padding: 0.4rem 0.75rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .constants-table tr:hover td {
        background: var(--gray-50);
    }

    /* Timeline */
    .test-timeline {
        position: relative;
        padding-left: 24px;
    }

    .test-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--gray-200);
    }

    .timeline-section {
        margin-bottom: 1.25rem;
    }

    .timeline-section-title {
        font-size: 0.85rem;
        font-weight: 800;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
        position: relative;
    }

    .timeline-section-title::before {
        content: '';
        position: absolute;
        left: -20px;
        top: 6px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid white;
    }

    .timeline-event {
        font-size: 0.8rem;
        color: var(--dark-600);
        padding: 0.2rem 0;
        position: relative;
    }

    .timeline-event::before {
        content: '';
        position: absolute;
        left: -18px;
        top: 8px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--gray-300);
    }

    .timeline-year {
        font-weight: 700;
        color: var(--dark);
        margin-right: 0.25rem;
    }

    /* Atlas */
    .atlas-section {
        margin-bottom: 1rem;
    }

    .atlas-section-btn {
        width: 100%;
        text-align: left;
        padding: 0.6rem 0.75rem;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--dark);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
        transition: all 0.2s;
    }

    .atlas-section-btn:hover {
        background: var(--gray-100);
    }

    .atlas-section-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .atlas-body {
        display: none;
        padding: 0.5rem 0;
    }

    .atlas-body.show {
        display: block;
    }

    .atlas-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.4rem 0;
        font-size: 0.82rem;
        color: var(--dark-600);
    }

    .atlas-item i {
        color: var(--primary);
        margin-top: 2px;
    }

    /* Dictionary */
    .dict-search-box {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .dict-search-box input {
        flex: 1;
        padding: 0.6rem 0.75rem;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .dict-search-box input:focus {
        border-color: var(--primary);
    }

    .dict-search-box button {
        padding: 0.6rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .dict-search-box button:hover {
        background: var(--primary-dark);
    }

    .dict-result {
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
    }

    .dict-word {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--dark);
    }

    .dict-phonetic {
        font-size: 0.85rem;
        color: var(--dark-600);
        margin-bottom: 0.75rem;
    }

    .dict-meaning {
        margin-bottom: 0.75rem;
    }

    .dict-pos {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--primary-dark);
        font-style: italic;
        margin-bottom: 0.25rem;
    }

    .dict-def {
        font-size: 0.85rem;
        color: var(--dark-600);
        padding: 0.2rem 0 0.2rem 0.75rem;
        border-left: 2px solid var(--gray-200);
        margin-bottom: 0.35rem;
    }

    .dict-example {
        font-size: 0.82rem;
        color: var(--gray-500);
        font-style: italic;
        padding-left: 0.75rem;
    }

    .dict-loading {
        text-align: center;
        padding: 2rem;
        color: var(--dark-600);
    }

    .dict-error {
        text-align: center;
        padding: 1.5rem;
        color: #dc3545;
        font-size: 0.9rem;
    }

    /* ========== QUESTION PANEL (Center) ========== */
    .test-question-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
    }

    .test-question-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem 2.5rem;
    }

    .test-question-content::-webkit-scrollbar { width: 6px; }
    .test-question-content::-webkit-scrollbar-track { background: transparent; }
    .test-question-content::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 6px;
    }

    .test-question-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .test-question-number {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .test-question-badge {
        width: 44px;
        height: 44px;
        background: var(--gradient-primary);
        color: var(--white);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        font-weight: 800;
        box-shadow: 0 6px 16px -4px rgba(139, 197, 64, 0.4);
    }

    .test-question-meta {
        display: flex;
        flex-direction: column;
    }

    .test-question-meta-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 600;
    }

    .test-question-label {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--dark);
    }

    .test-question-label .diff-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .diff-dot.easy { background: #22C55E; }
    .diff-dot.medium { background: #F59E0B; }
    .diff-dot.hard { background: #EF4444; }
    .diff-dot.expert { background: #8B5CF6; }

    .test-question-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .test-bookmark-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-600);
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-bookmark-btn:hover {
        background: var(--gray-200);
    }

    .test-bookmark-btn.active {
        background: var(--primary-glow);
        border-color: var(--primary);
        color: var(--primary-dark);
    }

    .test-bookmark-btn.active i {
        color: var(--primary);
    }

    .test-report-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--gray-500);
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-report-btn:hover {
        background: var(--gray-100);
        color: var(--dark-600);
    }

    /* Question Text */
    .test-question-text {
        font-size: 1.1rem;
        line-height: 1.8;
        color: var(--dark);
        margin-bottom: 2rem;
    }

    .test-question-text p {
        color: var(--dark);
    }

    .test-question-image {
        max-width: 100%;
        margin: 1.5rem 0;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }

    /* Answer Options */
    .test-answers {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .test-answer-option {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.1rem 1.25rem;
        background: var(--white);
        border: 2px solid var(--gray-200);
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .test-answer-option:hover {
        border-color: var(--primary-light);
        background: rgba(139, 197, 64, 0.03);
        transform: translateX(4px);
    }

    .test-answer-option.selected {
        border-color: var(--primary);
        background: rgba(139, 197, 64, 0.06);
        box-shadow: 0 4px 16px -4px rgba(139, 197, 64, 0.25);
    }

    .test-answer-option.correct {
        border-color: #10B981;
        background: #D1FAE5;
    }

    .test-answer-option.incorrect {
        border-color: #EF4444;
        background: #FEE2E2;
    }

    .test-answer-letter {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gray-100);
        border: 2px solid var(--gray-300);
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 800;
        color: var(--dark-600);
        flex-shrink: 0;
        transition: all 0.25s;
    }

    .test-answer-option.selected .test-answer-letter {
        background: var(--gradient-primary);
        border-color: var(--primary);
        color: var(--white);
        box-shadow: 0 4px 12px -3px rgba(139, 197, 64, 0.4);
    }

    .test-answer-option.correct .test-answer-letter {
        background: #10B981;
        border-color: #10B981;
        color: var(--white);
    }

    .test-answer-option.incorrect .test-answer-letter {
        background: #EF4444;
        border-color: #EF4444;
        color: var(--white);
    }

    .test-answer-text {
        flex: 1;
        font-size: 1rem;
        color: var(--dark);
        line-height: 1.5;
    }

    .test-answer-indicator {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1rem;
    }

    .test-answer-indicator.correct {
        background: #D1FAE5;
        color: #10B981;
    }

    .test-answer-indicator.incorrect {
        background: #FEE2E2;
        color: #EF4444;
    }

    /* Keyboard hint on answer hover */
    .test-answer-shortcut {
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--gray-400);
        opacity: 0;
        transition: opacity 0.2s;
    }

    .test-answer-option:hover .test-answer-shortcut { opacity: 1; }
    .test-answer-option.selected .test-answer-shortcut { opacity: 0; }

    /* ========== BOTTOM BAR ========== */
    .test-bottombar {
        background: var(--white);
        border-top: 1px solid var(--gray-200);
        padding: 0.85rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .test-bottom-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .test-bottom-info {
        font-size: 0.88rem;
        font-weight: 600;
        color: var(--gray-500);
    }

    .test-bottom-info strong {
        color: var(--dark);
    }

    .test-bottom-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .test-action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.5rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .test-action-btn.secondary {
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        color: var(--dark-600);
    }

    .test-action-btn.secondary:hover {
        background: var(--gray-200);
    }

    .test-action-btn.secondary:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .test-action-btn.primary {
        background: var(--dark);
        color: var(--white);
    }

    .test-action-btn.primary:hover {
        background: var(--dark-800);
        transform: translateX(3px);
    }

    .test-action-btn.ai {
        background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
        color: var(--white);
    }

    .test-action-btn.ai:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 40px -10px rgba(139, 92, 246, 0.4);
    }

    /* ========== MOBILE SIDEBAR TOGGLE ========== */
    .sidebar-mobile-toggle {
        display: none;
        position: fixed;
        bottom: 1.25rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 140;
        background: var(--dark);
        color: var(--white);
        border: none;
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        font-size: 0.88rem;
        cursor: pointer;
        box-shadow: 0 10px 30px -8px rgba(15, 23, 42, 0.5);
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .sidebar-mobile-toggle:hover {
        transform: translateX(-50%) translateY(-2px);
    }

    .sidebar-mobile-toggle .mob-count {
        background: var(--primary);
        color: white;
        font-size: 0.75rem;
        font-weight: 800;
        padding: 0.15rem 0.5rem;
        border-radius: 50px;
    }

    .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.5);
        z-index: 140;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .sidebar-overlay.show { display: block; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
        .test-tools-panel { width: 350px; }
    }

    @media (max-width: 991px) {
        .test-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 150;
            transform: translateX(-100%);
            box-shadow: 20px 0 50px -10px rgba(0, 0, 0, 0.2);
        }

        .test-sidebar.mobile-show {
            transform: translateX(0);
        }

        .test-sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-mobile-toggle { display: flex; }

        .test-tools-panel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 160;
            box-shadow: var(--shadow-lg);
        }

        .test-tools-panel.collapsed {
            transform: translateX(-100%);
        }

        .test-topbar-center { gap: 1rem; }
        .test-progress-bar { display: none; }
        .test-question-content { padding: 1.5rem; }
        .test-bottombar { padding: 0.75rem 1rem; }
    }

    @media (max-width: 768px) {
        .test-topbar { padding: 0.5rem 1rem; }
        .test-title { display: none; }
        .test-subject-badge { display: none; }
        .test-question-content { padding: 1.25rem; }

        .test-question-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .test-question-actions { width: 100%; }
        .test-bookmark-btn, .test-report-btn { flex: 1; justify-content: center; }

        .test-bottombar {
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .test-bottom-left { width: 100%; }
        .test-bottom-actions { width: 100%; justify-content: space-between; }

        .test-sidebar { width: 260px; min-width: 260px; }

        .test-answer-option { padding: 0.9rem 1rem; }
        .test-answer-letter { width: 36px; height: 36px; font-size: 0.82rem; }
    }

    @media (max-width: 575px) {
        .test-topbar-right .test-topbar-btn:not(#toggleFullscreen) { display: none; }
        .test-action-btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
        .test-action-btn.ai span { display: none; }
    }

    /* ========== ANTI-CHEAT STYLES ========== */
    .test-question-text,
    .test-answer-text {
        user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }

    /* ========== FINISH MODAL ========== */
    .test-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
    }

    .test-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .test-modal {
        background: var(--white);
        border-radius: 24px;
        padding: 2.5rem;
        max-width: 420px;
        width: 90%;
        text-align: center;
        transform: scale(0.9) translateY(10px);
        transition: all 0.3s;
        box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.25);
    }

    .test-modal-overlay.show .test-modal {
        transform: scale(1) translateY(0);
    }

    .test-modal-icon {
        width: 72px;
        height: 72px;
        margin: 0 auto 1.25rem;
        background: #FEF3C7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
    }

    .test-modal h3 {
        font-size: 1.35rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
    }

    .test-modal p {
        font-size: 0.92rem;
        margin-bottom: 1.75rem;
    }

    .test-modal-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1.75rem;
        padding: 1.25rem;
        background: var(--gray-50);
        border-radius: 16px;
    }

    .test-modal-stat { text-align: center; }

    .test-modal-stat-value {
        font-size: 1.5rem;
        font-weight: 900;
        color: var(--dark);
    }

    .test-modal-stat-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 600;
    }

    .test-modal-actions {
        display: flex;
        gap: 0.75rem;
    }

    .test-modal-actions button,
    .test-modal-actions a {
        flex: 1;
        padding: 0.75rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        text-decoration: none;
    }

    .test-modal-btn-cancel {
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        color: var(--dark-600);
    }

    .test-modal-btn-cancel:hover { background: var(--gray-200); }

    .test-modal-btn-confirm {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        border: none;
        color: white;
        box-shadow: 0 6px 20px -6px rgba(239, 68, 68, 0.4);
    }

    .test-modal-btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -6px rgba(239, 68, 68, 0.5);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container" id="testContainer">
    <!-- ========== TOP BAR ========== -->
    <div class="test-topbar">
        <div class="test-topbar-left">
            <a href="{% url 'tests_app:question_bank' %}" class="test-back-btn" onclick="return confirmExit()">
                <i class="bi bi-chevron-left"></i>
                Chiqish
            </a>
            <h1 class="test-title">{{ test.title }}</h1>
            {% if test.subject %}
            <span class="test-subject-badge">{{ test.subject.icon }} {{ test.subject.name }}</span>
            {% endif %}
        </div>

        <div class="test-topbar-center">
            {% if remaining_time %}
            <div class="test-timer" id="testTimer">
                <i class="bi bi-clock"></i>
                <span id="timerDisplayTop">{{ remaining_time|floatformat:0 }}</span>
            </div>
            {% endif %}

            <div class="test-progress-info">
                <span class="test-progress-text">
                    <span id="answeredCount">0</span> / {{ questions_data|length }}
                </span>
                <div class="test-progress-bar">
                    <div class="test-progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="test-topbar-right">
            {% if subject_tools %}
            <button class="test-topbar-btn" id="toggleTools" title="Asboblar">
                <i class="bi bi-calculator"></i>
            </button>
            {% endif %}
            <button class="test-topbar-btn" id="toggleSidebarBtn" title="Savollar paneli">
                <i class="bi bi-layout-sidebar"></i>
            </button>
            <button class="test-topbar-btn" id="toggleFullscreen" title="To'liq ekran">
                <i class="bi bi-fullscreen"></i>
            </button>
            <button class="test-finish-btn" onclick="showFinishModal()">
                Yakunlash
            </button>
        </div>
    </div>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="test-main">

        <!-- LEFT SIDEBAR — Question Navigator -->
        <aside class="test-sidebar" id="testSidebar">
            <div class="sidebar-header">
                <div class="sidebar-test-title">{{ test.title }}</div>
                <div class="sidebar-test-meta">
                    {% if test.subject %}
                    <span class="sidebar-subject-badge">
                        <span class="dot"></span>
                        {{ test.subject.name }}
                    </span>
                    {% endif %}
                    <span class="sidebar-difficulty">
                        <i class="bi bi-speedometer2"></i>
                        {{ test.get_difficulty_display|default:"Aralash" }}
                    </span>
                </div>
            </div>

            <!-- Timer in sidebar -->
            {% if remaining_time %}
            <div class="sidebar-timer" id="sidebarTimer">
                <div class="sidebar-timer-display">
                    <div class="sidebar-timer-block" id="sidebarTimerH">00</div>
                    <span class="sidebar-timer-sep">:</span>
                    <div class="sidebar-timer-block" id="sidebarTimerM">00</div>
                    <span class="sidebar-timer-sep">:</span>
                    <div class="sidebar-timer-block" id="sidebarTimerS">00</div>
                </div>
                <div class="sidebar-timer-label">Qolgan vaqt</div>
            </div>
            {% endif %}

            <!-- Question Grid -->
            <div class="sidebar-questions">
                <div class="sidebar-questions-label">Savollar ({{ questions_data|length }})</div>
                <div class="sidebar-question-grid" id="sidebarGrid">
                    {% for item in questions_data %}
                    <button class="sidebar-q-btn {% if forloop.counter0 == current_index %}current{% endif %} {% if item.user_answer %}answered{% endif %} {% if item.is_bookmarked %}bookmarked{% endif %}"
                            data-index="{{ forloop.counter0 }}"
                            data-question-id="{{ item.question.id }}"
                            onclick="goToQuestion({{ forloop.counter0 }})">
                        {{ forloop.counter }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Legend -->
            <div class="sidebar-legend">
                <div class="sidebar-legend-item">
                    <span class="sidebar-legend-dot current"></span> Joriy
                </div>
                <div class="sidebar-legend-item">
                    <span class="sidebar-legend-dot answered"></span> Javob berilgan
                </div>
                <div class="sidebar-legend-item">
                    <span class="sidebar-legend-dot bookmarked"></span> Belgilangan
                </div>
                <div class="sidebar-legend-item">
                    <span class="sidebar-legend-dot unanswered"></span> Javobsiz
                </div>
            </div>

            <!-- Sidebar Finish -->
            <div class="sidebar-footer">
                <button class="sidebar-finish-btn" onclick="showFinishModal()">
                    <i class="bi bi-check-circle-fill"></i>
                    Yakunlash
                </button>
            </div>
        </aside>

        <!-- TOOLS PANEL -->
        {% if subject_tools %}
        <div class="test-tools-panel collapsed" id="toolsPanel">
            <div class="test-tools-header">
                <div class="test-tools-tabs">
                    {% for tool in subject_tools %}
                    <button class="test-tools-tab {% if forloop.first %}active{% endif %}"
                            data-tool="{{ tool.id }}">
                        <i class="bi {{ tool.icon }}"></i>
                        {{ tool.name }}
                    </button>
                    {% endfor %}
                </div>
                <button class="test-tools-close" onclick="toggleToolsPanel()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="test-tools-content">
                {% for tool in subject_tools %}
                <div class="test-tool-view {% if not forloop.first %}d-none{% endif %}" id="tool-{{ tool.id }}">

                    {% if tool.type == 'desmos' or tool.type == 'scientific' %}
                    <!-- Kalkulyator (Desmos) -->
                    <div class="test-calculator">
                        <iframe src="https://www.desmos.com/scientific" title="Calculator"></iframe>
                    </div>

                    {% elif tool.type == 'periodic' %}
                    <!-- Interaktiv Mendeleyev jadvali -->
                    <div class="test-periodic-table">
                        <iframe src="https://ptable.com/?lang=uz#Properties" title="Mendeleyev jadvali"></iframe>
                    </div>

                    {% elif tool.type == 'sheet' and tool.subject_slug == 'matematika' %}
                    <!-- Matematika formulalari -->
                    <div class="test-formula-sheet">
                        <button class="formula-accordion-btn active" onclick="toggleFormulaSection(this)">
                            Algebra <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body show">
                            <div class="test-formula-item"><code>x = (-b ± √D) / 2a</code><span>Kvadrat tenglama</span></div>
                            <div class="test-formula-item"><code>D = b² - 4ac</code><span>Diskriminant</span></div>
                            <div class="test-formula-item"><code>x₁ + x₂ = -b/a</code><span>Viet teoremasi (yig'indi)</span></div>
                            <div class="test-formula-item"><code>x₁ · x₂ = c/a</code><span>Viet teoremasi (ko'paytma)</span></div>
                            <div class="test-formula-item"><code>logₐ(xy) = logₐx + logₐy</code><span>Logarifm ko'paytma</span></div>
                            <div class="test-formula-item"><code>logₐ(x/y) = logₐx - logₐy</code><span>Logarifm bo'linma</span></div>
                            <div class="test-formula-item"><code>logₐxⁿ = n·logₐx</code><span>Logarifm daraja</span></div>
                            <div class="test-formula-item"><code>(a+b)² = a²+2ab+b²</code><span>To'liq kvadrat</span></div>
                            <div class="test-formula-item"><code>a²-b² = (a-b)(a+b)</code><span>Kvadratlar ayirmasi</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Geometriya <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>a² + b² = c²</code><span>Pifagor teoremasi</span></div>
                            <div class="test-formula-item"><code>S = a·b</code><span>To'rtburchak yuzi</span></div>
                            <div class="test-formula-item"><code>S = ½·a·h</code><span>Uchburchak yuzi</span></div>
                            <div class="test-formula-item"><code>S = ½·d₁·d₂</code><span>Romb yuzi</span></div>
                            <div class="test-formula-item"><code>S = πr²</code><span>Doira yuzi</span></div>
                            <div class="test-formula-item"><code>C = 2πr</code><span>Aylana uzunligi</span></div>
                            <div class="test-formula-item"><code>V = a·b·c</code><span>Parallelipiped hajmi</span></div>
                            <div class="test-formula-item"><code>V = πr²h</code><span>Silindr hajmi</span></div>
                            <div class="test-formula-item"><code>V = ⅓πr²h</code><span>Konus hajmi</span></div>
                            <div class="test-formula-item"><code>V = ⁴⁄₃πr³</code><span>Shar hajmi</span></div>
                            <div class="test-formula-item"><code>S = 4πr²</code><span>Shar sirti</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Trigonometriya <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>sin²α + cos²α = 1</code><span>Asosiy ayniyat</span></div>
                            <div class="test-formula-item"><code>tgα = sinα / cosα</code><span>Tangens</span></div>
                            <div class="test-formula-item"><code>ctgα = cosα / sinα</code><span>Kotangens</span></div>
                            <div class="test-formula-item"><code>1 + tg²α = 1/cos²α</code><span>Tangens ayniyati</span></div>
                            <div class="test-formula-item"><code>1 + ctg²α = 1/sin²α</code><span>Kotangens ayniyati</span></div>
                            <div class="test-formula-item"><code>sin(α±β) = sinα·cosβ ± cosα·sinβ</code><span>Qo'shish formulasi</span></div>
                            <div class="test-formula-item"><code>cos(α±β) = cosα·cosβ ∓ sinα·sinβ</code><span>Qo'shish formulasi</span></div>
                            <div class="test-formula-item"><code>sin2α = 2sinα·cosα</code><span>Ikkilangan burchak</span></div>
                            <div class="test-formula-item"><code>cos2α = cos²α - sin²α</code><span>Ikkilangan burchak</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Progressiya <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>aₙ = a₁ + (n-1)d</code><span>Arifmetik progressiya n-hadi</span></div>
                            <div class="test-formula-item"><code>Sₙ = n(a₁+aₙ)/2</code><span>Arifmetik progressiya yig'indisi</span></div>
                            <div class="test-formula-item"><code>bₙ = b₁·qⁿ⁻¹</code><span>Geometrik progressiya n-hadi</span></div>
                            <div class="test-formula-item"><code>Sₙ = b₁(qⁿ-1)/(q-1)</code><span>Geometrik progressiya yig'indisi</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Kombinatorika <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>n! = 1·2·3·...·n</code><span>Faktorial</span></div>
                            <div class="test-formula-item"><code>Pₙ = n!</code><span>Permutatsiya</span></div>
                            <div class="test-formula-item"><code>Aₙₖ = n!/(n-k)!</code><span>O'rniga qo'yish</span></div>
                            <div class="test-formula-item"><code>Cₙₖ = n!/k!(n-k)!</code><span>Kombinatsiya</span></div>
                        </div>
                    </div>

                    {% elif tool.type == 'sheet' and tool.subject_slug == 'fizika' %}
                    <!-- Fizika formulalari -->
                    <div class="test-formula-sheet">
                        <button class="formula-accordion-btn active" onclick="toggleFormulaSection(this)">
                            Mexanika <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body show">
                            <div class="test-formula-item"><code>v = s/t</code><span>Tezlik</span></div>
                            <div class="test-formula-item"><code>a = (v-v₀)/t</code><span>Tezlanish</span></div>
                            <div class="test-formula-item"><code>s = v₀t + at²/2</code><span>Yo'l (tekis tezl.)</span></div>
                            <div class="test-formula-item"><code>v² = v₀² + 2as</code><span>Tezlik-yo'l bog'lanishi</span></div>
                            <div class="test-formula-item"><code>F = ma</code><span>Nyuton II qonuni</span></div>
                            <div class="test-formula-item"><code>F = G·m₁m₂/r²</code><span>Gravitatsiya qonuni</span></div>
                            <div class="test-formula-item"><code>P = mg</code><span>Og'irlik kuchi</span></div>
                            <div class="test-formula-item"><code>Fₛ = μN</code><span>Ishqalanish kuchi</span></div>
                            <div class="test-formula-item"><code>A = F·s·cosα</code><span>Ish</span></div>
                            <div class="test-formula-item"><code>N = A/t</code><span>Quvvat</span></div>
                            <div class="test-formula-item"><code>Eₖ = mv²/2</code><span>Kinetik energiya</span></div>
                            <div class="test-formula-item"><code>Eₚ = mgh</code><span>Potensial energiya</span></div>
                            <div class="test-formula-item"><code>p = mv</code><span>Impuls</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Termodinamika <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>Q = cmΔT</code><span>Issiqlik miqdori</span></div>
                            <div class="test-formula-item"><code>Q = λm</code><span>Erish issiqligi</span></div>
                            <div class="test-formula-item"><code>Q = Lm</code><span>Bug'lanish issiqligi</span></div>
                            <div class="test-formula-item"><code>pV = νRT</code><span>Ideal gaz holat tengl.</span></div>
                            <div class="test-formula-item"><code>p₁V₁/T₁ = p₂V₂/T₂</code><span>Birlashgan gaz qonuni</span></div>
                            <div class="test-formula-item"><code>η = A/Q</code><span>FIK</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Elektr <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>I = U/R</code><span>Om qonuni</span></div>
                            <div class="test-formula-item"><code>R = ρl/S</code><span>Qarshilik</span></div>
                            <div class="test-formula-item"><code>P = UI = I²R</code><span>Quvvat</span></div>
                            <div class="test-formula-item"><code>A = UIt</code><span>Elektr ishi</span></div>
                            <div class="test-formula-item"><code>F = k·q₁q₂/r²</code><span>Kulon qonuni</span></div>
                            <div class="test-formula-item"><code>C = q/U</code><span>Sig'im</span></div>
                            <div class="test-formula-item"><code>W = CU²/2</code><span>Kondensator energiyasi</span></div>
                            <div class="test-formula-item"><code>ε = -ΔΦ/Δt</code><span>Elektromagnit induksiya</span></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Optika <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="test-formula-item"><code>n = sin α / sin β</code><span>Sinish qonuni</span></div>
                            <div class="test-formula-item"><code>1/F = 1/d + 1/f</code><span>Linza formulasi</span></div>
                            <div class="test-formula-item"><code>D = 1/F</code><span>Optik kuch (dioptri)</span></div>
                            <div class="test-formula-item"><code>Г = f/d = H/h</code><span>Kattalashtirish</span></div>
                            <div class="test-formula-item"><code>E = hν</code><span>Foton energiyasi</span></div>
                        </div>
                    </div>

                    {% elif tool.type == 'constants' %}
                    <!-- Fizik konstantalar -->
                    <div class="test-formula-sheet">
                        <table class="constants-table">
                            <thead>
                                <tr><th>Konstanta</th><th>Belgi</th><th>Qiymat</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>Erkin tushish tezl.</td><td>g</td><td>9,8 m/s²</td></tr>
                                <tr><td>Yorug'lik tezligi</td><td>c</td><td>3·10⁸ m/s</td></tr>
                                <tr><td>Gravitatsiya doimiysi</td><td>G</td><td>6,67·10⁻¹¹ N·m²/kg²</td></tr>
                                <tr><td>Avogadro soni</td><td>Nₐ</td><td>6,02·10²³ mol⁻¹</td></tr>
                                <tr><td>Bolsman doimiysi</td><td>k</td><td>1,38·10⁻²³ J/K</td></tr>
                                <tr><td>Universal gaz doimiysi</td><td>R</td><td>8,314 J/(mol·K)</td></tr>
                                <tr><td>Plank doimiysi</td><td>h</td><td>6,63·10⁻³⁴ J·s</td></tr>
                                <tr><td>Elektron zaryadi</td><td>e</td><td>1,6·10⁻¹⁹ C</td></tr>
                                <tr><td>Elektron massasi</td><td>mₑ</td><td>9,1·10⁻³¹ kg</td></tr>
                                <tr><td>Proton massasi</td><td>mₚ</td><td>1,67·10⁻²⁷ kg</td></tr>
                                <tr><td>Kulon doimiysi</td><td>k</td><td>9·10⁹ N·m²/C²</td></tr>
                                <tr><td>Magnit doimiysi</td><td>μ₀</td><td>4π·10⁻⁷ H/m</td></tr>
                                <tr><td>Elektr doimiysi</td><td>ε₀</td><td>8,85·10⁻¹² F/m</td></tr>
                                <tr><td>Stefano-Bolsman d.</td><td>σ</td><td>5,67·10⁻⁸ W/(m²·K⁴)</td></tr>
                            </tbody>
                        </table>
                    </div>

                    {% elif tool.type == 'map' %}
                    <!-- Geografiya xaritasi -->
                    <div class="test-map-view">
                        <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=55.9%2C37.1%2C73.1%2C45.6&layer=mapnik"
                                title="Xarita"></iframe>
                    </div>

                    {% elif tool.type == 'atlas' %}
                    <!-- Biologiya atlasi -->
                    <div class="test-formula-sheet">
                        <button class="atlas-section-btn active" onclick="toggleAtlasSection(this)">
                            <i class="bi bi-circle"></i> Hujayra tuzilishi
                        </button>
                        <div class="atlas-body show">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Hujayra membranasi</strong> — hujayraning tashqi qobig'i, moddalar almashinuvini boshqaradi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Sitoplazma</strong> — hujayra ichidagi suyuqlik, organoidlar joylashgan muhit</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Yadro</strong> — genetik ma'lumot (DNK) saqlanadigan markaz</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Mitoxondriya</strong> — energiya ishlab chiqaruvchi organoid (ATF sintezi)</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Ribosoma</strong> — oqsil sintezi amalga oshiriladigan joy</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Endoplazmatik to'r</strong> — moddalar tashish tizimi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Golji apparati</strong> — moddalarni saralash va tashish</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Lizosoma</strong> — hujayra ichki hazm qilish organoid</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Xloroplast</strong> — fotosintez organoid (faqat o'simliklarda)</div></div>
                        </div>

                        <button class="atlas-section-btn" onclick="toggleAtlasSection(this)">
                            <i class="bi bi-heart-pulse"></i> Yurak-qon aylanish tizimi
                        </button>
                        <div class="atlas-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Yurak</strong> — 4 kamerali (2 bo'lmacha, 2 qorincha), minutiga ~70 marta uradi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Katta qon aylanish</strong> — chap qorincha → aorta → organlar → o'ng bo'lmacha</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Kichik qon aylanish</strong> — o'ng qorincha → o'pka arteriyasi → o'pka → chap bo'lmacha</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Arteriya</strong> — yurakdan qon olib ketadi, qalin devorli</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Vena</strong> — yurakka qon qaytaradi, klapanli</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Kapillyar</strong> — eng nozik qon tomirlari, moddalar almashinuvi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Eritrotsit</strong> — qizil qon tanachalari, O₂ tashiydi (gemoglobin)</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Leykotsit</strong> — oq qon tanachalari, immunitet</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Trombotsit</strong> — qon ivishi (tromboz)</div></div>
                        </div>

                        <button class="atlas-section-btn" onclick="toggleAtlasSection(this)">
                            <i class="bi bi-lungs"></i> Nafas olish tizimi
                        </button>
                        <div class="atlas-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Burun bo'shlig'i</strong> — havoni isitish, namlash, tozalash</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Hiqildoq (larinks)</strong> — tovush hosil qilish</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Traxeya</strong> — havo o'tkazuvchi nay</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Bronxlar</strong> — traxeyaning tarmoqlari</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>O'pka (alveolalar)</strong> — gaz almashinuvi: O₂ qonga, CO₂ tashqariga</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Diafragma</strong> — nafas olish mushagi</div></div>
                        </div>

                        <button class="atlas-section-btn" onclick="toggleAtlasSection(this)">
                            <i class="bi bi-cup-straw"></i> Ovqat hazm qilish tizimi
                        </button>
                        <div class="atlas-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Og'iz bo'shlig'i</strong> — mexanik maydalash, amilaza fermenti</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Qizilo'ngach</strong> — ovqatni oshqozonga o'tkazadi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Oshqozon</strong> — pepsin, xlorid kislota (pH 1.5-2)</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Jigar</strong> — o't ishlab chiqaradi, zaharlarni zararsizlantiradi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Oshqozon osti bezi</strong> — insulin, tripsin, lipaza</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Ingichka ichak</strong> — asosiy so'rilish joyi (vorsinalar)</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Yo'g'on ichak</strong> — suv so'rilishi, bakteriyalar</div></div>
                        </div>

                        <button class="atlas-section-btn" onclick="toggleAtlasSection(this)">
                            <i class="bi bi-lightning"></i> Nerv tizimi
                        </button>
                        <div class="atlas-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Bosh miya</strong> — katta yarim sharlar, miyacha, uzunchoq miya</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Orqa miya</strong> — refleks yoylari markazi, 31 juft nerv</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Neyron</strong> — nerv hujayrasi: dendrit → tana → akson</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Sinaps</strong> — neyronlar orasidagi bog'lanish (mediatorlar)</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Somatik nerv tizimi</strong> — ixtiyoriy harakatlar</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Vegetativ nerv tizimi</strong> — simpatik + parasimpatik</div></div>
                        </div>
                    </div>

                    {% elif tool.type == 'timeline' %}
                    <!-- Tarix vaqt chizig'i -->
                    <div class="test-formula-sheet">
                        <div class="test-timeline">
                            <div class="timeline-section">
                                <div class="timeline-section-title">Qadimgi davr</div>
                                <div class="timeline-event"><span class="timeline-year">Mil.av. III-II ming.</span> Xorazm, Baqtriya, So'g'diyona madaniyatlari</div>
                                <div class="timeline-event"><span class="timeline-year">Mil.av. VI asr</span> Ahamoniylar (Eron) bosqini</div>
                                <div class="timeline-event"><span class="timeline-year">Mil.av. 329</span> Iskandar Zulqarnayn yurishi</div>
                                <div class="timeline-event"><span class="timeline-year">Mil.av. III-II asr</span> Yunon-Baqtriya va Qo'shon davlatlari</div>
                            </div>

                            <div class="timeline-section">
                                <div class="timeline-section-title">O'rta asrlar</div>
                                <div class="timeline-event"><span class="timeline-year">VII-VIII asr</span> Arab bosqini, Islom dini tarqalishi</div>
                                <div class="timeline-event"><span class="timeline-year">IX-X asr</span> Somoniylar davlati — ilm-fan gullab-yashnashi</div>
                                <div class="timeline-event"><span class="timeline-year">X-XII asr</span> Qoraxoniylar, G'aznaviylar, Xorazmshohlari</div>
                                <div class="timeline-event"><span class="timeline-year">1220</span> Chingizxon bosqini — Buxoro, Samarqand vayronasi</div>
                            </div>

                            <div class="timeline-section">
                                <div class="timeline-section-title">Temuriylar davri</div>
                                <div class="timeline-event"><span class="timeline-year">1370</span> Amir Temur davlatni barpo etishi</div>
                                <div class="timeline-event"><span class="timeline-year">1370-1405</span> Temur hukmronligi — Movarounnahr yuksalishi</div>
                                <div class="timeline-event"><span class="timeline-year">1409-1449</span> Mirzo Ulug'bek — rasadxona, ilm-fan markazi</div>
                                <div class="timeline-event"><span class="timeline-year">1441-1501</span> Alisher Navoiy — adabiyot va madaniyat</div>
                                <div class="timeline-event"><span class="timeline-year">1500-1601</span> Shayboniylar sulolasi</div>
                            </div>

                            <div class="timeline-section">
                                <div class="timeline-section-title">Xonliklar davri</div>
                                <div class="timeline-event"><span class="timeline-year">XVI-XIX asr</span> Buxoro, Xiva, Qo'qon xonliklari</div>
                            </div>

                            <div class="timeline-section">
                                <div class="timeline-section-title">Rossiya mustamlakasi</div>
                                <div class="timeline-event"><span class="timeline-year">1865</span> Toshkent Rossiya tomonidan bosib olinishi</div>
                                <div class="timeline-event"><span class="timeline-year">1867</span> Turkiston general-gubernatorligi tashkil etilishi</div>
                                <div class="timeline-event"><span class="timeline-year">1873-1876</span> Xiva va Qo'qon xonliklari tugatilishi</div>
                            </div>

                            <div class="timeline-section">
                                <div class="timeline-section-title">Sovet davri</div>
                                <div class="timeline-event"><span class="timeline-year">1917-1920</span> Inqilob va fuqarolar urushi</div>
                                <div class="timeline-event"><span class="timeline-year">1924</span> O'zbekiston SSR tashkil etilishi</div>
                                <div class="timeline-event"><span class="timeline-year">1930-lar</span> Kollektivizatsiya, qatag'onlar</div>
                                <div class="timeline-event"><span class="timeline-year">1941-1945</span> Ikkinchi jahon urushi</div>
                                <div class="timeline-event"><span class="timeline-year">1966</span> Toshkent zilzilasi</div>
                            </div>

                            <div class="timeline-section">
                                <div class="timeline-section-title">Mustaqillik</div>
                                <div class="timeline-event"><span class="timeline-year">1991, 1-sentabr</span> O'zbekiston Mustaqillik e'lon qilishi</div>
                                <div class="timeline-event"><span class="timeline-year">1992</span> Konstitutsiya qabul qilinishi (8-dekabr)</div>
                                <div class="timeline-event"><span class="timeline-year">1994</span> Milliy valyuta — So'm muomalaga kiritilishi</div>
                                <div class="timeline-event"><span class="timeline-year">2016</span> Yangi davr islohotlari boshlanishi</div>
                                <div class="timeline-event"><span class="timeline-year">2023</span> Yangi Konstitutsiya qabul qilinishi</div>
                            </div>
                        </div>
                    </div>

                    {% elif tool.type == 'dictionary' and tool.subject_slug == 'ingliz-tili' %}
                    <!-- Ingliz tili lug'ati (Free Dictionary API) -->
                    <div>
                        <div class="dict-search-box">
                            <input type="text" id="dictSearchInput" placeholder="So'z kiriting..." onkeydown="if(event.key==='Enter')searchDictionary()">
                            <button onclick="searchDictionary()"><i class="bi bi-search"></i> Qidirish</button>
                        </div>
                        <div id="dictResult">
                            <div class="text-center py-3" style="color:var(--dark-600);font-size:0.9rem;">
                                <i class="bi bi-book" style="font-size:2rem;display:block;margin-bottom:0.5rem;color:var(--gray-300);"></i>
                                Inglizcha so'z yozing va <strong>Qidirish</strong> tugmasini bosing
                            </div>
                        </div>
                    </div>

                    {% elif tool.type == 'dictionary' and tool.subject_slug == 'ona-tili' %}
                    <!-- O'zbek tili imlo qoidalari -->
                    <div class="test-formula-sheet">
                        <button class="formula-accordion-btn active" onclick="toggleFormulaSection(this)">
                            Bosh harf qoidalari <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body show">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Gap boshida bosh harf yoziladi</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Atoqli otlar bosh harf bilan: <strong>Toshkent, Navoiy, O'zbekiston</strong></div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Kitob, gazeta nomlari qo'shtirnoq ichida bosh harf bilan</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Hurmat ma'nosidagi <strong>Siz</strong> bosh harf bilan</div></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Qo'shib yozish <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Qo'shma so'zlar: <strong>gulzor, kitobxon, qo'ltiq</strong></div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Takroriy so'zlar chiziqcha bilan: <strong>sekin-sekin, oz-oz</strong></div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Juft so'zlar chiziqcha bilan: <strong>ota-ona, katta-kichik</strong></div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>So'z yasovchi qo'shimchalar qo'shib: <strong>-chi, -kor, -xona</strong></div></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            Tinish belgilari <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Nuqta (.)</strong> — darak gap oxirida</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>So'roq belgisi (?)</strong> — so'roq gap oxirida</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Undov belgisi (!)</strong> — undov gap oxirida</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Vergul (,)</strong> — sanash, undalmalar, qo'shma gaplar</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Nuqtali vergul (;)</strong> — murakkab qo'shma gaplarda</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Ikki nuqta (:)</strong> — umumlashtiruvchi so'z oldidan</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>Tire (—)</strong> — ega va kesim orasida, dialog</div></div>
                        </div>

                        <button class="formula-accordion-btn" onclick="toggleFormulaSection(this)">
                            O' va G' harflari <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="formula-accordion-body">
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>O'</strong> harfi: o'quvchi, o'zbek, ko'z, to'g'ri</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div><strong>G'</strong> harfi: g'alaba, g'ildirak, tog', sog'liq</div></div>
                            <div class="atlas-item"><i class="bi bi-dot"></i><div>Gap boshida: <strong>O'zbekiston, G'arb</strong></div></div>
                        </div>
                    </div>

                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi {{ tool.icon }} fs-1 text-muted"></i>
                        <p class="mt-2 text-muted">{{ tool.name }} tez orada qo'shiladi</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- QUESTION PANEL -->
        <div class="test-question-panel">
            <div class="test-question-content">
                {% for item in questions_data %}
                <div class="test-question-slide {% if forloop.counter0 != current_index %}d-none{% endif %}"
                     data-index="{{ forloop.counter0 }}"
                     data-question-id="{{ item.question.id }}">

                    <!-- Question Header -->
                    <div class="test-question-header">
                        <div class="test-question-number">
                            <div class="test-question-badge">{{ forloop.counter }}</div>
                            <div class="test-question-meta">
                                <span class="test-question-meta-label">{{ forloop.counter }} / {{ questions_data|length }} savol</span>
                                <div class="test-question-label">
                                    <span class="diff-dot {% if item.question.difficulty == 'easy' %}easy{% elif item.question.difficulty == 'medium' %}medium{% elif item.question.difficulty == 'hard' %}hard{% else %}expert{% endif %}"></span>
                                    {% if item.question.difficulty == 'easy' %}Oson
                                    {% elif item.question.difficulty == 'medium' %}O'rta
                                    {% elif item.question.difficulty == 'hard' %}Qiyin
                                    {% else %}Ekspert
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="test-question-actions">
                            <button class="test-bookmark-btn {% if item.is_bookmarked %}active{% endif %}"
                                    onclick="toggleBookmark({{ item.question.id }}, this)">
                                <i class="bi bi-bookmark{% if item.is_bookmarked %}-fill{% endif %}"></i>
                                Belgilash
                            </button>
                            <button class="test-report-btn" onclick="reportQuestion({{ item.question.id }})">
                                <i class="bi bi-flag"></i>
                                Xatolik
                            </button>
                        </div>
                    </div>

                    <!-- Question Text -->
                    <div class="test-question-text">
                        {{ item.question.text|linebreaks }}
                        {% if item.question.image %}
                        <img src="{{ item.question.image.url }}" alt="Savol rasmi" class="test-question-image">
                        {% endif %}
                    </div>

                    <!-- Answer Options -->
                    <div class="test-answers">
                        {% for answer in item.answers %}
                        <div class="test-answer-option {% if item.user_answer and item.user_answer.selected_answer_id == answer.id %}selected{% endif %}"
                             data-answer-id="{{ answer.id }}"
                             onclick="selectAnswer({{ forloop.parentloop.counter0 }}, {{ answer.id }}, this)">
                            <div class="test-answer-letter">
                                {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% else %}{{ forloop.counter }}{% endif %}
                            </div>
                            <div class="test-answer-text">
                                {{ answer.text }}
                                {% if answer.image %}
                                <img src="{{ answer.image.url }}" alt="Javob rasmi" style="max-width: 200px; margin-top: 0.5rem; border-radius: 4px;">
                                {% endif %}
                            </div>
                            <span class="test-answer-shortcut">
                                {% if forloop.counter == 1 %}1{% elif forloop.counter == 2 %}2{% elif forloop.counter == 3 %}3{% elif forloop.counter == 4 %}4{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Bottom Bar -->
            <div class="test-bottombar">
                <div class="test-bottom-left">
                    <span class="test-bottom-info">
                        Savol <strong id="bottomCurrentNum">1</strong> / {{ questions_data|length }}
                        &nbsp;·&nbsp; Klaviatura: <strong>1-4</strong> javob, <strong>←→</strong> navigatsiya, <strong>B</strong> belgilash
                    </span>
                </div>

                <div class="test-bottom-actions">
                    <button class="test-action-btn ai" onclick="askAI()">
                        <i class="bi bi-stars"></i>
                        <span>AI Yordam</span>
                    </button>
                    <button class="test-action-btn secondary" id="prevBtn" onclick="prevQuestion()" disabled>
                        <i class="bi bi-chevron-left"></i>
                        Oldingi
                    </button>
                    <button class="test-action-btn primary" id="nextBtn" onclick="nextQuestion()">
                        Keyingi
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile sidebar toggle -->
<button class="sidebar-mobile-toggle" onclick="toggleMobileSidebar()">
    <i class="bi bi-grid-3x3-gap-fill"></i>
    Savollar
    <span class="mob-count" id="mobileCount">0/{{ questions_data|length }}</span>
</button>

<!-- Mobile overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

<!-- ========== FINISH MODAL ========== -->
<div class="test-modal-overlay" id="finishModal">
    <div class="test-modal">
        <div class="test-modal-icon">⚠️</div>
        <h3>Testni yakunlaysizmi?</h3>
        <p>Yakunlagandan so'ng javoblarni o'zgartira olmaysiz.</p>
        <div class="test-modal-stats">
            <div class="test-modal-stat">
                <div class="test-modal-stat-value" id="modalAnswered">0</div>
                <div class="test-modal-stat-label">Javob berilgan</div>
            </div>
            <div class="test-modal-stat">
                <div class="test-modal-stat-value" id="modalUnanswered">{{ questions_data|length }}</div>
                <div class="test-modal-stat-label">Javobsiz</div>
            </div>
            <div class="test-modal-stat">
                <div class="test-modal-stat-value" id="modalBookmarked">0</div>
                <div class="test-modal-stat-label">Belgilangan</div>
            </div>
        </div>
        <div class="test-modal-actions">
            <button class="test-modal-btn-cancel" onclick="hideFinishModal()">
                Davom etish
            </button>
            <form action="{% url 'tests_app:test_play_finish' uuid=attempt.uuid %}" method="get" style="flex: 1;">
                <button type="submit" class="test-modal-btn-confirm" style="width: 100%;">
                    Yakunlash
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // ==========================================
    // GLOBAL VARIABLES
    // ==========================================
    const attemptUuid = '{{ attempt.uuid }}';
    const csrfToken = '{{ csrf_token }}';
    const totalQuestions = {{ questions_data|length }};
    let currentIndex = {{ current_index }};
    let answeredQuestions = new Set();
    let bookmarkedQuestions = new Set();
    let questionStartTime = Date.now();

    // Initialize answered & bookmarked sets from server data
    {% for item in questions_data %}
        {% if item.user_answer %}
        answeredQuestions.add({{ forloop.counter0 }});
        {% endif %}
        {% if item.is_bookmarked %}
        bookmarkedQuestions.add({{ item.question.id }});
        {% endif %}
    {% endfor %}

    // ==========================================
    // TIMER
    // ==========================================
    {% if remaining_time %}
    let remainingSeconds = {{ remaining_time }};

    function updateTimer() {
        if (remainingSeconds <= 0) {
            // Time's up - auto submit
            window.location.href = "{% url 'tests_app:test_play_finish' uuid=attempt.uuid %}";
            return;
        }

        remainingSeconds--;

        const hours = Math.floor(remainingSeconds / 3600);
        const minutes = Math.floor((remainingSeconds % 3600) / 60);
        const seconds = remainingSeconds % 60;

        // Top bar timer
        const topDisplay = document.getElementById('timerDisplayTop');
        if (topDisplay) {
            if (hours > 0) {
                topDisplay.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                topDisplay.textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // Sidebar timer blocks
        const sH = document.getElementById('sidebarTimerH');
        const sM = document.getElementById('sidebarTimerM');
        const sS = document.getElementById('sidebarTimerS');
        if (sH) sH.textContent = String(hours).padStart(2, '0');
        if (sM) sM.textContent = String(minutes).padStart(2, '0');
        if (sS) sS.textContent = String(seconds).padStart(2, '0');

        // Warning states
        const timerTop = document.getElementById('testTimer');
        const timerSidebar = document.getElementById('sidebarTimer');

        if (remainingSeconds <= 60) {
            if (timerTop) { timerTop.classList.add('danger'); timerTop.classList.remove('warning'); }
            if (timerSidebar) { timerSidebar.classList.add('timer-danger'); timerSidebar.classList.remove('timer-warning'); }
        } else if (remainingSeconds <= 300) {
            if (timerTop) timerTop.classList.add('warning');
            if (timerSidebar) timerSidebar.classList.add('timer-warning');
        }
    }

    // Initial display
    (function initTimer() {
        const h = Math.floor(remainingSeconds / 3600);
        const m = Math.floor((remainingSeconds % 3600) / 60);
        const s = remainingSeconds % 60;

        const topDisplay = document.getElementById('timerDisplayTop');
        if (topDisplay) {
            topDisplay.textContent = h > 0
                ? `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`
                : `${m}:${String(s).padStart(2, '0')}`;
        }

        const sH = document.getElementById('sidebarTimerH');
        const sM = document.getElementById('sidebarTimerM');
        const sS = document.getElementById('sidebarTimerS');
        if (sH) sH.textContent = String(h).padStart(2, '0');
        if (sM) sM.textContent = String(m).padStart(2, '0');
        if (sS) sS.textContent = String(s).padStart(2, '0');
    })();

    setInterval(updateTimer, 1000);
    {% endif %}

    // ==========================================
    // QUESTION NAVIGATION (SPA)
    // ==========================================
    function showQuestion(index) {
        // Hide all question slides
        document.querySelectorAll('.test-question-slide').forEach(function(slide) {
            slide.classList.add('d-none');
        });

        // Show target question
        const currentSlide = document.querySelector('.test-question-slide[data-index="' + index + '"]');
        if (currentSlide) {
            currentSlide.classList.remove('d-none');
        }

        // Update global index
        currentIndex = index;

        // Update bottom bar
        document.getElementById('bottomCurrentNum').textContent = index + 1;

        // Update sidebar grid
        updateSidebarGrid();

        // Reset question timer
        questionStartTime = Date.now();

        // Update prev/next buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        prevBtn.disabled = (index === 0);

        if (index === totalQuestions - 1) {
            nextBtn.innerHTML = 'Yakunlash <i class="bi bi-check-lg"></i>';
        } else {
            nextBtn.innerHTML = 'Keyingi <i class="bi bi-chevron-right"></i>';
        }

        // Scroll question content to top
        var contentArea = document.querySelector('.test-question-content');
        if (contentArea) contentArea.scrollTop = 0;
    }

    window.nextQuestion = function() {
        if (currentIndex < totalQuestions - 1) {
            showQuestion(currentIndex + 1);
        } else {
            showFinishModal();
        }
    };

    window.prevQuestion = function() {
        if (currentIndex > 0) {
            showQuestion(currentIndex - 1);
        }
    };

    window.goToQuestion = function(index) {
        showQuestion(index);
        // Close mobile sidebar if open
        closeMobileSidebar();
    };

    function updateSidebarGrid() {
        document.querySelectorAll('.sidebar-q-btn').forEach(function(btn) {
            var idx = parseInt(btn.dataset.index);
            btn.classList.remove('current');
            if (idx === currentIndex) {
                btn.classList.add('current');
            }
        });
    }

    // ==========================================
    // ANSWER SELECTION
    // ==========================================
    window.selectAnswer = function(questionIndex, answerId, element) {
        var slide = element.closest('.test-question-slide');
        var questionId = slide.dataset.questionId;
        var timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);

        // Update UI — deselect others
        slide.querySelectorAll('.test-answer-option').forEach(function(opt) {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');

        // Mark as answered
        answeredQuestions.add(questionIndex);
        updateProgress();

        // Update sidebar grid
        var sidebarBtn = document.querySelector('.sidebar-q-btn[data-index="' + questionIndex + '"]');
        if (sidebarBtn) {
            sidebarBtn.classList.add('answered');
        }

        // Send to server via AJAX
        fetch('/tests/play/' + attemptUuid + '/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                question_id: questionId,
                answer_id: answerId,
                time_spent: timeSpent,
                current_index: questionIndex
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('Answer saved:', data);
        })
        .catch(function(error) {
            console.error('Error saving answer:', error);
        });
    };

    // ==========================================
    // PROGRESS UPDATE
    // ==========================================
    function updateProgress() {
        var answered = answeredQuestions.size;
        var percentage = Math.round((answered / totalQuestions) * 100);

        document.getElementById('answeredCount').textContent = answered;
        document.getElementById('progressFill').style.width = percentage + '%';

        // Mobile counter
        var mobileCount = document.getElementById('mobileCount');
        if (mobileCount) mobileCount.textContent = answered + '/' + totalQuestions;

        // Modal stats
        document.getElementById('modalAnswered').textContent = answered;
        document.getElementById('modalUnanswered').textContent = totalQuestions - answered;
        document.getElementById('modalBookmarked').textContent = bookmarkedQuestions.size;
    }

    // Initialize progress
    updateProgress();

    // ==========================================
    // BOOKMARK
    // ==========================================
    window.toggleBookmark = function(questionId, button) {
        fetch('/tests/api/play/' + attemptUuid + '/bookmark/' + questionId + '/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.is_bookmarked) {
                button.classList.add('active');
                button.querySelector('i').classList.remove('bi-bookmark');
                button.querySelector('i').classList.add('bi-bookmark-fill');
                bookmarkedQuestions.add(questionId);
            } else {
                button.classList.remove('active');
                button.querySelector('i').classList.remove('bi-bookmark-fill');
                button.querySelector('i').classList.add('bi-bookmark');
                bookmarkedQuestions.delete(questionId);
            }

            // Update sidebar grid
            var sidebarBtn = document.querySelector('.sidebar-q-btn[data-index="' + currentIndex + '"]');
            if (sidebarBtn) {
                if (data.is_bookmarked) {
                    sidebarBtn.classList.add('bookmarked');
                } else {
                    sidebarBtn.classList.remove('bookmarked');
                }
            }

            // Update modal
            document.getElementById('modalBookmarked').textContent = bookmarkedQuestions.size;
        })
        .catch(function(error) {
            console.error('Bookmark error:', error);
        });
    };

    // ==========================================
    // TOOLS PANEL
    // ==========================================
    window.toggleToolsPanel = function() {
        var panel = document.getElementById('toolsPanel');
        var btn = document.getElementById('toggleTools');

        if (panel) {
            panel.classList.toggle('collapsed');
            if (btn) btn.classList.toggle('active');
        }
    };

    // Formula accordion toggle
    window.toggleFormulaSection = function(btn) {
        var body = btn.nextElementSibling;
        var isOpen = body.classList.contains('show');
        // Close all in same container
        var container = btn.parentElement;
        container.querySelectorAll('.formula-accordion-btn').forEach(function(b) { b.classList.remove('active'); });
        container.querySelectorAll('.formula-accordion-body').forEach(function(b) { b.classList.remove('show'); });
        if (!isOpen) {
            btn.classList.add('active');
            body.classList.add('show');
        }
    };

    // Atlas section toggle
    window.toggleAtlasSection = function(btn) {
        var body = btn.nextElementSibling;
        var isOpen = body.classList.contains('show');
        var container = btn.parentElement;
        container.querySelectorAll('.atlas-section-btn').forEach(function(b) { b.classList.remove('active'); });
        container.querySelectorAll('.atlas-body').forEach(function(b) { b.classList.remove('show'); });
        if (!isOpen) {
            btn.classList.add('active');
            body.classList.add('show');
        }
    };

    // Dictionary search (Free Dictionary API)
    window.searchDictionary = function() {
        var input = document.getElementById('dictSearchInput');
        var resultDiv = document.getElementById('dictResult');
        var word = input.value.trim().toLowerCase();
        if (!word) return;

        resultDiv.innerHTML = '<div class="dict-loading"><div class="spinner-border spinner-border-sm" role="status"></div> Qidirilmoqda...</div>';

        fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(word))
            .then(function(res) {
                if (!res.ok) throw new Error('not found');
                return res.json();
            })
            .then(function(data) {
                var entry = data[0];
                var html = '<div class="dict-result">';
                html += '<div class="dict-word">' + entry.word + '</div>';
                if (entry.phonetic) {
                    html += '<div class="dict-phonetic">' + entry.phonetic + '</div>';
                } else if (entry.phonetics && entry.phonetics.length > 0) {
                    for (var p = 0; p < entry.phonetics.length; p++) {
                        if (entry.phonetics[p].text) {
                            html += '<div class="dict-phonetic">' + entry.phonetics[p].text + '</div>';
                            break;
                        }
                    }
                }
                // Audio
                if (entry.phonetics) {
                    for (var a = 0; a < entry.phonetics.length; a++) {
                        if (entry.phonetics[a].audio) {
                            html += '<audio controls style="width:100%;height:32px;margin-bottom:0.5rem;"><source src="' + entry.phonetics[a].audio + '" type="audio/mpeg"></audio>';
                            break;
                        }
                    }
                }
                // Meanings
                for (var i = 0; i < entry.meanings.length; i++) {
                    var meaning = entry.meanings[i];
                    html += '<div class="dict-meaning">';
                    html += '<div class="dict-pos">' + meaning.partOfSpeech + '</div>';
                    for (var j = 0; j < Math.min(meaning.definitions.length, 3); j++) {
                        var def = meaning.definitions[j];
                        html += '<div class="dict-def">' + def.definition + '</div>';
                        if (def.example) {
                            html += '<div class="dict-example">"' + def.example + '"</div>';
                        }
                    }
                    html += '</div>';
                }
                html += '</div>';
                resultDiv.innerHTML = html;
            })
            .catch(function() {
                resultDiv.innerHTML = '<div class="dict-error"><i class="bi bi-exclamation-circle"></i> "<strong>' + word + '</strong>" so\'zi topilmadi. Boshqa so\'z kiriting.</div>';
            });
    };

    // Tool tabs switching
    document.querySelectorAll('.test-tools-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            var toolId = this.dataset.tool;

            // Update tabs
            document.querySelectorAll('.test-tools-tab').forEach(function(t) {
                t.classList.remove('active');
            });
            this.classList.add('active');

            // Update content
            document.querySelectorAll('.test-tool-view').forEach(function(v) {
                v.classList.add('d-none');
            });
            var toolView = document.getElementById('tool-' + toolId);
            if (toolView) toolView.classList.remove('d-none');
        });
    });

    // Toggle tools button
    var toggleToolsBtn = document.getElementById('toggleTools');
    if (toggleToolsBtn) {
        toggleToolsBtn.addEventListener('click', toggleToolsPanel);
    }

    // ==========================================
    // SIDEBAR TOGGLE (Desktop)
    // ==========================================
    var toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', function() {
            var sidebar = document.getElementById('testSidebar');
            sidebar.classList.toggle('collapsed');
            this.classList.toggle('active');
        });
    }

    // ==========================================
    // MOBILE SIDEBAR
    // ==========================================
    window.toggleMobileSidebar = function() {
        var sidebar = document.getElementById('testSidebar');
        var overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('mobile-show');
        overlay.classList.toggle('show');
        document.body.style.overflow = sidebar.classList.contains('mobile-show') ? 'hidden' : '';
    };

    function closeMobileSidebar() {
        var sidebar = document.getElementById('testSidebar');
        var overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('mobile-show');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }

    // ==========================================
    // FULLSCREEN
    // ==========================================
    document.getElementById('toggleFullscreen').addEventListener('click', function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(function(err) {
                console.log('Fullscreen error:', err);
            });
            this.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
        } else {
            document.exitFullscreen();
            this.innerHTML = '<i class="bi bi-fullscreen"></i>';
        }
    });

    // ==========================================
    // FINISH MODAL
    // ==========================================
    window.showFinishModal = function() {
        updateProgress(); // ensure latest stats
        document.getElementById('finishModal').classList.add('show');
    };

    window.hideFinishModal = function() {
        document.getElementById('finishModal').classList.remove('show');
    };

    // Close modal on ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('finishModal').classList.contains('show')) {
            hideFinishModal();
        }
    });

    // ==========================================
    // CONFIRM EXIT
    // ==========================================
    window.confirmExit = function() {
        return confirm('Testni tark etmoqchimisiz? Barcha javoblaringiz saqlanadi.');
    };

    // ==========================================
    // AI HELP
    // ==========================================
    window.askAI = function() {
        window.open('{% url "ai_core:ai_mentor" %}', '_blank');
    };

    // ==========================================
    // REPORT QUESTION
    // ==========================================
    window.reportQuestion = function(questionId) {
        if (confirm("Bu savoldagi xatolikni xabar qilmoqchimisiz?")) {
            alert("Rahmat! Xabar qabul qilindi. Tez orada tekshiramiz.");
            // TODO: Send report to server
        }
    };

    // ==========================================
    // KEYBOARD SHORTCUTS
    // ==========================================
    document.addEventListener('keydown', function(e) {
        // Don't handle if modal is open
        if (document.getElementById('finishModal').classList.contains('show')) {
            return;
        }

        // Arrow keys for navigation
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            nextQuestion();
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            prevQuestion();
        }

        // Number keys 1-4 for answers
        if (['1', '2', '3', '4'].includes(e.key)) {
            var answerIndex = parseInt(e.key) - 1;
            var currentSlide = document.querySelector('.test-question-slide[data-index="' + currentIndex + '"]');
            if (currentSlide) {
                var answers = currentSlide.querySelectorAll('.test-answer-option');
                if (answers[answerIndex]) {
                    answers[answerIndex].click();
                }
            }
        }

        // A, B, C, D keys for answers
        var letterMap = {'A': 0, 'B': 1, 'C': 2, 'D': 3};
        var upperKey = e.key.toUpperCase();
        if (upperKey in letterMap && upperKey !== 'B') { // B is reserved for bookmark below when standalone
            // Only trigger if not combined with other intent
        }

        // B for bookmark (only lowercase b without shift)
        if (e.key === 'b' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
            var currentSlide = document.querySelector('.test-question-slide[data-index="' + currentIndex + '"]');
            if (currentSlide) {
                var bookmarkBtn = currentSlide.querySelector('.test-bookmark-btn');
                if (bookmarkBtn) {
                    var questionId = parseInt(currentSlide.dataset.questionId);
                    toggleBookmark(questionId, bookmarkBtn);
                }
            }
        }
    });

    // ==========================================
    // ANTI-CHEAT (Basic)
    // ==========================================
    // Disable right-click on test area
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // Disable copy
    document.addEventListener('copy', function(e) {
        e.preventDefault();
    });

    // Disable text selection on question/answer text (CSS handles this too)
    document.querySelectorAll('.test-question-text, .test-answer-text').forEach(function(el) {
        el.style.userSelect = 'none';
        el.style.webkitUserSelect = 'none';
    });

    // Warn before leaving
    window.addEventListener('beforeunload', function(e) {
        e.preventDefault();
        e.returnValue = '';
    });

    // ==========================================
    // INITIALIZE
    // ==========================================
    showQuestion(currentIndex);

})();
</script>
{% endblock %}