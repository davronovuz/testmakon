{% extends 'base.html' %}
{% load static %}

{% block title %}Oliygohlar | TestMakon{% endblock %}

{% block extra_css %}
<style>
    {% include 'includes/_sidebar_css.html' %}

    /* ===== STATS BAR ===== */
    .unis-stats-bar {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        padding: 0.85rem 1.25rem;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        margin-bottom: 1.25rem;
    }
    .unis-stats-item { display: flex; align-items: center; gap: 0.6rem; }
    .unis-stats-icon {
        width: 34px; height: 34px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.9rem;
    }
    .unis-stats-icon.blue   { background: #DBEAFE; color: #2563EB; }
    .unis-stats-icon.green  { background: #D1FAE5; color: #059669; }
    .unis-stats-icon.orange { background: #FED7AA; color: #EA580C; }
    .unis-stats-value { font-size: 1.1rem; font-weight: 800; color: var(--dark); }
    .unis-stats-label { font-size: 0.68rem; color: var(--gray-500); }

    /* ===== FILTER BAR ===== */
    .unis-filter-bar {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 0.85rem 1rem;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex-wrap: wrap;
    }
    .unis-filter-group {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-wrap: wrap;
    }
    .unis-filter-btn {
        padding: 0.38rem 0.85rem;
        background: var(--gray-50);
        border: 1.5px solid var(--gray-200);
        border-radius: var(--radius);
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--dark-600);
        cursor: pointer;
        transition: all 0.18s;
        white-space: nowrap;
    }
    .unis-filter-btn:hover { border-color: var(--gray-400); background: var(--gray-100); }
    .unis-filter-btn.active {
        background: var(--gradient-primary);
        border-color: var(--primary);
        color: white;
    }
    .unis-divider { width: 1px; height: 28px; background: var(--gray-200); flex-shrink: 0; }
    .unis-region-select {
        padding: 0.38rem 0.75rem;
        border: 1.5px solid var(--gray-200);
        border-radius: var(--radius);
        font-size: 0.78rem;
        font-weight: 500;
        background: var(--gray-50);
        color: var(--dark);
        cursor: pointer;
        max-width: 180px;
    }
    .unis-region-select:focus { outline: none; border-color: var(--primary); }
    .unis-search {
        position: relative;
        flex: 1;
        min-width: 160px;
        max-width: 280px;
        margin-left: auto;
    }
    .unis-search input {
        width: 100%;
        padding: 0.42rem 0.75rem 0.42rem 2.1rem;
        border: 1.5px solid var(--gray-200);
        border-radius: var(--radius);
        font-size: 0.78rem;
        background: var(--gray-50);
        color: var(--dark);
        transition: all 0.2s;
    }
    .unis-search input:focus { outline: none; border-color: var(--primary); background: var(--white); box-shadow: 0 0 0 3px var(--primary-glow); }
    .unis-search i { position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%); color: var(--gray-400); font-size: 0.82rem; }

    /* ===== RESULT INFO ===== */
    .unis-result-info {
        font-size: 0.78rem;
        color: var(--gray-500);
        margin-bottom: 0.75rem;
        padding: 0 0.1rem;
        min-height: 20px;
    }
    .unis-result-info strong { color: var(--dark); }

    /* ===== GRID ===== */
    .unis-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        min-height: 200px;
    }
    @media (max-width: 900px) { .unis-grid { grid-template-columns: 1fr; } }

    /* ===== CARD ===== */
    .uni-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: all 0.22s;
        display: flex;
        flex-direction: column;
        text-decoration: none;
        position: relative;
    }
    .uni-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        border-color: var(--gray-300);
        text-decoration: none;
    }
    .uni-card-banner {
        position: relative;
        height: 100px;
        background: linear-gradient(135deg, #e8f5d9 0%, #d0edaf 100%);
        overflow: hidden;
        flex-shrink: 0;
    }
    .uni-card-banner img {
        width: 100%; height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    .uni-card:hover .uni-card-banner img { transform: scale(1.05); }
    .uni-card-logo-wrap {
        position: absolute;
        bottom: -18px; left: 1rem;
        width: 42px; height: 42px;
        background: var(--white);
        border: 2px solid var(--gray-200);
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
        z-index: 2;
        flex-shrink: 0;
    }
    .uni-card-logo-wrap img { width: 100%; height: 100%; object-fit: contain; }
    .uni-card-logo-letters { font-size: 1rem; font-weight: 800; color: var(--primary); line-height: 1; }

    .uni-card-type-badge {
        position: absolute;
        top: 0.5rem; right: 0.5rem;
        font-size: 0.62rem;
        font-weight: 700;
        padding: 0.2rem 0.55rem;
        border-radius: 5px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .uni-card-type-badge.state   { background: #DBEAFE; color: #1D4ED8; }
    .uni-card-type-badge.private { background: #FEE2E2; color: #DC2626; }
    .uni-card-type-badge.foreign { background: #F3E8FF; color: #7C3AED; }
    .uni-card-type-badge.joint   { background: #FEF3C7; color: #B45309; }

    .uni-card-featured-badge {
        position: absolute;
        top: 0.5rem; left: 0.5rem;
        font-size: 0.6rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 5px;
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        text-transform: uppercase;
    }

    .uni-card-body {
        padding: 1.4rem 1rem 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .uni-card-name {
        font-size: 0.88rem;
        font-weight: 700;
        color: var(--dark);
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin: 0;
    }
    .uni-card-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: auto;
    }
    .uni-card-meta-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.72rem;
        color: var(--gray-500);
    }
    .uni-card-meta-item i { font-size: 0.8rem; }
    .uni-card-meta-item strong { color: var(--dark-600); font-weight: 600; }
    .uni-card-dirs {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--primary);
        background: #f0fae3;
        border-radius: 6px;
        padding: 0.22rem 0.6rem;
    }

    /* ===== SKELETON ===== */
    .uni-card-skeleton {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        overflow: hidden;
        height: 210px;
    }
    .sk-banner { height: 100px; background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200%; animation: sk-shine 1.4s infinite; }
    .sk-body { padding: 1.4rem 1rem 1rem; }
    .sk-line { height: 12px; border-radius: 6px; background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200%; animation: sk-shine 1.4s infinite; margin-bottom: 0.6rem; }
    .sk-line.w70 { width: 70%; }
    .sk-line.w45 { width: 45%; }
    @keyframes sk-shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* ===== EMPTY STATE ===== */
    .unis-empty {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem 1.5rem;
        background: var(--white);
        border-radius: var(--radius-lg);
        border: 1px dashed var(--gray-300);
    }
    .unis-empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.35; }
    .unis-empty h4 { font-size: 0.95rem; font-weight: 700; color: var(--dark); margin-bottom: 0.4rem; }
    .unis-empty p { color: var(--gray-400); font-size: 0.82rem; margin: 0; }

    /* ===== PAGINATION ===== */
    .unis-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.35rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }
    .unis-page-btn {
        min-width: 34px; height: 34px;
        padding: 0 0.5rem;
        border-radius: var(--radius);
        display: inline-flex; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: 600;
        background: var(--white);
        color: var(--dark-600);
        border: 1px solid var(--gray-200);
        cursor: pointer;
        transition: all 0.15s;
        user-select: none;
    }
    .unis-page-btn:hover:not(.disabled) { border-color: var(--primary); color: var(--primary); }
    .unis-page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .unis-page-btn.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 600px) {
        .unis-stats-bar { gap: 0.75rem; padding: 0.75rem; }
        .unis-filter-bar { gap: 0.5rem; padding: 0.75rem; }
        .unis-search { max-width: 100%; margin-left: 0; }
        .unis-divider { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="tl-layout">
        {% include 'includes/_sidebar.html' with active='universities_list' %}

        <main>
            <!-- Stats Bar -->
            <div class="unis-stats-bar">
                <div class="unis-stats-item">
                    <div class="unis-stats-icon blue"><i class="bi bi-building"></i></div>
                    <div>
                        <div class="unis-stats-value" id="statTotal">{{ total_count }}</div>
                        <div class="unis-stats-label">Jami OTM</div>
                    </div>
                </div>
                <div class="unis-stats-item">
                    <div class="unis-stats-icon green"><i class="bi bi-bank"></i></div>
                    <div>
                        <div class="unis-stats-value">{{ state_count }}</div>
                        <div class="unis-stats-label">Davlat</div>
                    </div>
                </div>
                <div class="unis-stats-item">
                    <div class="unis-stats-icon orange"><i class="bi bi-buildings"></i></div>
                    <div>
                        <div class="unis-stats-value">{{ private_count }}</div>
                        <div class="unis-stats-label">Xususiy</div>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="unis-filter-bar">
                <!-- Type filter -->
                <div class="unis-filter-group">
                    <button class="unis-filter-btn active" data-filter="type" data-value="all">
                        <i class="bi bi-grid me-1"></i>Barchasi
                    </button>
                    <button class="unis-filter-btn" data-filter="type" data-value="state">
                        <i class="bi bi-bank me-1"></i>Davlat
                    </button>
                    <button class="unis-filter-btn" data-filter="type" data-value="private">
                        <i class="bi bi-buildings me-1"></i>Xususiy
                    </button>
                    <button class="unis-filter-btn" data-filter="type" data-value="foreign">
                        <i class="bi bi-globe me-1"></i>Xorijiy
                    </button>
                </div>

                <div class="unis-divider"></div>

                <!-- Region filter (DB'dan) -->
                <select class="unis-region-select" id="regionSelect">
                    <option value="all">ğŸ“ Barcha hududlar</option>
                    {% for region in regions %}
                    <option value="{{ region }}">{{ region }}</option>
                    {% endfor %}
                </select>

                <!-- Search -->
                <div class="unis-search">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" placeholder="OTM nomi..." autocomplete="off">
                </div>
            </div>

            <!-- Result info -->
            <div class="unis-result-info" id="resultInfo">
                Yuklanmoqda...
            </div>

            <!-- Grid -->
            <div class="unis-grid" id="universitiesGrid">
                <!-- Skeleton -->
                {% for i in "123456789012" %}
                <div class="uni-card-skeleton">
                    <div class="sk-banner"></div>
                    <div class="sk-body">
                        <div class="sk-line w70"></div>
                        <div class="sk-line w45"></div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            <div class="unis-pagination" id="pagination"></div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const FILTER_URL = "{% url 'universities:api_filter' %}";
    const PLACEHOLDER = "{% static 'images/university-placeholder.jpg' %}";

    let currentType   = 'all';
    let currentRegion = 'all';
    let currentSearch = '';
    let currentPage   = 1;
    let searchTimer   = null;
    let loading       = false;

    // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const grid      = document.getElementById('universitiesGrid');
    const paginEl   = document.getElementById('pagination');
    const resultEl  = document.getElementById('resultInfo');
    const regionSel = document.getElementById('regionSelect');
    const searchInp = document.getElementById('searchInput');

    // â”€â”€ Type filter buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.unis-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.unis-filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentType = this.dataset.value;
            currentPage = 1;
            load();
        });
    });

    // â”€â”€ Region select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    regionSel.addEventListener('change', function() {
        currentRegion = this.value;
        currentPage = 1;
        load();
    });

    // â”€â”€ Search input (debounce 350ms) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    searchInp.addEventListener('input', function() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            currentSearch = this.value.trim();
            currentPage = 1;
            load();
        }, 350);
    });

    // â”€â”€ Fetch & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function load() {
        if (loading) return;
        loading = true;

        const params = new URLSearchParams({
            type:   currentType,
            region: currentRegion,
            q:      currentSearch,
            page:   currentPage,
        });

        // Update URL without reload
        const url = new URL(window.location.href);
        url.searchParams.set('type',   currentType);
        url.searchParams.set('region', currentRegion);
        url.searchParams.set('q',      currentSearch);
        url.searchParams.set('page',   currentPage);
        history.replaceState(null, '', url.toString());

        // Skeleton
        grid.innerHTML = Array(6).fill(0).map(() => `
            <div class="uni-card-skeleton">
                <div class="sk-banner"></div>
                <div class="sk-body">
                    <div class="sk-line w70"></div>
                    <div class="sk-line w45"></div>
                </div>
            </div>
        `).join('');
        paginEl.innerHTML = '';
        resultEl.textContent = 'Yuklanmoqda...';

        fetch(FILTER_URL + '?' + params)
            .then(r => r.json())
            .then(data => {
                loading = false;
                renderGrid(data);
                renderPagination(data);
                resultEl.innerHTML = `<strong>${data.total}</strong> ta OTM topildi`;
            })
            .catch(() => {
                loading = false;
                grid.innerHTML = '<div class="unis-empty"><div class="unis-empty-icon">âš ï¸</div><h4>Xatolik yuz berdi</h4><p>Sahifani yangilang</p></div>';
                resultEl.textContent = '';
            });
    }

    // â”€â”€ Render cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderGrid(data) {
        if (!data.universities.length) {
            grid.innerHTML = `
                <div class="unis-empty">
                    <div class="unis-empty-icon">ğŸ«</div>
                    <h4>OTM topilmadi</h4>
                    <p>Boshqa filtr tanlang yoki qidiruvni o'zgartiring</p>
                </div>`;
            return;
        }

        grid.innerHTML = data.universities.map(u => {
            const typeClass = {state:'state', private:'private', foreign:'foreign', joint:'joint'}[u.university_type] || 'state';
            const typeLabel = u.type_display || 'Davlat';
            const logoHtml  = u.logo_url
                ? `<img src="${u.logo_url}" alt="" loading="lazy">`
                : `<span class="uni-card-logo-letters">${(u.short_name || u.name).slice(0,2).toUpperCase()}</span>`;
            const bannerHtml = u.cover_url
                ? `<img src="${u.cover_url}" alt="" loading="lazy">`
                : '';
            const featuredBadge = u.is_featured
                ? `<span class="uni-card-featured-badge"><i class="bi bi-star-fill"></i> Top</span>` : '';

            return `
            <a href="/universities/${u.slug}/" class="uni-card">
                <div class="uni-card-banner">
                    ${bannerHtml}
                    ${featuredBadge}
                    <span class="uni-card-type-badge ${typeClass}">${typeLabel}</span>
                    <div class="uni-card-logo-wrap">${logoHtml}</div>
                </div>
                <div class="uni-card-body">
                    <h3 class="uni-card-name">${u.name}</h3>
                    <div class="uni-card-meta">
                        <span class="uni-card-meta-item">
                            <i class="bi bi-geo-alt"></i>
                            <span>${u.region || 'Noma\'lum'}</span>
                        </span>
                        <span class="uni-card-dirs">
                            <i class="bi bi-journal-bookmark"></i>
                            ${u.directions_count} yo'nalish
                        </span>
                        ${u.rating > 0 ? `
                        <span class="uni-card-meta-item ms-auto">
                            <i class="bi bi-star-fill" style="color:#FBBF24"></i>
                            <strong>${u.rating.toFixed(1)}</strong>
                        </span>` : ''}
                    </div>
                </div>
            </a>`;
        }).join('');
    }

    // â”€â”€ Render pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPagination(data) {
        if (data.num_pages <= 1) { paginEl.innerHTML = ''; return; }

        let html = '';

        // Prev
        html += `<button class="unis-page-btn ${!data.has_prev ? 'disabled' : ''}" data-page="${data.prev_page}">
                    <i class="bi bi-chevron-left"></i>
                 </button>`;

        // Pages
        const cur = data.page;
        const total = data.num_pages;
        const pages = [];
        for (let i = 1; i <= total; i++) {
            if (i === 1 || i === total || (i >= cur - 2 && i <= cur + 2)) {
                pages.push(i);
            } else if (pages[pages.length - 1] !== 'â€¦') {
                pages.push('â€¦');
            }
        }
        pages.forEach(p => {
            if (p === 'â€¦') {
                html += `<span class="unis-page-btn disabled">â€¦</span>`;
            } else {
                html += `<button class="unis-page-btn ${p === cur ? 'active' : ''}" data-page="${p}">${p}</button>`;
            }
        });

        // Next
        html += `<button class="unis-page-btn ${!data.has_next ? 'disabled' : ''}" data-page="${data.next_page}">
                    <i class="bi bi-chevron-right"></i>
                 </button>`;

        paginEl.innerHTML = html;

        paginEl.querySelectorAll('.unis-page-btn:not(.disabled):not(.active)').forEach(btn => {
            btn.addEventListener('click', function() {
                currentPage = parseInt(this.dataset.page);
                load();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    }

    // â”€â”€ Restore state from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function restoreFromUrl() {
        const p = new URLSearchParams(window.location.search);
        if (p.get('type'))   { currentType   = p.get('type');   }
        if (p.get('region')) { currentRegion = p.get('region'); }
        if (p.get('q'))      { currentSearch = p.get('q');       }
        if (p.get('page'))   { currentPage   = parseInt(p.get('page')) || 1; }

        // Set UI state
        if (currentRegion !== 'all') regionSel.value = currentRegion;
        if (currentSearch) searchInp.value = currentSearch;
        if (currentType !== 'all') {
            document.querySelectorAll('.unis-filter-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.value === currentType);
            });
        }
    })();

    // â”€â”€ Initial load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    load();

})();
</script>
{% endblock %}
