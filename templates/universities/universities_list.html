{% extends 'base.html' %}
{% load static %}

{% block title %}Oliygohlar | TestMakon{% endblock %}

{% block extra_css %}
<style>
    {% include 'includes/_sidebar_css.html' %}

    /* ===== STATS ===== */
    .unis-stats {
        display: flex; gap: .85rem; margin-bottom: 1.1rem;
    }
    .unis-stat {
        flex:1; background:var(--white); border:1px solid var(--gray-200);
        border-radius:var(--radius-lg); padding:.8rem 1rem;
        display:flex; align-items:center; gap:.65rem;
    }
    .unis-stat-ic {
        width:36px;height:36px;border-radius:9px;flex-shrink:0;
        display:flex;align-items:center;justify-content:center;font-size:.95rem;
    }
    .ic-blue{background:#DBEAFE;color:#2563EB} .ic-green{background:#D1FAE5;color:#059669} .ic-amber{background:#FEF3C7;color:#D97706}
    .unis-stat-num{font-size:1.15rem;font-weight:800;color:var(--dark);line-height:1}
    .unis-stat-lbl{font-size:.65rem;color:var(--gray-500);margin-top:2px}

    /* ===== FILTER BAR ===== */
    .unis-bar {
        background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-lg);
        padding:.7rem .9rem;margin-bottom:1rem;
        display:flex;gap:.45rem;flex-wrap:wrap;align-items:center;
    }
    .f-btn {
        padding:.32rem .75rem;border:1.5px solid var(--gray-200);border-radius:8px;
        font-size:.75rem;font-weight:600;color:var(--dark-600);background:var(--gray-50);
        cursor:pointer;transition:all .15s;white-space:nowrap;
    }
    .f-btn:hover{border-color:var(--primary);color:var(--primary)}
    .f-btn.active{background:var(--gradient-primary);border-color:var(--primary);color:#fff}
    .f-sep{width:1px;height:22px;background:var(--gray-200);flex-shrink:0}
    .f-sel {
        padding:.32rem .65rem;border:1.5px solid var(--gray-200);border-radius:8px;
        font-size:.75rem;font-weight:500;background:var(--gray-50);color:var(--dark);
        cursor:pointer;max-width:175px;
    }
    .f-sel:focus{outline:none;border-color:var(--primary)}
    .f-search{position:relative;flex:0 0 220px;margin-left:auto}
    .f-search input{
        width:100%;padding:.35rem .75rem .35rem 2rem;
        border:1.5px solid var(--gray-200);border-radius:8px;
        font-size:.75rem;background:var(--gray-50);color:var(--dark);
    }
    .f-search input:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 3px var(--primary-glow)}
    .f-search i{position:absolute;left:.6rem;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:.78rem}

    /* ===== RESULT INFO ===== */
    .unis-info{font-size:.75rem;color:var(--gray-400);margin-bottom:.8rem;min-height:16px}
    .unis-info strong{color:var(--dark-600)}

    /* ===== GRID ===== */
    .unis-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.9rem}
    @media(max-width:900px){.unis-grid{grid-template-columns:1fr}}

    /* ===== CARD ===== */
    .uni-card {
        background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-lg);
        overflow:hidden;display:flex;flex-direction:column;text-decoration:none;
        transition:all .22s;
    }
    .uni-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);border-color:var(--gray-300);text-decoration:none}

    /* Banner */
    .uni-banner{position:relative;height:120px;overflow:hidden;flex-shrink:0}
    .uni-banner img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
    .uni-card:hover .uni-banner img{transform:scale(1.04)}
    /* Gradient fallback banners */
    .uni-banner.g0{background:linear-gradient(135deg,#e8f5d9,#c8e8a0)}
    .uni-banner.g1{background:linear-gradient(135deg,#dbeafe,#bfdbfe)}
    .uni-banner.g2{background:linear-gradient(135deg,#fde68a,#fcd34d)}
    .uni-banner.g3{background:linear-gradient(135deg,#e9d5ff,#c4b5fd)}
    .uni-banner.g4{background:linear-gradient(135deg,#fed7aa,#fdba74)}
    .uni-banner.g5{background:linear-gradient(135deg,#d1fae5,#6ee7b7)}

    /* Banner decorative initials */
    .uni-banner-letters{
        position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        font-size:3.5rem;font-weight:900;opacity:.12;color:#000;
        white-space:nowrap;letter-spacing:-2px;user-select:none;
    }

    /* Logo */
    .uni-logo-wrap{
        position:absolute;bottom:-18px;left:1rem;
        width:44px;height:44px;background:var(--white);
        border:2px solid var(--gray-200);border-radius:11px;
        display:flex;align-items:center;justify-content:center;
        overflow:hidden;z-index:2;flex-shrink:0;
        box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .uni-logo-wrap img{width:100%;height:100%;object-fit:contain}
    .uni-logo-letters{font-size:.95rem;font-weight:800;color:var(--primary);line-height:1}

    /* Type badge on banner */
    .uni-type-badge{
        position:absolute;top:.5rem;right:.5rem;
        font-size:.6rem;font-weight:700;padding:.18rem .5rem;
        border-radius:5px;text-transform:uppercase;letter-spacing:.3px;
    }
    .tb-state{background:#DBEAFE;color:#1D4ED8}
    .tb-private{background:#FEE2E2;color:#DC2626}
    .tb-foreign{background:#EDE9FE;color:#6D28D9}
    .tb-joint{background:#FEF3C7;color:#B45309}
    .uni-feat-badge{
        position:absolute;top:.5rem;left:.5rem;
        font-size:.6rem;font-weight:700;padding:.18rem .48rem;
        border-radius:5px;background:linear-gradient(135deg,#F97316,#EA580C);color:#fff;
    }

    /* Body */
    .uni-body{padding:1.35rem 1rem .9rem;flex:1;display:flex;flex-direction:column;gap:.45rem}
    .uni-name{
        font-size:.88rem;font-weight:700;color:var(--dark);line-height:1.38;margin:0;
        display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .uni-meta{
        display:flex;align-items:center;justify-content:space-between;
        gap:.5rem;margin-top:auto;
        padding-top:.45rem;border-top:1px solid var(--gray-100);
    }
    .uni-region{display:flex;align-items:center;gap:.3rem;font-size:.72rem;color:var(--gray-500)}
    .uni-region i{font-size:.72rem}
    .uni-dirs{
        display:flex;align-items:center;gap:.28rem;
        font-size:.7rem;font-weight:700;color:var(--primary);
        background:#f0fae3;padding:.2rem .55rem;border-radius:6px;white-space:nowrap;
    }

    /* ===== SKELETON ===== */
    @keyframes sk{0%,100%{opacity:1}50%{opacity:.45}}
    .sk-card{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-lg);overflow:hidden}
    .sk-banner{height:120px;background:var(--gray-100);animation:sk 1.3s ease infinite}
    .sk-body{padding:1.35rem 1rem .9rem;display:flex;flex-direction:column;gap:.5rem}
    .sk-ln{border-radius:5px;background:var(--gray-100);animation:sk 1.3s ease infinite}

    /* ===== EMPTY ===== */
    .unis-empty{
        grid-column:1/-1;text-align:center;
        padding:3.5rem 1.5rem;background:var(--white);
        border:1px dashed var(--gray-300);border-radius:var(--radius-lg);
    }
    .unis-empty-ic{font-size:2.5rem;opacity:.3;margin-bottom:.6rem}
    .unis-empty h4{font-size:.92rem;font-weight:700;color:var(--dark);margin-bottom:.3rem}
    .unis-empty p{color:var(--gray-400);font-size:.8rem;margin:0}

    /* ===== PAGINATION ===== */
    .unis-pager{display:flex;justify-content:center;align-items:center;gap:.3rem;margin-top:1.5rem;flex-wrap:wrap}
    .pg{
        min-width:32px;height:32px;padding:0 .4rem;border:1px solid var(--gray-200);
        border-radius:7px;display:inline-flex;align-items:center;justify-content:center;
        font-size:.78rem;font-weight:600;color:var(--dark-600);background:var(--white);
        cursor:pointer;transition:all .15s;user-select:none;
    }
    .pg:hover:not(.dis):not(.on){border-color:var(--primary);color:var(--primary)}
    .pg.on{background:var(--primary);color:#fff;border-color:var(--primary)}
    .pg.dis{opacity:.35;pointer-events:none}

    /* ===== MOBILE ===== */
    @media(max-width:600px){
        .unis-stats{gap:.5rem} .unis-stat{padding:.65rem .75rem}
        .unis-bar{gap:.4rem} .f-search{flex:0 0 100%;margin-left:0} .f-sep{display:none}
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="tl-layout">
        {% include 'includes/_sidebar.html' with active='universities_list' %}

        <main>
            <!-- Stats -->
            <div class="unis-stats">
                <div class="unis-stat">
                    <div class="unis-stat-ic ic-blue"><i class="bi bi-building"></i></div>
                    <div><div class="unis-stat-num">{{ total_count }}</div><div class="unis-stat-lbl">Jami OTM</div></div>
                </div>
                <div class="unis-stat">
                    <div class="unis-stat-ic ic-green"><i class="bi bi-bank"></i></div>
                    <div><div class="unis-stat-num">{{ state_count }}</div><div class="unis-stat-lbl">Davlat</div></div>
                </div>
                <div class="unis-stat">
                    <div class="unis-stat-ic ic-amber"><i class="bi bi-buildings"></i></div>
                    <div><div class="unis-stat-num">{{ private_count }}</div><div class="unis-stat-lbl">Xususiy</div></div>
                </div>
            </div>

            <!-- Filter bar -->
            <div class="unis-bar">
                <button class="f-btn active" data-t="all">Barchasi</button>
                <button class="f-btn" data-t="state"><i class="bi bi-bank me-1"></i>Davlat</button>
                <button class="f-btn" data-t="private"><i class="bi bi-buildings me-1"></i>Xususiy</button>
                <button class="f-btn" data-t="foreign"><i class="bi bi-globe me-1"></i>Xorijiy</button>
                <div class="f-sep"></div>
                <select class="f-sel" id="rsel">
                    <option value="all">üìç Barcha hududlar</option>
                    {% for r in regions %}<option value="{{ r }}">{{ r }}</option>{% endfor %}
                </select>
                <div class="f-search">
                    <i class="bi bi-search"></i>
                    <input type="text" id="qinp" placeholder="OTM nomi..." autocomplete="off">
                </div>
            </div>

            <div class="unis-info" id="uInfo"></div>
            <div class="unis-grid" id="uGrid"></div>
            <div class="unis-pager" id="uPager"></div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
    const API = "{% url 'universities:api_filter' %}";
    const TYPE_LABEL = {state:'Davlat',private:'Xususiy',foreign:'Xorijiy filial',joint:"Qo'shma"};
    const TYPE_CLS   = {state:'tb-state',private:'tb-private',foreign:'tb-foreign',joint:'tb-joint'};
    const GRADIENTS  = ['g0','g1','g2','g3','g4','g5'];

    let st = {t:'all',r:'all',q:'',p:1};
    let timer = null, busy = false;

    const grid  = document.getElementById('uGrid');
    const pager = document.getElementById('uPager');
    const info  = document.getElementById('uInfo');
    const rsel  = document.getElementById('rsel');
    const qinp  = document.getElementById('qinp');

    document.querySelectorAll('.f-btn').forEach(b => {
        b.addEventListener('click', () => {
            document.querySelectorAll('.f-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            st.t = b.dataset.t; st.p = 1; load();
        });
    });
    rsel.addEventListener('change', () => { st.r = rsel.value; st.p = 1; load(); });
    qinp.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(() => { st.q = qinp.value.trim(); st.p = 1; load(); }, 320);
    });

    function skeleton() {
        grid.innerHTML = Array(6).fill(0).map(() => `
            <div class="sk-card">
                <div class="sk-banner"></div>
                <div class="sk-body">
                    <div class="sk-ln" style="height:14px;width:80%"></div>
                    <div class="sk-ln" style="height:12px;width:55%"></div>
                    <div style="display:flex;justify-content:space-between;padding-top:.4rem">
                        <div class="sk-ln" style="height:12px;width:38%"></div>
                        <div class="sk-ln" style="height:20px;width:90px;border-radius:6px"></div>
                    </div>
                </div>
            </div>`).join('');
        pager.innerHTML = ''; info.textContent = '';
    }

    function load() {
        if (busy) return;
        busy = true; skeleton();
        const p = new URLSearchParams({type:st.t, region:st.r, q:st.q, page:st.p});
        history.replaceState(null,'','?'+p);
        fetch(API+'?'+p)
            .then(r=>r.json())
            .then(d=>{ busy=false; render(d); paginate(d); })
            .catch(()=>{ busy=false; grid.innerHTML='<div class="unis-empty"><div class="unis-empty-ic">‚ö†Ô∏è</div><h4>Xatolik yuz berdi</h4><p>Sahifani yangilang</p></div>'; });
    }

    function initials(str) {
        if (!str) return '??';
        // O'zMU ‚Üí OM, TATU ‚Üí TA, "Buxoro davlat" ‚Üí BD
        const words = str.trim().split(/\s+/);
        if (words.length >= 2) return (words[0][0] + words[1][0]).toUpperCase();
        return str.slice(0,2).toUpperCase();
    }

    function gradClass(id) { return GRADIENTS[id % GRADIENTS.length]; }

    function render(d) {
        if (!d.universities.length) {
            grid.innerHTML = `<div class="unis-empty"><div class="unis-empty-ic">üè´</div><h4>OTM topilmadi</h4><p>Boshqa filtr tanlang yoki qidiruvni o'zgartiring</p></div>`;
            info.innerHTML = ''; return;
        }
        info.innerHTML = `<strong>${d.total}</strong> ta OTM topildi`;

        grid.innerHTML = d.universities.map(u => {
            const tc  = u.university_type || 'state';
            const tl  = TYPE_LABEL[tc] || 'Davlat';
            const tcl = TYPE_CLS[tc] || 'tb-state';
            const gc  = gradClass(u.id);
            const lets = initials(u.short_name || u.name);

            const bannerInner = u.cover_url
                ? `<img src="${u.cover_url}" alt="" loading="lazy">`
                : `<span class="uni-banner-letters">${lets}</span>`;

            const logoInner = u.logo_url
                ? `<img src="${u.logo_url}" alt="" loading="lazy">`
                : `<span class="uni-logo-letters">${lets}</span>`;

            return `
            <a href="/universities/${u.slug}/" class="uni-card">
                <div class="uni-banner ${u.cover_url ? '' : gc}">
                    ${bannerInner}
                    ${u.is_featured ? '<span class="uni-feat-badge"><i class="bi bi-star-fill"></i> Top</span>' : ''}
                    <span class="uni-type-badge ${tcl}">${tl}</span>
                    <div class="uni-logo-wrap">${logoInner}</div>
                </div>
                <div class="uni-body">
                    <h3 class="uni-name">${u.name}</h3>
                    <div class="uni-meta">
                        <span class="uni-region"><i class="bi bi-geo-alt"></i>${u.region || "‚Äî"}</span>
                        <span class="uni-dirs"><i class="bi bi-journal-bookmark-fill"></i>${u.directions_count} yo'nalish</span>
                    </div>
                </div>
            </a>`;
        }).join('');
    }

    function paginate(d) {
        if (d.num_pages <= 1) { pager.innerHTML = ''; return; }
        const cur = d.page, tot = d.num_pages;
        const pages = [];
        for (let i=1;i<=tot;i++){
            if (i===1||i===tot||(i>=cur-2&&i<=cur+2)) pages.push(i);
            else if (pages.at(-1)!=='‚Ä¶') pages.push('‚Ä¶');
        }
        let h = `<button class="pg ${d.has_prev?'':'dis'}" data-p="${cur-1}"><i class="bi bi-chevron-left"></i></button>`;
        pages.forEach(pg => {
            h += pg==='‚Ä¶'
                ? `<span class="pg dis">‚Ä¶</span>`
                : `<button class="pg ${pg===cur?'on':''}" data-p="${pg}">${pg}</button>`;
        });
        h += `<button class="pg ${d.has_next?'':'dis'}" data-p="${cur+1}"><i class="bi bi-chevron-right"></i></button>`;
        pager.innerHTML = h;
        pager.querySelectorAll('.pg:not(.dis):not(.on)').forEach(b => {
            b.addEventListener('click',()=>{ st.p=+b.dataset.p; load(); window.scrollTo({top:0,behavior:'smooth'}); });
        });
    }

    // Restore state from URL
    const sp = new URLSearchParams(location.search);
    if (sp.get('type'))   st.t = sp.get('type');
    if (sp.get('region')) st.r = sp.get('region');
    if (sp.get('q'))      st.q = sp.get('q');
    if (sp.get('page'))   st.p = parseInt(sp.get('page'))||1;
    if (st.r!=='all') rsel.value = st.r;
    if (st.q) qinp.value = st.q;
    if (st.t!=='all') document.querySelectorAll('.f-btn').forEach(b=>b.classList.toggle('active', b.dataset.t===st.t));

    load();
})();
</script>
{% endblock %}
