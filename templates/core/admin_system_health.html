{% extends 'base.html' %}
{% load static %}

{% block title %}System Health | TestMakon{% endblock %}

{% block extra_css %}
<style>
.sh-page { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem; }
.sh-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:2rem; flex-wrap:wrap; gap:1rem; }
.sh-back { display:inline-flex; align-items:center; gap:0.4rem; padding:0.4rem 0.9rem; background:var(--gray-100); border-radius:8px; font-size:0.82rem; font-weight:700; color:var(--dark-600); text-decoration:none; border:1px solid var(--gray-200); }
.sh-back:hover { background:var(--gray-200); color:var(--dark); }
.sh-title { font-size:1.4rem; font-weight:900; color:var(--dark); margin:0; }

.sh-card { background:var(--white); border:1px solid var(--gray-200); border-radius:16px; padding:1.5rem; margin-bottom:1.25rem; }
.sh-card-title { font-size:0.92rem; font-weight:800; color:var(--dark); margin-bottom:1.25rem; display:flex; align-items:center; gap:0.5rem; }

/* Status indicators */
.sh-status { display:inline-flex; align-items:center; gap:0.5rem; padding:0.35rem 0.9rem; border-radius:999px; font-size:0.82rem; font-weight:700; }
.sh-status.ok { background:rgba(34,197,94,0.12); color:#16A34A; border:1px solid rgba(34,197,94,0.25); }
.sh-status.err { background:rgba(239,68,68,0.1); color:#DC2626; border:1px solid rgba(239,68,68,0.2); }
.sh-status.warn { background:rgba(245,158,11,0.12); color:#D97706; border:1px solid rgba(245,158,11,0.25); }

/* Service grid */
.sh-services { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:1rem; }
.sh-service { background:var(--gray-50); border:1px solid var(--gray-100); border-radius:12px; padding:1rem 1.25rem; display:flex; align-items:flex-start; gap:0.75rem; }
.sh-service-icon { font-size:1.5rem; flex-shrink:0; }
.sh-service-name { font-size:0.88rem; font-weight:800; color:var(--dark); margin-bottom:0.2rem; }
.sh-service-info { font-size:0.75rem; color:var(--gray-500); word-break:break-all; }

/* Question stats table */
.sh-table { width:100%; border-collapse:collapse; }
.sh-table th { padding:0.55rem 1rem; font-size:0.72rem; font-weight:700; color:var(--gray-500); text-transform:uppercase; background:var(--gray-50); border-bottom:1px solid var(--gray-100); text-align:left; }
.sh-table td { padding:0.65rem 1rem; border-bottom:1px solid var(--gray-100); font-size:0.84rem; color:var(--dark-600); vertical-align:middle; }
.sh-table tr:last-child td { border-bottom:none; }
.sh-table tr:hover td { background:var(--gray-50); }

.sh-badge { display:inline-block; padding:0.15rem 0.5rem; border-radius:6px; font-size:0.72rem; font-weight:700; }
.sh-badge.green { background:rgba(34,197,94,0.1); color:#16A34A; }
.sh-badge.amber { background:rgba(245,158,11,0.1); color:#D97706; }
.sh-badge.red { background:rgba(239,68,68,0.08); color:#DC2626; }

/* Empty topics */
.sh-empty-topics { font-size:0.75rem; color:#DC2626; }
.sh-empty-topics span { background:rgba(239,68,68,0.08); padding:0.1rem 0.4rem; border-radius:4px; margin:0.1rem; display:inline-block; }

/* Summary stats */
.sh-summary { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1.5rem; }
.sh-sum-card { background:var(--gray-50); border:1px solid var(--gray-100); border-radius:12px; padding:0.75rem 1.25rem; text-align:center; flex:1; min-width:120px; }
.sh-sum-val { font-size:1.5rem; font-weight:900; color:var(--dark); }
.sh-sum-label { font-size:0.72rem; font-weight:700; color:var(--gray-400); text-transform:uppercase; letter-spacing:0.4px; }

.sh-grid2 { display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; }
@media(max-width:768px) { .sh-grid2 { grid-template-columns:1fr; } }

.sh-chart-wrap { height:180px; position:relative; }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-vh-100" style="background:var(--gray-50);">
<div class="sh-page">

  <!-- Header -->
  <div class="sh-header">
    <div class="d-flex align-items-center gap-3">
      <a href="{% url 'core:admin_analytics' %}" class="sh-back">
        <i class="bi bi-arrow-left"></i> Panel
      </a>
      <div>
        <h1 class="sh-title"><i class="bi bi-activity me-2" style="color:var(--primary);"></i>System Health</h1>
        <div style="font-size:0.8rem;color:var(--gray-500);margin-top:0.2rem;">Tizim holati va savol bank statistikasi</div>
      </div>
    </div>
    <button onclick="location.reload()" class="btn btn-sm" style="background:var(--gray-100);color:var(--dark-600);border:1px solid var(--gray-200);border-radius:8px;font-weight:700;font-size:0.8rem;">
      <i class="bi bi-arrow-clockwise me-1"></i> Yangilash
    </button>
  </div>

  <!-- Services -->
  <div class="sh-card">
    <div class="sh-card-title"><i class="bi bi-server" style="color:#2563EB;"></i> Xizmatlar holati</div>
    <div class="sh-services">

      <!-- Redis -->
      <div class="sh-service">
        <div class="sh-service-icon">üóÉÔ∏è</div>
        <div>
          <div class="sh-service-name">Redis / Cache</div>
          <div class="mb-1">
            {% if redis_ok %}
            <span class="sh-status ok"><i class="bi bi-circle-fill" style="font-size:.45rem;"></i> Ishlamoqda</span>
            {% else %}
            <span class="sh-status err"><i class="bi bi-circle-fill" style="font-size:.45rem;"></i> Xatolik</span>
            {% endif %}
          </div>
          <div class="sh-service-info">{{ redis_info }}</div>
        </div>
      </div>

      <!-- Celery -->
      <div class="sh-service">
        <div class="sh-service-icon">‚öôÔ∏è</div>
        <div>
          <div class="sh-service-name">Celery Worker</div>
          <div class="mb-1">
            {% if celery_ok %}
            <span class="sh-status ok"><i class="bi bi-circle-fill" style="font-size:.45rem;"></i> Ishlamoqda</span>
            {% else %}
            <span class="sh-status warn"><i class="bi bi-circle-fill" style="font-size:.45rem;"></i> Noma'lum</span>
            {% endif %}
          </div>
          <div class="sh-service-info">{{ celery_info }}</div>
        </div>
      </div>

      <!-- Database -->
      <div class="sh-service">
        <div class="sh-service-icon">üóÑÔ∏è</div>
        <div>
          <div class="sh-service-name">Ma'lumotlar bazasi</div>
          <div class="mb-1">
            <span class="sh-status ok"><i class="bi bi-circle-fill" style="font-size:.45rem;"></i> Ishlamoqda</span>
          </div>
          <div class="sh-service-info">{{ total_questions }} savol / {{ total_answers }} javob</div>
        </div>
      </div>

      <!-- Django -->
      <div class="sh-service">
        <div class="sh-service-icon">üêç</div>
        <div>
          <div class="sh-service-name">Django</div>
          <div class="mb-1">
            <span class="sh-status ok"><i class="bi bi-circle-fill" style="font-size:.45rem;"></i> Ishlamoqda</span>
          </div>
          <div class="sh-service-info">Bu sahifa yuklandi ‚Äî server ishlaydi</div>
        </div>
      </div>

    </div>
  </div>

  <div class="sh-grid2">
    <!-- Question stats -->
    <div class="sh-card">
      <div class="sh-card-title"><i class="bi bi-journal-text" style="color:#D97706;"></i> Savol bank statistikasi</div>

      <div class="sh-summary">
        <div class="sh-sum-card">
          <div class="sh-sum-val" style="color:var(--primary-dark);">{{ total_questions }}</div>
          <div class="sh-sum-label">Jami savollar</div>
        </div>
        <div class="sh-sum-card">
          <div class="sh-sum-val" style="color:#2563EB;">{{ subject_stats|length }}</div>
          <div class="sh-sum-label">Fanlar</div>
        </div>
      </div>

      <div style="overflow-x:auto;">
        <table class="sh-table">
          <thead>
            <tr>
              <th>Fan</th>
              <th>Savollar</th>
              <th>Mavzular</th>
              <th>Bo'sh</th>
            </tr>
          </thead>
          <tbody>
            {% for s in subject_stats %}
            <tr>
              <td style="font-weight:700;color:var(--dark);">{{ s.subject.name }}</td>
              <td>
                <span class="sh-badge {% if s.q_total > 50 %}green{% elif s.q_total > 10 %}amber{% else %}red{% endif %}">
                  {{ s.q_total }}
                </span>
              </td>
              <td style="color:var(--gray-500);">{{ s.topics_total }}</td>
              <td>
                {% if s.empty_count > 0 %}
                <span class="sh-badge red">{{ s.empty_count }} bo'sh</span>
                {% else %}
                <span style="color:var(--gray-300);font-size:0.75rem;">‚Äî</span>
                {% endif %}
              </td>
            </tr>
            {% if s.empty_topics %}
            <tr>
              <td colspan="4" style="padding-top:0;padding-bottom:0.5rem;">
                <div class="sh-empty-topics">
                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                  Bo'sh mavzular:
                  {% for t in s.empty_topics|slice:":6" %}
                  <span>{{ t }}</span>
                  {% endfor %}
                  {% if s.empty_topics|length > 6 %}
                  <span style="color:var(--gray-400);">+{{ s.empty_topics|length|add:"-6" }} ta</span>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endif %}
            {% empty %}
            <tr><td colspan="4" style="color:var(--gray-400);text-align:center;">Ma'lumot yo'q</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 7-day test chart -->
    <div class="sh-card">
      <div class="sh-card-title"><i class="bi bi-graph-up" style="color:var(--primary);"></i> So'nggi 7 kun testlar</div>
      <div class="sh-chart-wrap">
        <canvas id="weekChart"></canvas>
      </div>
      <div style="margin-top:1rem;">
        <a href="{% url 'core:admin_broadcast' %}" class="btn btn-sm w-100" style="background:var(--gradient-primary);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:0.82rem;">
          <i class="bi bi-broadcast me-1"></i> Broadcast Notification
        </a>
        <a href="{% url 'tests_app:manage_bulk_import' %}" class="btn btn-sm w-100 mt-2" style="background:var(--gray-100);color:var(--dark-600);border:1px solid var(--gray-200);border-radius:8px;font-weight:700;font-size:0.82rem;">
          <i class="bi bi-cloud-upload me-1"></i> Bulk Savol Import
        </a>
      </div>
    </div>
  </div>

</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
var wLabels = {{ week_labels|safe }};
var wCounts = {{ week_counts|safe }};

new Chart(document.getElementById('weekChart'), {
  type: 'bar',
  data: {
    labels: wLabels,
    datasets: [{
      data: wCounts,
      backgroundColor: 'rgba(139,197,64,0.25)',
      borderColor: '#8BC540',
      borderWidth: 2,
      borderRadius: 6,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { display: false }, ticks: { font: { size: 11 } } },
      y: { grid: { color: '#F1F5F9' }, ticks: { font: { size: 11 }, stepSize: 1 }, beginAtZero: true }
    }
  }
});
</script>
{% endblock %}
