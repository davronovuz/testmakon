{% extends 'base.html' %}
{% load static %}

{% block title %}Bildirishnomalar | TestMakon{% endblock %}

{% block extra_css %}
<style>
.notif-page { max-width: 720px; margin: 0 auto; padding: 2rem 1rem; }

/* Header */
.notif-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:0.75rem; }
.notif-title { font-size:1.3rem; font-weight:900; color:var(--dark); margin:0; }
.notif-header-actions { display:flex; gap:0.5rem; }
.notif-btn { display:inline-flex; align-items:center; gap:0.35rem; padding:0.45rem 0.9rem; font-size:0.8rem; font-weight:700; border-radius:8px; border:1px solid var(--gray-200); background:var(--white); color:var(--dark-600); text-decoration:none; cursor:pointer; transition:all 0.15s; }
.notif-btn:hover { border-color:var(--primary); color:var(--primary-dark); background:rgba(139,197,64,0.06); }
.notif-btn-primary { background:var(--gradient-primary); color:#fff; border-color:transparent; }
.notif-btn-primary:hover { color:#fff; opacity:0.92; }

/* Filter tabs */
.notif-tabs { display:flex; gap:0.35rem; margin-bottom:1.25rem; flex-wrap:wrap; }
.notif-tab { display:inline-flex; align-items:center; gap:0.3rem; padding:0.35rem 0.8rem; font-size:0.78rem; font-weight:700; border-radius:999px; border:1px solid var(--gray-200); background:var(--white); color:var(--gray-500); cursor:pointer; transition:all 0.15s; }
.notif-tab:hover { border-color:var(--gray-300); color:var(--dark-600); }
.notif-tab.active { background:var(--dark); color:#fff; border-color:var(--dark); }
.notif-tab .cnt { font-size:0.68rem; background:rgba(255,255,255,0.25); border-radius:999px; padding:0.05rem 0.4rem; }
.notif-tab:not(.active) .cnt { background:var(--gray-100); color:var(--gray-500); }

/* Date group label */
.notif-group-label { font-size:0.72rem; font-weight:800; color:var(--gray-400); text-transform:uppercase; letter-spacing:0.5px; margin:1.25rem 0 0.5rem; padding:0 0.25rem; }
.notif-group-label:first-of-type { margin-top:0; }

/* Notification card */
.notif-card {
    background:var(--white);
    border:1px solid var(--gray-200);
    border-radius:12px;
    padding:0.85rem 1rem;
    display:flex;
    align-items:flex-start;
    gap:0.85rem;
    transition:all 0.15s;
    position:relative;
    margin-bottom:0.4rem;
    cursor:pointer;
    text-decoration:none;
    color:inherit;
}
.notif-card:hover { border-color:var(--gray-300); box-shadow:0 2px 8px rgba(0,0,0,0.06); }
.notif-card.unread { border-left:3px solid var(--primary); background:rgba(139,197,64,0.04); }
.notif-card.dismissed { display:none; }

/* Icon */
.notif-icon { width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1rem; flex-shrink:0; }
.notif-icon.ic-system   { background:rgba(100,116,139,0.12); color:#475569; }
.notif-icon.ic-news     { background:rgba(59,130,246,0.12);  color:#2563EB; }
.notif-icon.ic-competition { background:rgba(245,158,11,0.12); color:#D97706; }
.notif-icon.ic-battle   { background:rgba(139,92,246,0.12);  color:#7C3AED; }
.notif-icon.ic-achievement { background:rgba(34,197,94,0.12); color:#16A34A; }
.notif-icon.ic-friend   { background:rgba(14,165,233,0.12);  color:#0284C7; }
.notif-icon.ic-reminder { background:rgba(239,68,68,0.12);   color:#DC2626; }

/* Content */
.notif-body { flex:1; min-width:0; }
.notif-card-title { font-size:0.88rem; font-weight:700; color:var(--dark); margin-bottom:0.2rem; line-height:1.3; }
.notif-card-msg { font-size:0.78rem; color:var(--gray-500); line-height:1.45; margin:0; }
.notif-meta { display:flex; align-items:center; gap:0.5rem; margin-top:0.3rem; }
.notif-time { font-size:0.68rem; color:var(--gray-400); font-weight:500; }
.notif-unread-dot { width:7px; height:7px; background:var(--primary); border-radius:50%; flex-shrink:0; }

/* Dismiss btn */
.notif-dismiss {
    width:28px; height:28px; border-radius:7px; border:none; background:transparent;
    color:var(--gray-300); cursor:pointer; display:flex; align-items:center; justify-content:center;
    font-size:0.8rem; flex-shrink:0; transition:all 0.15s; margin-top:2px;
}
.notif-dismiss:hover { background:rgba(239,68,68,0.1); color:#DC2626; }

/* Empty */
.notif-empty { text-align:center; padding:4rem 2rem; background:var(--white); border:1px solid var(--gray-200); border-radius:14px; }
.notif-empty-icon { font-size:2.5rem; margin-bottom:1rem; opacity:0.4; }
.notif-empty h4 { font-size:1rem; font-weight:800; color:var(--dark); margin-bottom:0.35rem; }
.notif-empty p { font-size:0.83rem; color:var(--gray-500); margin:0; }

@media (max-width: 576px) {
    .notif-page { padding: 1rem 0.75rem; }
    .notif-title { font-size: 1.1rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-vh-100" style="background:var(--gray-50);">
<div class="notif-page">

    <!-- Header -->
    <div class="notif-header">
        <h1 class="notif-title"><i class="bi bi-bell-fill me-2" style="color:var(--primary);font-size:1.1rem;"></i>Bildirishnomalar</h1>
        <div class="notif-header-actions">
            {% if notifications %}
            <a href="{% url 'news:notifications_mark_all_read' %}" class="notif-btn">
                <i class="bi bi-check-all"></i> Barchasini o'qildi
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filter tabs -->
    <div class="notif-tabs" id="notifTabs">
        <button class="notif-tab active" data-filter="all" onclick="filterNotifs(this, 'all')">
            Barchasi <span class="cnt">{{ notifications|length }}</span>
        </button>
        <button class="notif-tab" data-filter="achievement" onclick="filterNotifs(this, 'achievement')">
            <i class="bi bi-star-fill"></i> Yutuqlar
        </button>
        <button class="notif-tab" data-filter="reminder" onclick="filterNotifs(this, 'reminder')">
            <i class="bi bi-bell-fill"></i> Eslatmalar
        </button>
        <button class="notif-tab" data-filter="system" onclick="filterNotifs(this, 'system')">
            <i class="bi bi-gear-fill"></i> Tizim
        </button>
        <button class="notif-tab" data-filter="competition" onclick="filterNotifs(this, 'competition')">
            <i class="bi bi-trophy-fill"></i> Musobaqa
        </button>
    </div>

    <!-- Notifications list -->
    <div id="notifList">
        {% if notifications %}

        {# Group by date #}
        {% regroup notifications by created_at|date:"Y-m-d" as day_groups %}
        {% for group in day_groups %}
            {% with day=group.grouper %}
            <div class="notif-group-label" data-date="{{ day }}">
                {% now "Y-m-d" as today_str %}
                {% if day == today_str %}
                    Bugun
                {% else %}
                    {{ group.list.0.created_at|date:"d F Y" }}
                {% endif %}
            </div>
            {% endwith %}

            {% for notif in group.list %}
            <div class="notif-card {% if not notif.is_read %}unread{% endif %}" id="notif-{{ notif.id }}"
                 data-type="{{ notif.notification_type }}"
                 onclick="markAndGo({{ notif.id }}, '{{ notif.link|default:'' }}', '{% url "news:notification_mark_read" id=notif.id %}')">

                <div class="notif-icon ic-{{ notif.notification_type }}">
                    {% if notif.notification_type == 'system' %}<i class="bi bi-gear-fill"></i>
                    {% elif notif.notification_type == 'news' %}<i class="bi bi-newspaper"></i>
                    {% elif notif.notification_type == 'competition' %}<i class="bi bi-trophy-fill"></i>
                    {% elif notif.notification_type == 'battle' %}<i class="bi bi-lightning-charge-fill"></i>
                    {% elif notif.notification_type == 'achievement' %}<i class="bi bi-star-fill"></i>
                    {% elif notif.notification_type == 'friend' %}<i class="bi bi-person-plus-fill"></i>
                    {% elif notif.notification_type == 'reminder' %}<i class="bi bi-bell-fill"></i>
                    {% else %}<i class="bi bi-bell-fill"></i>{% endif %}
                </div>

                <div class="notif-body">
                    <div class="notif-card-title">{{ notif.title }}</div>
                    <p class="notif-card-msg">{{ notif.message }}</p>
                    <div class="notif-meta">
                        {% if not notif.is_read %}<span class="notif-unread-dot"></span>{% endif %}
                        <span class="notif-time">{{ notif.created_at|timesince }} oldin</span>
                    </div>
                </div>

                <button class="notif-dismiss" title="O'chirish"
                        onclick="dismissNotif(event, {{ notif.id }}, '{% url "news:notification_dismiss" id=notif.id %}')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            {% endfor %}
        {% endfor %}

        {% else %}
        <div class="notif-empty">
            <div class="notif-empty-icon"><i class="bi bi-bell-slash"></i></div>
            <h4>Bildirishnomalar yo'q</h4>
            <p>Sizda hozircha yangi xabarlar yo'q.</p>
        </div>
        {% endif %}
    </div>

</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterNotifs(btn, type) {
    document.querySelectorAll('.notif-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.notif-card').forEach(card => {
        if (type === 'all' || card.dataset.type === type) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
    // Hide empty group labels
    document.querySelectorAll('.notif-group-label').forEach(label => {
        // Check if any visible card follows this label (until next label)
        let el = label.nextElementSibling;
        let hasVisible = false;
        while (el && !el.classList.contains('notif-group-label')) {
            if (el.classList.contains('notif-card') && el.style.display !== 'none') {
                hasVisible = true;
                break;
            }
            el = el.nextElementSibling;
        }
        label.style.display = hasVisible ? '' : 'none';
    });
}

function markAndGo(id, link, markUrl) {
    fetch(markUrl, {method:'GET'}).catch(()=>{});
    const card = document.getElementById('notif-' + id);
    if (card) card.classList.remove('unread');
    if (link) window.location.href = link;
}

function dismissNotif(event, id, url) {
    event.stopPropagation();
    fetch(url, {
        method:'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    }).then(() => {
        const card = document.getElementById('notif-' + id);
        if (card) {
            card.style.transition = 'opacity 0.2s, transform 0.2s';
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => { card.remove(); }, 220);
        }
    });
}
</script>
{% endblock %}
