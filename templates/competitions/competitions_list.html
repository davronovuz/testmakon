{% extends 'base.html' %}
{% load static %}

{% block title %}Musobaqalar | TestMakon{% endblock %}

{% block extra_css %}
<style>
/* ===== LAYOUT ===== */
.comp-layout {
    display: grid;
    grid-template-columns: 272px 1fr;
    gap: 1.5rem;
    align-items: start;
    padding: 2rem 0 3rem;
}

/* ===== SIDEBAR ===== */
.comp-sidebar {
    position: sticky;
    top: 80px;
    background: #fff;
    border: 1px solid #E5E7EB;
    border-radius: 16px;
    overflow: hidden;
}

.csb-user-card {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, #8BC540, #6BA832);
}

.csb-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    overflow: hidden;
    flex-shrink: 0;
}

.csb-avatar img { width: 100%; height: 100%; object-fit: cover; }

.csb-user-name {
    font-weight: 700;
    color: white;
    font-size: 0.95rem;
}

.csb-user-xp {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.85);
}

.csb-nav {
    padding: 0.75rem 0;
}

.csb-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    text-decoration: none;
    color: #374151;
    font-size: 0.92rem;
    font-weight: 500;
    transition: all 0.2s;
    position: relative;
}

.csb-link:hover {
    background: #F9FAFB;
    color: #8BC540;
}

.csb-link.active {
    background: #F0F9E8;
    color: #8BC540;
    font-weight: 700;
}

.csb-link.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: #8BC540;
    border-radius: 0 2px 2px 0;
}

.csb-icon { font-size: 1.1rem; width: 22px; text-align: center; }

.csb-badge {
    margin-left: auto;
    background: #8BC540;
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.15rem 0.5rem;
    border-radius: 50px;
}

.csb-battle-btn {
    padding: 1rem 1.25rem;
    border-top: 1px solid #F3F4F6;
}

.csb-battle-link {
    display: block;
    text-align: center;
    background: linear-gradient(135deg, #8BC540, #6BA832);
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    padding: 0.7rem 1rem;
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.2s;
}

.csb-battle-link:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(139,197,64,0.35);
    color: white;
}

/* ===== MAIN CONTENT ===== */
.comp-section { margin-bottom: 2rem; }

.section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 800;
    color: #0F172A;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.section-link {
    font-size: 0.85rem;
    font-weight: 600;
    color: #8BC540;
    text-decoration: none;
}

/* ===== DAILY CHALLENGE ===== */
.daily-card {
    background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
    border-radius: 14px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
}

.daily-left h3 {
    font-size: 1.1rem;
    font-weight: 800;
    color: white;
    margin: 0 0 0.3rem;
}

.daily-left p {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.85);
    margin: 0 0 0.75rem;
}

.daily-meta {
    display: flex;
    gap: 1.5rem;
}

.daily-meta-item strong {
    display: block;
    font-size: 1.1rem;
    font-weight: 800;
    color: white;
}

.daily-meta-item span {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.75);
}

.daily-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.3rem 0.75rem;
    border-radius: 50px;
    margin-bottom: 0.65rem;
}

.daily-btn {
    padding: 0.7rem 1.5rem;
    border-radius: 10px;
    font-size: 0.88rem;
    font-weight: 700;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    flex-shrink: 0;
    transition: all 0.2s;
}

.daily-btn.start { background: white; color: #6D28D9; }
.daily-btn.start:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); color: #6D28D9; }
.daily-btn.done { background: rgba(255,255,255,0.2); color: white; }

/* ===== COMPETITION CARDS ===== */
.comp-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.comp-grid.single { grid-template-columns: 1fr; }

.c-card {
    background: #fff;
    border: 1px solid #E5E7EB;
    border-radius: 14px;
    padding: 1.15rem;
    display: flex;
    gap: 0.85rem;
    text-decoration: none;
    transition: all 0.2s;
}

.c-card:hover {
    border-color: #8BC540;
    box-shadow: 0 6px 20px rgba(139,197,64,0.12);
    transform: translateY(-2px);
}

.c-icon {
    width: 48px;
    height: 48px;
    background: #F9FAFB;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    flex-shrink: 0;
}

.c-info { flex: 1; min-width: 0; }

.c-title {
    font-size: 0.92rem;
    font-weight: 700;
    color: #0F172A;
    margin: 0 0 0.3rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.c-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.78rem;
    color: #6B7280;
    margin-bottom: 0.4rem;
}

.c-meta i { color: #8BC540; font-size: 0.8rem; }

.c-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.55rem;
    border-radius: 50px;
    display: inline-block;
}

.c-badge.active { background: #D1FAE5; color: #059669; }
.c-badge.upcoming { background: #DBEAFE; color: #2563EB; }
.c-badge.finished { background: #F3F4F6; color: #6B7280; }

/* ===== EMPTY ===== */
.empty-block {
    text-align: center;
    padding: 2.5rem;
    background: #F9FAFB;
    border-radius: 14px;
    border: 1px dashed #E5E7EB;
}

.empty-block p { color: #6B7280; margin: 0; font-size: 0.9rem; }

/* ===== RESPONSIVE ===== */
@media (max-width: 991px) {
    .comp-layout { grid-template-columns: 1fr; }
    .comp-sidebar { position: static; }
    .csb-nav { display: flex; flex-wrap: wrap; padding: 0.5rem; gap: 0.25rem; }
    .csb-link { border-radius: 8px; padding: 0.5rem 0.85rem; }
    .csb-user-card { border-radius: 0; }
    .csb-battle-btn { display: none; }
    .comp-grid { grid-template-columns: 1fr; }
}

@media (max-width: 576px) {
    .daily-card { flex-direction: column; }
    .daily-btn { width: 100%; justify-content: center; }
}
</style>
{% endblock %}

{% block content %}
<div style="background: #F8FAFC; min-height: 100vh;">
    <div class="container">
        <div class="comp-layout">

            <!-- ===== SIDEBAR ===== -->
            {% include 'competitions/_sidebar.html' with active='competitions_list' %}

            <!-- ===== MAIN CONTENT ===== -->
            <div>
                <!-- Page Header -->
                <div style="margin-bottom: 1.5rem;">
                    <h1 style="font-size: 1.5rem; font-weight: 800; color: #0F172A; margin: 0 0 0.25rem;">
                        üèÜ Musobaqalar
                    </h1>
                    <p style="color: #6B7280; font-size: 0.9rem; margin: 0;">
                        Qatnashing, g'alaba qozoning va sovrinlar yuting
                    </p>
                </div>

                <!-- Daily Challenge -->
                {% if daily_challenge %}
                <div class="comp-section">
                    <div class="daily-card">
                        <div class="daily-left">
                            <div class="daily-tag">
                                <i class="bi bi-calendar-check-fill"></i> Bugungi challenge
                            </div>
                            <h3>{{ daily_challenge.subject.name|default:"Umumiy" }} ‚Äî {{ daily_challenge.question_count }} savol</h3>
                            <p>{{ daily_challenge.time_limit }} daqiqa ‚Ä¢ +{{ daily_challenge.xp_reward }} XP</p>
                            <div class="daily-meta">
                                <div class="daily-meta-item">
                                    <strong>{{ daily_challenge.participants_count }}</strong>
                                    <span>qatnashdi</span>
                                </div>
                                <div class="daily-meta-item">
                                    <strong>+{{ daily_challenge.xp_reward }}</strong>
                                    <span>XP</span>
                                </div>
                            </div>
                        </div>
                        {% if daily_completed %}
                        <span class="daily-btn done">
                            <i class="bi bi-check-circle-fill"></i> Bajarildi ‚úì
                        </span>
                        {% elif user.is_authenticated %}
                        <a href="{% url 'competitions:daily_challenge_start' %}" class="daily-btn start">
                            <i class="bi bi-play-fill"></i> Boshlash
                        </a>
                        {% else %}
                        <a href="{% url 'accounts:login' %}" class="daily-btn start">
                            <i class="bi bi-box-arrow-in-right"></i> Kirish
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Featured / Active -->
                {% if featured or active %}
                <div class="comp-section">
                    <div class="section-head">
                        <h2 class="section-title">
                            <i class="bi bi-play-circle-fill" style="color:#8BC540;"></i>
                            Faol musobaqalar
                        </h2>
                    </div>
                    <div class="comp-grid">
                        {% for comp in featured %}
                        <a href="{% url 'competitions:competition_detail' slug=comp.slug %}" class="c-card">
                            <div class="c-icon">{{ comp.icon }}</div>
                            <div class="c-info">
                                <div class="c-title">{{ comp.title }}</div>
                                <div class="c-meta">
                                    <span><i class="bi bi-people-fill"></i> {{ comp.participants_count }}</span>
                                    <span><i class="bi bi-clock"></i> {{ comp.duration_minutes }} daq</span>
                                    <span><i class="bi bi-journal-text"></i> {{ comp.total_questions }} savol</span>
                                </div>
                                <span class="c-badge active">üü¢ Faol</span>
                            </div>
                        </a>
                        {% endfor %}
                        {% for comp in active %}
                        <a href="{% url 'competitions:competition_detail' slug=comp.slug %}" class="c-card">
                            <div class="c-icon">{{ comp.icon }}</div>
                            <div class="c-info">
                                <div class="c-title">{{ comp.title }}</div>
                                <div class="c-meta">
                                    <span><i class="bi bi-people-fill"></i> {{ comp.participants_count }}</span>
                                    <span><i class="bi bi-clock"></i> {{ comp.duration_minutes }} daq</span>
                                </div>
                                <span class="c-badge active">üü¢ Faol</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Registration Open -->
                {% if registration_open %}
                <div class="comp-section">
                    <div class="section-head">
                        <h2 class="section-title">
                            <i class="bi bi-calendar-event-fill" style="color:#8BC540;"></i>
                            Ro'yxatga olish ochiq
                        </h2>
                    </div>
                    <div class="comp-grid">
                        {% for comp in registration_open %}
                        <a href="{% url 'competitions:competition_detail' slug=comp.slug %}" class="c-card">
                            <div class="c-icon">{{ comp.icon }}</div>
                            <div class="c-info">
                                <div class="c-title">{{ comp.title }}</div>
                                <div class="c-meta">
                                    <span><i class="bi bi-people-fill"></i> {{ comp.participants_count }}</span>
                                    <span><i class="bi bi-calendar3"></i> {{ comp.start_time|date:"d M, H:i" }}</span>
                                </div>
                                <span class="c-badge upcoming">üìÖ {{ comp.start_time|timeuntil }} qoldi</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- User Battles -->
                {% if user_battles %}
                <div class="comp-section">
                    <div class="section-head">
                        <h2 class="section-title">
                            <i class="bi bi-lightning-fill" style="color:#8BC540;"></i>
                            Sizning janglaringiz
                        </h2>
                        <a href="{% url 'competitions:battles_list' %}" class="section-link">
                            Barchasi ‚Üí
                        </a>
                    </div>
                    <div class="comp-grid">
                        {% for battle in user_battles|slice:":4" %}
                        <a href="{% url 'competitions:battle_detail' uuid=battle.uuid %}" class="c-card">
                            <div class="c-icon">‚ö°</div>
                            <div class="c-info">
                                <div class="c-title">
                                    {% if battle.subject %}{{ battle.subject.name }}{% else %}Umumiy{% endif %}
                                </div>
                                <div class="c-meta">
                                    <span>
                                        {% if battle.opponent_type == 'bot' %}ü§ñ Bot
                                        {% elif battle.opponent %}{{ battle.opponent.first_name|default:"Raqib" }}
                                        {% else %}Kutilmoqda{% endif %}
                                    </span>
                                </div>
                                <span class="c-badge {% if battle.status == 'in_progress' %}active{% elif battle.status == 'pending' %}upcoming{% else %}finished{% endif %}">
                                    {% if battle.status == 'pending' %}‚è≥ Kutilmoqda
                                    {% elif battle.status == 'in_progress' %}üéÆ Davom etmoqda
                                    {% else %}‚úÖ Yakunlangan{% endif %}
                                </span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Empty State -->
                {% if not featured and not active and not registration_open and not daily_challenge %}
                <div class="empty-block">
                    <div style="font-size: 3rem; margin-bottom: 0.75rem;">üèÜ</div>
                    <h4 style="font-weight: 700; margin: 0 0 0.4rem;">Hozircha musobaqalar yo'q</h4>
                    <p>Tez orada yangi musobaqalar e'lon qilinadi.</p>
                    {% if user.is_authenticated %}
                    <a href="{% url 'competitions:battle_create' %}" class="btn btn-primary mt-3">
                        <i class="bi bi-lightning-fill me-1"></i> 1v1 Jang boshlash
                    </a>
                    {% endif %}
                </div>
                {% endif %}

            </div><!-- /main -->
        </div><!-- /layout -->
    </div>
</div>
{% endblock %}
