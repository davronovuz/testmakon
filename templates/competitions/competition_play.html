{% extends 'base.html' %}
{% load static %}

{% block title %}{{ competition.title }} | TestMakon{% endblock %}

{% block extra_css %}
<style>
    :root {
        --cp-bg: #F8FAFC;
        --cp-card-bg: #FFFFFF;
        --cp-border: #E2E8F0;
        --cp-primary: #8BC540; /* TestMakon Green */
        --cp-primary-dark: #65a30d;
        --cp-primary-soft: #F0FDF4;
        --cp-text: #0F172A;
        --cp-text-muted: #64748B;
        --cp-danger: #DC2626;
    }

    body { background: var(--cp-bg); padding-bottom: 80px; }

    /* ========== TOP BAR (STICKY) ========== */
    .cp-topbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 70px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--cp-border);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .cp-topbar-container {
        max-width: 1200px;
        margin: 0 auto;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
    }

    /* Left Info */
    .cp-info { display: flex; align-items: center; gap: 1rem; }
    .cp-title {
        font-weight: 800; font-size: 1.1rem; color: var(--cp-text);
        max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .cp-badge {
        background: var(--cp-primary-soft); color: var(--cp-primary-dark);
        padding: 0.3rem 0.8rem; border-radius: 50px; font-size: 0.8rem; font-weight: 700;
        border: 1px solid rgba(139, 197, 64, 0.2);
    }

    /* Timer */
    .cp-timer-box {
        position: absolute;
        left: 50%; top: 50%;
        transform: translate(-50%, -50%);
        background: var(--cp-text);
        color: white;
        padding: 0.4rem 1.2rem;
        border-radius: 12px;
        font-family: 'Monaco', monospace;
        font-weight: 700;
        font-size: 1.15rem;
        display: flex; align-items: center; gap: 0.6rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }

    .cp-timer-box.danger {
        background: var(--cp-danger);
        animation: pulse 1s infinite;
    }
    @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); } }

    /* Progress Line */
    .cp-progress-line {
        position: absolute; bottom: 0; left: 0; height: 3px;
        background: var(--cp-primary); transition: width 0.3s ease;
    }

    /* ========== LAYOUT ========== */
    .cp-container {
        max-width: 1200px;
        margin: 90px auto 0;
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        padding: 0 1rem;
    }

    /* ========== QUESTION CARDS ========== */
    .cp-q-list { display: flex; flex-direction: column; gap: 2rem; }

    .cp-card {
        background: var(--cp-card-bg);
        border: 1px solid var(--cp-border);
        border-radius: 20px;
        overflow: hidden;
        scroll-margin-top: 100px;
        transition: all 0.3s ease;
    }

    .cp-card.active-focus {
        border-color: var(--cp-primary);
        box-shadow: 0 10px 30px -5px rgba(139, 197, 64, 0.15);
    }

    .cp-card-header {
        padding: 1rem 1.5rem;
        background: #F8FAFC;
        border-bottom: 1px solid var(--cp-border);
        display: flex; justify-content: space-between; align-items: center;
    }

    .cp-q-number {
        background: var(--cp-text); color: white;
        width: 32px; height: 32px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; font-size: 0.9rem;
    }

    .cp-card-body { padding: 2rem; }

    .cp-text { font-size: 1.15rem; font-weight: 600; color: var(--cp-text); margin-bottom: 1.5rem; line-height: 1.6; }

    .cp-image {
        max-width: 100%; max-height: 400px; border-radius: 12px; margin-bottom: 1.5rem;
        border: 1px solid var(--cp-border); object-fit: contain;
    }

    /* Answers */
    .cp-answers { display: grid; gap: 0.75rem; }

    .cp-option {
        display: flex; align-items: center; gap: 1rem;
        padding: 1rem 1.25rem;
        border: 2px solid var(--cp-border);
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--cp-card-bg);
    }

    .cp-option:hover { background: var(--cp-primary-soft); border-color: #BEF264; }

    .cp-option.selected {
        background: var(--cp-primary-soft);
        border-color: var(--cp-primary);
        box-shadow: 0 0 0 4px rgba(139, 197, 64, 0.15);
    }

    .cp-opt-key {
        width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        background: var(--cp-bg); border-radius: 8px;
        font-weight: 700; color: var(--cp-text-muted);
        transition: all 0.2s;
    }

    .cp-option.selected .cp-opt-key {
        background: var(--cp-primary); color: white;
    }

    .cp-opt-text { font-weight: 500; color: var(--cp-text); font-size: 1rem; }

    /* ========== SIDEBAR (NAVIGATOR) ========== */
    .cp-sidebar { position: sticky; top: 90px; height: fit-content; }

    .cp-nav-card {
        background: var(--cp-card-bg);
        border: 1px solid var(--cp-border);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .cp-grid {
        display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
        margin: 1rem 0;
    }

    .cp-nav-btn {
        aspect-ratio: 1;
        border: 2px solid var(--cp-border);
        background: var(--cp-bg);
        border-radius: 10px;
        font-weight: 700; color: var(--cp-text-muted);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
    }

    .cp-nav-btn:hover { border-color: var(--cp-primary); color: var(--cp-primary); }
    .cp-nav-btn.answered { background: var(--cp-primary); color: white; border-color: var(--cp-primary); }

    .cp-submit-btn {
        width: 100%; padding: 1rem;
        background: linear-gradient(135deg, #8BC540 0%, #65a30d 100%);
        color: white; border: none; border-radius: 14px;
        font-weight: 800; font-size: 1rem;
        cursor: pointer; transition: transform 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }

    .cp-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(139, 197, 64, 0.4); }

    /* ========== MOBILE BOTTOM BAR ========== */
    .cp-mobile-bar {
        display: none;
        position: fixed; bottom: 0; left: 0; right: 0;
        background: white; border-top: 1px solid var(--cp-border);
        padding: 0.75rem 1.5rem;
        z-index: 999;
        justify-content: space-between; align-items: center;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }

    /* ========== ANTI-CHEAT ALERT ========== */
    .cp-cheat-overlay {
        position: fixed; inset: 0; z-index: 2000;
        background: rgba(220, 38, 38, 0.9);
        display: none; align-items: center; justify-content: center;
        text-align: center; color: white; padding: 2rem;
    }
    .cp-cheat-overlay.show { display: flex; animation: fadeIn 0.2s; }

    /* ========== MODAL ========== */
    .cp-modal-overlay {
        position: fixed; inset: 0; z-index: 2000;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(5px);
        display: none; align-items: center; justify-content: center;
    }
    .cp-modal-overlay.show { display: flex; animation: fadeIn 0.2s; }

    .cp-modal {
        background: white; width: 90%; max-width: 400px;
        padding: 2rem; border-radius: 24px;
        text-align: center;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Responsive */
    @media (max-width: 992px) {
        .cp-container { grid-template-columns: 1fr; margin-top: 80px; }
        .cp-sidebar { display: none; }
        .cp-mobile-bar { display: flex; }
        .cp-timer-box { position: relative; left: auto; top: auto; transform: none; font-size: 1rem; padding: 0.3rem 0.8rem; }
        .cp-title { display: none; }
    }
</style>
{% endblock %}

{% block content %}

<!-- 1. STICKY TOP BAR -->
<header class="cp-topbar">
    <div class="cp-topbar-container">
        <!-- Info -->
        <div class="cp-info">
            <span class="cp-badge">{{ competition.get_competition_type_display }}</span>
            <div class="cp-title">{{ competition.title }}</div>
        </div>

        <!-- Timer (Desktop Center) -->
        <div class="cp-timer-box" id="mainTimer">
            <i class="bi bi-stopwatch-fill"></i> <span id="timerText">00:00</span>
        </div>

        <!-- Submit (Desktop) -->
        <button class="btn btn-dark fw-bold rounded-pill px-4 d-none d-md-block" onclick="CompManager.confirmSubmit()">
            Yakunlash
        </button>
    </div>

    <!-- Progress Line -->
    <div class="cp-progress-line" id="progressLine" style="width: 0%"></div>
</header>

<!-- 2. MAIN CONTAINER -->
<div class="cp-container">

    <!-- QUESTIONS LIST -->
    <div class="cp-q-list">
        {% if questions_data %}
            {% for q in questions_data %}
            <div class="cp-card" id="q-card-{{ forloop.counter0 }}" data-qid="{{ q.id }}">
                <div class="cp-card-header">
                    <span class="cp-q-number">{{ forloop.counter }}</span>
                    <span class="text-muted small fw-bold d-none d-sm-block">{{ q.difficulty|default:"O'rta" }}</span>
                </div>
                <div class="cp-card-body">
                    <div class="cp-text">{{ q.text }}</div>

                    {% if q.image %}
                    <img src="{{ q.image }}" class="cp-image" alt="Savol rasmi">
                    {% endif %}

                    <div class="cp-answers">
                        {% for ans in q.answers %}
                        <div class="cp-option"
                             id="opt-{{ q.id }}-{{ ans.id }}"
                             onclick="CompManager.selectAnswer({{ forloop.parentloop.counter0 }}, {{ q.id }}, {{ ans.id }})">
                            <div class="cp-opt-key">
                                {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% else %}E{% endif %}
                            </div>
                            <div class="cp-opt-text">{{ ans.text }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-warning text-center">Savollar yuklanmadi.</div>
        {% endif %}
    </div>

    <!-- SIDEBAR NAVIGATOR (Desktop) -->
    <aside class="cp-sidebar">
        <div class="cp-nav-card">
            <h6 class="fw-bold mb-3 d-flex justify-content-between">
                <span>Savollar</span>
                <span class="text-primary"><span id="answeredCount">0</span>/{{ total_questions }}</span>
            </h6>

            <div class="cp-grid">
                {% for q in questions_data %}
                <div class="cp-nav-btn"
                     id="nav-btn-{{ forloop.counter0 }}"
                     onclick="CompManager.scrollTo({{ forloop.counter0 }})">
                    {{ forloop.counter }}
                </div>
                {% endfor %}
            </div>

            <hr class="my-4 text-muted opacity-25">

            <div class="d-flex justify-content-between small mb-3 text-muted fw-bold">
                <span>Javob berilgan</span>
                <span class="text-primary">‚óè</span>
            </div>

            <button class="cp-submit-btn" onclick="CompManager.confirmSubmit()">
                <i class="bi bi-flag-fill"></i> Testni Yakunlash
            </button>
        </div>
    </aside>

</div>

<!-- 3. MOBILE BOTTOM BAR -->
<div class="cp-mobile-bar d-flex d-lg-none">
    <div class="d-flex align-items-center gap-2">
        <i class="bi bi-check-circle-fill text-primary"></i>
        <span class="fw-bold"><span id="mobAnsweredCount">0</span>/{{ total_questions }}</span>
    </div>

    <button class="btn btn-primary fw-bold rounded-pill px-4" onclick="CompManager.confirmSubmit()">
        Yakunlash
    </button>
</div>

<!-- 4. MODAL -->
<div class="cp-modal-overlay" id="confirmModal">
    <div class="cp-modal">
        <div class="mb-3 text-primary display-1"><i class="bi bi-clipboard-check"></i></div>
        <h3 class="fw-bold mb-2">Ishonchingiz komilmi?</h3>
        <p class="text-muted mb-4">Testni yakunlagandan so'ng javoblarni o'zgartirib bo'lmaydi.</p>

        <div class="row g-2">
            <div class="col-6">
                <button class="btn btn-light w-100 py-2 fw-bold" onclick="CompManager.hideModal()">Qaytish</button>
            </div>
            <div class="col-6">
                <button class="btn btn-primary w-100 py-2 fw-bold" onclick="CompManager.submit()">Ha, Yakunlash</button>
            </div>
        </div>
    </div>
</div>

<!-- 5. ANTI-CHEAT OVERLAY -->
<div class="cp-cheat-overlay" id="cheatOverlay">
    <div>
        <div class="display-1 mb-3"><i class="bi bi-exclamation-triangle-fill"></i></div>
        <h2 class="fw-bold">DIQQAT! QOIDABUZARLIK!</h2>
        <p class="fs-5">Sahifadan chiqmang! Yana qaytarilsa test bekor qilinadi.</p>
        <div class="mt-3 fs-6 opacity-75">Qoidabuzarlik: <span id="violationCount">0</span>/3</div>
    </div>
</div>

<!-- 6. HIDDEN FORM -->
<form id="compForm" method="POST" action="{% url 'competitions:competition_submit' slug=competition.slug %}" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="answers" id="inputAnswers">
    <input type="hidden" name="time_spent" id="inputTime">
</form>

{% endblock %}

{% block extra_js %}
<script>
const CompManager = (function() {
    // Config
    const totalQuestions = {{ total_questions|default:0 }};
    const totalTime = parseInt("{{ remaining_time|default:3600 }}");
    const antiCheatEnabled = {{ anti_cheat|yesno:"true,false" }};
    const competitionId = {{ competition.id }};

    // State
    let timeLeft = totalTime;
    let userAnswers = {}; // { qId: ansId }
    let startTime = Date.now();
    let timerInterval;
    let violations = 0;
    let isSubmitted = false;

    // Elements
    const els = {
        timerText: document.getElementById('timerText'),
        timerBox: document.getElementById('mainTimer'),
        progress: document.getElementById('progressLine'),
        answered: document.getElementById('answeredCount'),
        mobAnswered: document.getElementById('mobAnsweredCount'),
        modal: document.getElementById('confirmModal'),
        cheatOverlay: document.getElementById('cheatOverlay'),
        violationCount: document.getElementById('violationCount')
    };

    // --- Init ---
    function init() {
        startTimer();
        window.addEventListener('beforeunload', handleBeforeUnload);
        if (antiCheatEnabled) initAntiCheat();
    }

    // --- Core Logic ---
    function selectAnswer(index, qId, ansId) {
        if(isSubmitted) return;

        // 1. Update State
        userAnswers[qId] = ansId;

        // 2. Update Question Card UI
        const card = document.getElementById(`q-card-${index}`);
        card.querySelectorAll('.cp-option').forEach(el => el.classList.remove('selected'));
        const opt = document.getElementById(`opt-${qId}-${ansId}`);
        if(opt) opt.classList.add('selected');

        // 3. Update Navigator UI
        const navBtn = document.getElementById(`nav-btn-${index}`);
        if(navBtn) navBtn.classList.add('answered');

        // 4. Update Stats
        updateStats();
    }

    function updateStats() {
        const count = Object.keys(userAnswers).length;
        els.answered.innerText = count;
        els.mobAnswered.innerText = count;
        els.progress.style.width = `${(count / totalQuestions) * 100}%`;
    }

    function scrollTo(index) {
        const card = document.getElementById(`q-card-${index}`);
        if(card) {
            const y = card.getBoundingClientRect().top + window.pageYOffset - 100;
            window.scrollTo({top: y, behavior: 'smooth'});

            // Focus effect
            document.querySelectorAll('.cp-card').forEach(c => c.classList.remove('active-focus'));
            card.classList.add('active-focus');
            setTimeout(() => card.classList.remove('active-focus'), 2000);
        }
    }

    // --- Timer ---
    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            const hours = Math.floor(timeLeft / 3600);
            const mins = Math.floor((timeLeft % 3600) / 60);
            const secs = timeLeft % 60;

            let timeStr = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            if(hours > 0) timeStr = `${String(hours).padStart(2,'0')}:${timeStr}`;

            els.timerText.innerText = timeStr;

            if(timeLeft <= 60) els.timerBox.classList.add('danger');

            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                submit(true); // Force submit
            }
        }, 1000);
    }

    // --- Submission ---
    function confirmSubmit() {
        if(isSubmitted) return;
        els.modal.classList.add('show');
    }

    function hideModal() {
        els.modal.classList.remove('show');
    }

    function submit(force = false) {
        if(isSubmitted) return;
        isSubmitted = true;

        // Disable warning
        window.removeEventListener('beforeunload', handleBeforeUnload);

        // Prepare Data
        const answersList = Object.keys(userAnswers).map(qId => ({
            question_id: parseInt(qId),
            answer_id: userAnswers[qId]
        }));

        const timeSpent = Math.floor((Date.now() - startTime) / 1000);

        document.getElementById('inputAnswers').value = JSON.stringify(answersList);
        document.getElementById('inputTime').value = timeSpent;

        // Submit Form
        const form = document.getElementById('compForm');
        form.submit();
    }

    function handleBeforeUnload(e) {
        e.preventDefault();
        e.returnValue = '';
    }

    // --- Anti-Cheat ---
    function initAntiCheat() {
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && !isSubmitted) {
                violations++;
                els.violationCount.innerText = violations;
                els.cheatOverlay.classList.add('show');

                // Log violation via API (Background)
                try {
                    fetch("{% url 'competitions:api_log_violation' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            competition_id: competitionId,
                            type: 'tab_switch',
                            details: `Violation #${violations}`
                        })
                    });
                } catch(e) {}

                if(violations >= 3) {
                    setTimeout(() => {
                        alert("Qoidabuzarliklar limiti tugadi. Test avtomatik yakunlanadi.");
                        submit(true);
                    }, 2000);
                } else {
                    setTimeout(() => {
                        els.cheatOverlay.classList.remove('show');
                    }, 3000);
                }
            }
        });

        // Disable copy/paste/context
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('copy', e => e.preventDefault());
        document.addEventListener('paste', e => e.preventDefault());
    }

    // Expose Public Methods
    return {
        init,
        selectAnswer,
        scrollTo,
        confirmSubmit,
        hideModal,
        submit
    };

})();

// Start
document.addEventListener('DOMContentLoaded', CompManager.init);
</script>
{% endblock %}