{% extends 'base.html' %}
{% load static %}

{% block title %}Natija - {{ competition.title }} | TestMakon{% endblock %}

{% block extra_css %}
<style>
    /* ========== RESULT HEADER ========== */
    .cr-header {
        padding: 3rem 0;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .cr-header.excellent {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    .cr-header.good {
        background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
    }

    .cr-header.average {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    }

    .cr-header.poor {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
    }

    .cr-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .cr-header-content {
        position: relative;
        z-index: 1;
    }

    .cr-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
    }

    .cr-result-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
        animation: bounceIn 0.6s ease;
    }

    @keyframes bounceIn {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }

    .cr-result-title {
        font-size: 2rem;
        color: white;
        margin-bottom: 0.5rem;
    }

    .cr-result-subtitle {
        font-size: 1.1rem;
        color: rgba(255,255,255,0.9);
        margin-bottom: 1.5rem;
    }

    /* Score Circle */
    .cr-score-circle {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        border: 4px solid rgba(255,255,255,0.5);
    }

    .cr-score-value {
        font-size: 3rem;
        font-weight: 800;
        color: white;
        line-height: 1;
    }

    .cr-score-label {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.9);
    }

    /* Stats Row */
    .cr-stats-row {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .cr-stat-item {
        text-align: center;
        padding: 1rem 1.5rem;
        background: rgba(255,255,255,0.15);
        border-radius: var(--radius-lg);
    }

    .cr-stat-value {
        font-size: 1.5rem;
        font-weight: 800;
        color: white;
    }

    .cr-stat-label {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.9);
    }

    /* ========== CONTENT ========== */
    .cr-content {
        padding: 2.5rem 0;
        background: var(--gray-100);
    }

    .cr-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
        max-width: 1100px;
        margin: 0 auto;
    }

    @media (max-width: 992px) {
        .cr-layout {
            grid-template-columns: 1fr;
        }
    }

    /* ========== CARD ========== */
    .cr-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .cr-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .cr-card-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .cr-card-title i {
        color: var(--primary);
    }

    .cr-card-body {
        padding: 1.5rem;
    }

    /* ========== RANK CARD ========== */
    .cr-rank-card {
        text-align: center;
        padding: 2rem;
    }

    .cr-rank-position {
        font-size: 4rem;
        margin-bottom: 0.5rem;
    }

    .cr-rank-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.25rem;
    }

    .cr-rank-total {
        font-size: 0.9rem;
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }

    .cr-rank-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 700;
    }

    .cr-rank-badge.gold {
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        color: #92400E;
        border: 1px solid #F59E0B;
    }

    .cr-rank-badge.silver {
        background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
        color: #374151;
        border: 1px solid #9CA3AF;
    }

    .cr-rank-badge.bronze {
        background: linear-gradient(135deg, #FED7AA 0%, #FDBA74 100%);
        color: #9A3412;
        border: 1px solid #F97316;
    }

    .cr-rank-badge.top10 {
        background: var(--primary-glow);
        color: var(--primary-dark);
        border: 1px solid var(--primary);
    }

    .cr-rank-badge.normal {
        background: var(--gray-100);
        color: var(--gray-600);
        border: 1px solid var(--gray-300);
    }

    /* ========== DETAILS ========== */
    .cr-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    @media (max-width: 500px) {
        .cr-details {
            grid-template-columns: 1fr;
        }
    }

    .cr-detail-item {
        padding: 1.25rem;
        background: var(--gray-50);
        border-radius: var(--radius);
        text-align: center;
    }

    .cr-detail-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .cr-detail-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.15rem;
    }

    .cr-detail-value.green { color: #10B981; }
    .cr-detail-value.red { color: #EF4444; }
    .cr-detail-value.blue { color: #3B82F6; }
    .cr-detail-value.purple { color: #8B5CF6; }

    .cr-detail-label {
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    /* ========== LEADERBOARD ========== */
    .cr-leaderboard {
        display: flex;
        flex-direction: column;
    }

    .cr-leader-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.875rem 1rem;
        border-radius: var(--radius);
        transition: all 0.2s;
    }

    .cr-leader-item:hover {
        background: var(--gray-50);
    }

    .cr-leader-item.top-1 {
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    }

    .cr-leader-item.top-2 {
        background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
    }

    .cr-leader-item.top-3 {
        background: linear-gradient(135deg, #FED7AA 0%, #FDBA74 100%);
    }

    .cr-leader-item.you {
        background: var(--primary-glow);
        border: 2px solid var(--primary);
    }

    .cr-leader-rank {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 700;
        flex-shrink: 0;
        background: var(--gray-200);
        color: var(--gray-600);
    }

    .cr-leader-item.top-1 .cr-leader-rank {
        background: #F59E0B;
        color: white;
    }

    .cr-leader-item.top-2 .cr-leader-rank {
        background: #9CA3AF;
        color: white;
    }

    .cr-leader-item.top-3 .cr-leader-rank {
        background: #F97316;
        color: white;
    }

    .cr-leader-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--dark-600);
        overflow: hidden;
        flex-shrink: 0;
    }

    .cr-leader-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .cr-leader-info {
        flex: 1;
        min-width: 0;
    }

    .cr-leader-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cr-leader-stats {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .cr-leader-score {
        font-size: 1rem;
        font-weight: 800;
        color: var(--dark);
    }

    /* ========== XP EARNED ========== */
    .cr-xp-card {
        background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        color: white;
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .cr-xp-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .cr-xp-value {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
    }

    .cr-xp-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    /* ========== ACTIONS ========== */
    .cr-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .cr-action-btn {
        padding: 1rem 1.5rem;
        border-radius: var(--radius-lg);
        font-size: 1rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s;
        cursor: pointer;
    }

    .cr-action-btn.primary {
        background: var(--gradient-primary);
        color: white;
        border: none;
    }

    .cr-action-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-primary);
        color: white;
    }

    .cr-action-btn.outline {
        background: var(--white);
        color: var(--dark-600);
        border: 2px solid var(--gray-300);
    }

    .cr-action-btn.outline:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    /* ========== CERTIFICATE ========== */
    .cr-certificate {
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        border: 2px solid #F59E0B;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
    }

    .cr-certificate-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
    }

    .cr-certificate-title {
        font-size: 1rem;
        font-weight: 700;
        color: #92400E;
        margin-bottom: 0.25rem;
    }

    .cr-certificate-desc {
        font-size: 0.85rem;
        color: #B45309;
        margin-bottom: 1rem;
    }

    .cr-certificate-btn {
        padding: 0.75rem 1.5rem;
        background: #F59E0B;
        color: white;
        border: none;
        border-radius: var(--radius);
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .cr-certificate-btn:hover {
        background: #D97706;
        color: white;
    }

    /* ========== SHARE ========== */
    .cr-share {
        text-align: center;
        padding: 1.5rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
    }

    .cr-share-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 1rem;
    }

    .cr-share-buttons {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
    }

    .cr-share-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
        transition: all 0.2s;
    }

    .cr-share-btn.telegram { background: #0088cc; }
    .cr-share-btn.copy { background: var(--gray-600); }

    .cr-share-btn:hover {
        transform: scale(1.1);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="cr-header {% if participant.percentage >= 80 %}excellent{% elif participant.percentage >= 60 %}good{% elif participant.percentage >= 40 %}average{% else %}poor{% endif %}">
    <div class="container">
        <div class="cr-header-content">
            <div class="cr-badge">
                <i class="bi bi-trophy"></i>
                {{ competition.title }}
            </div>

            <div class="cr-result-icon">
                {% if participant.percentage >= 80 %}üèÜ
                {% elif participant.percentage >= 60 %}üéØ
                {% elif participant.percentage >= 40 %}üìä
                {% else %}üìö{% endif %}
            </div>

            <h1 class="cr-result-title">
                {% if participant.percentage >= 80 %}Ajoyib natija!
                {% elif participant.percentage >= 60 %}Yaxshi natija!
                {% elif participant.percentage >= 40 %}O'rtacha natija
                {% else %}Mashq qiling!{% endif %}
            </h1>

            <p class="cr-result-subtitle">
                {% if participant.percentage >= 80 %}Siz juda zo'r ishladingiz!
                {% elif participant.percentage >= 60 %}Yaxshi harakat, davom eting!
                {% elif participant.percentage >= 40 %}Biroz ko'proq mashq qilish kerak
                {% else %}Ko'proq o'qish va mashq qilish tavsiya etiladi{% endif %}
            </p>

            <!-- Score Circle -->
            <div class="cr-score-circle">
                <div class="cr-score-value">{{ participant.percentage|floatformat:0 }}%</div>
                <div class="cr-score-label">Foiz</div>
            </div>

            <!-- Stats Row -->
            <div class="cr-stats-row">
                <div class="cr-stat-item">
                    <div class="cr-stat-value">{{ participant.correct_answers }}</div>
                    <div class="cr-stat-label">To'g'ri</div>
                </div>
                <div class="cr-stat-item">
                    <div class="cr-stat-value">{{ participant.wrong_answers }}</div>
                    <div class="cr-stat-label">Noto'g'ri</div>
                </div>
                <div class="cr-stat-item">
                    <div class="cr-stat-value">{{ participant.skipped_answers }}</div>
                    <div class="cr-stat-label">O'tkazilgan</div>
                </div>
                <div class="cr-stat-item">
                    <div class="cr-stat-value">{{ participant.score }}</div>
                    <div class="cr-stat-label">Ball</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content -->
<div class="cr-content">
    <div class="container">
        <div class="cr-layout">
            <!-- Main -->
            <div class="cr-main">
                <!-- Rank Card -->
                <div class="cr-card">
                    <div class="cr-card-body cr-rank-card">
                        <div class="cr-rank-position">
                            {% if participant.rank == 1 %}ü•á
                            {% elif participant.rank == 2 %}ü•à
                            {% elif participant.rank == 3 %}ü•â
                            {% elif participant.rank and participant.rank <= 10 %}üèÖ
                            {% else %}üéñÔ∏è{% endif %}
                        </div>
                        <div class="cr-rank-number">
                            {% if participant.rank %}#{{ participant.rank }}{% else %}‚Äî{% endif %}
                        </div>
                        <div class="cr-rank-total">
                            {{ leaderboard.count|default:competition.participants_count }} qatnashchi ichida
                        </div>
                        <span class="cr-rank-badge {% if participant.rank == 1 %}gold{% elif participant.rank == 2 %}silver{% elif participant.rank == 3 %}bronze{% elif participant.rank and participant.rank <= 10 %}top10{% else %}normal{% endif %}">
                            {% if participant.rank == 1 %}ü•á Birinchi o'rin
                            {% elif participant.rank == 2 %}ü•à Ikkinchi o'rin
                            {% elif participant.rank == 3 %}ü•â Uchinchi o'rin
                            {% elif participant.rank and participant.rank <= 10 %}üî• Top 10
                            {% else %}Qatnashchi{% endif %}
                        </span>
                    </div>
                </div>

                <!-- Details -->
                <div class="cr-card">
                    <div class="cr-card-header">
                        <h3 class="cr-card-title">
                            <i class="bi bi-bar-chart"></i>
                            Batafsil natijalar
                        </h3>
                    </div>
                    <div class="cr-card-body">
                        <div class="cr-details">
                            <div class="cr-detail-item">
                                <div class="cr-detail-icon">‚úÖ</div>
                                <div class="cr-detail-value green">{{ participant.correct_answers }}</div>
                                <div class="cr-detail-label">To'g'ri javoblar</div>
                            </div>
                            <div class="cr-detail-item">
                                <div class="cr-detail-icon">‚ùå</div>
                                <div class="cr-detail-value red">{{ participant.wrong_answers }}</div>
                                <div class="cr-detail-label">Noto'g'ri javoblar</div>
                            </div>
                            <div class="cr-detail-item">
                                <div class="cr-detail-icon">‚è±Ô∏è</div>
                                <div class="cr-detail-value blue">
                                    {% with mins=participant.time_spent|divisibleby:60 %}
                                    {{ participant.time_spent|floatformat:0 }}s
                                    {% endwith %}
                                </div>
                                <div class="cr-detail-label">Sarflangan vaqt</div>
                            </div>
                            <div class="cr-detail-item">
                                <div class="cr-detail-icon">üìä</div>
                                <div class="cr-detail-value purple">{{ participant.score }}</div>
                                <div class="cr-detail-label">Umumiy ball</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="cr-card">
                    <div class="cr-card-header">
                        <h3 class="cr-card-title">
                            <i class="bi bi-trophy"></i>
                            Reyting
                        </h3>
                        <a href="{% url 'competitions:competition_leaderboard' slug=competition.slug %}" style="font-size:0.85rem; color:var(--primary);">
                            To'liq ro'yxat <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                    <div class="cr-card-body" style="padding:0.5rem 1rem;">
                        <div class="cr-leaderboard">
                            {% for p in leaderboard %}
                            <div class="cr-leader-item {% if forloop.counter == 1 %}top-1{% elif forloop.counter == 2 %}top-2{% elif forloop.counter == 3 %}top-3{% endif %} {% if p.user == request.user %}you{% endif %}">
                                <div class="cr-leader-rank">
                                    {% if forloop.counter == 1 %}ü•á
                                    {% elif forloop.counter == 2 %}ü•à
                                    {% elif forloop.counter == 3 %}ü•â
                                    {% else %}{{ forloop.counter }}{% endif %}
                                </div>
                                <div class="cr-leader-avatar">
                                    {% if p.user.avatar %}
                                    <img src="{{ p.user.avatar.url }}" alt="">
                                    {% else %}
                                    {{ p.user.first_name|slice:":1" }}
                                    {% endif %}
                                </div>
                                <div class="cr-leader-info">
                                    <div class="cr-leader-name">
                                        {% if p.user == request.user %}Siz{% else %}{{ p.user.first_name }} {{ p.user.last_name|slice:":1" }}.{% endif %}
                                    </div>
                                    <div class="cr-leader-stats">
                                        {{ p.correct_answers }} to'g'ri ‚Ä¢ {{ p.time_spent }}s
                                    </div>
                                </div>
                                <div class="cr-leader-score">{{ p.score }}</div>
                            </div>
                            {% empty %}
                            <div style="text-align:center; padding:2rem; color:var(--gray-500);">
                                Ma'lumot yo'q
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="cr-sidebar">
                <!-- XP Earned -->
                <div class="cr-xp-card">
                    <div class="cr-xp-icon">‚ö°</div>
                    <div class="cr-xp-value">+{{ participant.xp_earned|default:0 }} XP</div>
                    <div class="cr-xp-label">Yutilgan tajriba</div>
                </div>

                <!-- Certificate (if available) -->
                {% if competition.certificate_enabled and participant.rank and participant.rank <= 10 %}
                <div class="cr-certificate">
                    <div class="cr-certificate-icon">üìú</div>
                    <div class="cr-certificate-title">Sertifikat tayyor!</div>
                    <div class="cr-certificate-desc">Yutuqingizni tasdiqlovchi sertifikat</div>
                    <a href="{% url 'competitions:my_certificates' %}" class="cr-certificate-btn">
                        <i class="bi bi-download"></i>
                        Yuklab olish
                    </a>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="cr-card">
                    <div class="cr-card-body">
                        <div class="cr-actions">
                            <a href="{% url 'competitions:competition_detail' slug=competition.slug %}" class="cr-action-btn outline">
                                <i class="bi bi-arrow-left"></i>
                                Musobaqaga qaytish
                            </a>
                            <a href="{% url 'competitions:competitions_list' %}" class="cr-action-btn primary">
                                <i class="bi bi-trophy"></i>
                                Boshqa musobaqalar
                            </a>
                            {% if competition.allow_review %}
                            <a href="#" class="cr-action-btn outline">
                                <i class="bi bi-eye"></i>
                                Javoblarni ko'rish
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Share -->
                <div class="cr-share">
                    <div class="cr-share-title">Natijani ulashing</div>
                    <div class="cr-share-buttons">
                        <a href="https://t.me/share/url?url={{ request.build_absolute_uri }}&text=Men TestMakon musobaqasida {{ participant.percentage|floatformat:0 }}% natija oldim! üèÜ" target="_blank" class="cr-share-btn telegram">
                            <i class="bi bi-telegram"></i>
                        </a>
                        <button class="cr-share-btn copy" onclick="copyResult()">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyResult() {
    const text = `Men TestMakon "${document.querySelector('.cr-badge').textContent.trim()}" musobaqasida {{ participant.percentage|floatformat:0 }}% natija oldim! üèÜ`;
    navigator.clipboard.writeText(text);
    alert('Natija nusxalandi!');
}
</script>
{% endblock %}