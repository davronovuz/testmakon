{% extends 'base.html' %}
{% load static %}

{% block title %}Jang | {{ battle.challenger.first_name }} vs {% if battle.opponent_type == 'bot' %}Bot{% else %}{{ battle.opponent.first_name }}{% endif %} | TestMakon{% endblock %}

{% block extra_css %}
<style>
    /* ========== RESET ========== */
    body {
        overflow-x: hidden;
    }

    /* ========== BATTLE HEADER ========== */
    .bp-header {
        background: var(--gradient-dark);
        padding: 1rem 0;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
    }

    .bp-header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    /* Players */
    .bp-players {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .bp-player {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .bp-player.right {
        flex-direction: row-reverse;
    }

    .bp-player-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--gray-600);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
        overflow: hidden;
        border: 2px solid var(--gray-500);
    }

    .bp-player-avatar.you {
        border-color: var(--primary);
    }

    .bp-player-avatar.bot {
        background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
    }

    .bp-player-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .bp-player-info {
        color: white;
    }

    .bp-player.right .bp-player-info {
        text-align: right;
    }

    .bp-player-name {
        font-size: 0.9rem;
        font-weight: 700;
    }

    .bp-player-score {
        font-size: 0.8rem;
        color: var(--gray-400);
    }

    .bp-player-score span {
        color: var(--primary);
        font-weight: 700;
    }

    /* VS */
    .bp-vs {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 1.5rem;
    }

    .bp-vs-text {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--gray-500);
    }

    .bp-vs-subject {
        font-size: 0.7rem;
        color: var(--gray-500);
    }

    /* Timer */
    .bp-timer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.1);
        border-radius: var(--radius);
        color: white;
    }

    .bp-timer i {
        color: var(--primary);
    }

    .bp-timer-value {
        font-size: 1.25rem;
        font-weight: 800;
        font-family: monospace;
    }

    .bp-timer.warning {
        background: rgba(245, 158, 11, 0.2);
    }

    .bp-timer.warning .bp-timer-value {
        color: #F59E0B;
    }

    .bp-timer.danger {
        background: rgba(239, 68, 68, 0.2);
        animation: pulse 1s infinite;
    }

    .bp-timer.danger .bp-timer-value {
        color: #EF4444;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* ========== MAIN CONTENT ========== */
    .bp-content {
        padding-top: 80px;
        min-height: 100vh;
        background: var(--gray-100);
    }

    .bp-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    /* ========== PROGRESS ========== */
    .bp-progress {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .bp-progress-text {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-600);
    }

    .bp-progress-text span {
        color: var(--primary);
    }

    .bp-progress-bar {
        flex: 1;
        height: 6px;
        background: var(--gray-300);
        border-radius: 3px;
        margin: 0 1rem;
        overflow: hidden;
    }

    .bp-progress-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .bp-progress-count {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    /* ========== QUESTION CARD ========== */
    .bp-question-card {
        background: var(--white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .bp-question-header {
        padding: 1rem 1.5rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .bp-question-number {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        color: var(--dark);
    }

    .bp-question-number-badge {
        width: 32px;
        height: 32px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .bp-question-timer {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        color: var(--gray-500);
    }

    .bp-question-timer i {
        color: var(--primary);
    }

    .bp-question-body {
        padding: 2rem;
    }

    .bp-question-text {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--dark);
        line-height: 1.7;
        margin-bottom: 0.5rem;
    }

    .bp-question-image {
        margin-top: 1rem;
        border-radius: var(--radius);
        overflow: hidden;
        max-width: 100%;
    }

    .bp-question-image img {
        width: 100%;
        height: auto;
    }

    /* ========== ANSWERS ========== */
    .bp-answers {
        padding: 0 2rem 2rem;
    }

    .bp-answer {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem 1.25rem;
        background: var(--gray-50);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .bp-answer:hover {
        border-color: var(--gray-300);
        background: var(--gray-100);
    }

    .bp-answer.selected {
        border-color: var(--primary);
        background: var(--primary-glow);
    }

    .bp-answer input {
        display: none;
    }

    .bp-answer-letter {
        width: 36px;
        height: 36px;
        background: var(--gray-200);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--dark-600);
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .bp-answer.selected .bp-answer-letter {
        background: var(--primary);
        color: white;
    }

    .bp-answer-text {
        flex: 1;
        font-size: 1rem;
        color: var(--dark-600);
        line-height: 1.6;
        padding-top: 0.35rem;
    }

    .bp-answer.selected .bp-answer-text {
        color: var(--dark);
        font-weight: 500;
    }

    /* ========== NAVIGATION ========== */
    .bp-navigation {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
    }

    .bp-nav-btn {
        padding: 1rem 2rem;
        border-radius: var(--radius-lg);
        font-size: 1rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
        cursor: pointer;
    }

    .bp-nav-btn.prev {
        background: var(--white);
        color: var(--dark-600);
        border: 2px solid var(--gray-300);
    }

    .bp-nav-btn.prev:hover {
        border-color: var(--gray-400);
    }

    .bp-nav-btn.prev:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .bp-nav-btn.next {
        background: var(--gradient-primary);
        color: white;
        border: none;
        flex: 1;
        justify-content: center;
    }

    .bp-nav-btn.next:hover {
        box-shadow: var(--shadow-primary);
    }

    .bp-nav-btn.finish {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    .bp-nav-btn.finish:hover {
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    /* ========== QUESTION DOTS ========== */
    .bp-dots {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .bp-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .bp-dot.unanswered {
        background: var(--gray-200);
        color: var(--gray-500);
    }

    .bp-dot.answered {
        background: var(--primary);
        color: white;
    }

    .bp-dot.current {
        border-color: var(--dark);
        transform: scale(1.1);
    }

    /* ========== FINISH MODAL ========== */
    .bp-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .bp-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .bp-modal {
        background: var(--white);
        border-radius: var(--radius-xl);
        width: 90%;
        max-width: 400px;
        padding: 2rem;
        text-align: center;
        transform: scale(0.9);
        transition: all 0.3s;
    }

    .bp-modal-overlay.active .bp-modal {
        transform: scale(1);
    }

    .bp-modal-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .bp-modal h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }

    .bp-modal p {
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }

    .bp-modal-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
    }

    .bp-modal-stat {
        text-align: center;
    }

    .bp-modal-stat-value {
        font-size: 1.5rem;
        font-weight: 800;
    }

    .bp-modal-stat-value.green { color: #10B981; }
    .bp-modal-stat-value.gray { color: var(--gray-400); }

    .bp-modal-stat-label {
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    .bp-modal-actions {
        display: flex;
        gap: 0.75rem;
    }

    .bp-modal-btn {
        flex: 1;
        padding: 0.875rem;
        border-radius: var(--radius);
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
    }

    .bp-modal-btn.cancel {
        background: var(--gray-100);
        color: var(--dark-600);
        border: none;
    }

    .bp-modal-btn.confirm {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
        border: none;
    }

    /* ========== KEYBOARD HINT ========== */
    .bp-keyboard-hint {
        text-align: center;
        font-size: 0.8rem;
        color: var(--gray-400);
        margin-top: 1rem;
    }

    .bp-keyboard-hint kbd {
        background: var(--gray-200);
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.75rem;
    }

    @media (max-width: 768px) {
        .bp-keyboard-hint {
            display: none;
        }

        .bp-players {
            display: none;
        }

        .bp-header-content {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="bp-header">
    <div class="container">
        <div class="bp-header-content">
            <!-- Players -->
            <div class="bp-players">
                <div class="bp-player">
                    <div class="bp-player-avatar {% if is_challenger %}you{% endif %}">
                        {% if battle.challenger.avatar %}
                        <img src="{{ battle.challenger.avatar.url }}" alt="">
                        {% else %}
                        {{ battle.challenger.first_name|slice:":1" }}
                        {% endif %}
                    </div>
                    <div class="bp-player-info">
                        <div class="bp-player-name">{% if is_challenger %}Siz{% else %}{{ battle.challenger.first_name }}{% endif %}</div>
                        <div class="bp-player-score">Ball: <span id="yourScore">0</span></div>
                    </div>
                </div>

                <div class="bp-vs">
                    <div class="bp-vs-text">VS</div>
                    {% if battle.subject %}
                    <div class="bp-vs-subject">{{ battle.subject.name }}</div>
                    {% endif %}
                </div>

                <div class="bp-player right">
                    <div class="bp-player-avatar {% if battle.opponent_type == 'bot' %}bot{% elif not is_challenger %}you{% endif %}">
                        {% if battle.opponent_type == 'bot' %}
                        ü§ñ
                        {% elif battle.opponent and battle.opponent.avatar %}
                        <img src="{{ battle.opponent.avatar.url }}" alt="">
                        {% else %}
                        {{ battle.opponent.first_name|slice:":1"|default:"?" }}
                        {% endif %}
                    </div>
                    <div class="bp-player-info">
                        <div class="bp-player-name">
                            {% if battle.opponent_type == 'bot' %}Bot ({{ battle.get_bot_difficulty_display }})
                            {% elif not is_challenger %}Siz
                            {% else %}{{ battle.opponent.first_name|default:"Raqib" }}{% endif %}
                        </div>
                        <div class="bp-player-score">Ball: <span>?</span></div>
                    </div>
                </div>
            </div>

            <!-- Timer -->
            <div class="bp-timer" id="mainTimer">
                <i class="bi bi-clock"></i>
                <span class="bp-timer-value" id="timerDisplay">{{ total_time }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Content -->
<div class="bp-content">
    <div class="bp-container">
        <!-- Progress -->
        <div class="bp-progress">
            <span class="bp-progress-text">Savol <span id="currentNum">1</span></span>
            <div class="bp-progress-bar">
                <div class="bp-progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <span class="bp-progress-count"><span id="answeredCount">0</span>/{{ questions|length }}</span>
        </div>

        <!-- Question Dots -->
        <div class="bp-dots" id="questionDots">
            {% for q in questions %}
            <div class="bp-dot unanswered {% if forloop.first %}current{% endif %}" data-index="{{ forloop.counter0 }}">
                {{ forloop.counter }}
            </div>
            {% endfor %}
        </div>

        <!-- Question Card -->
        <div class="bp-question-card">
            <div class="bp-question-header">
                <div class="bp-question-number">
                    <div class="bp-question-number-badge" id="questionBadge">1</div>
                    <span>Savol</span>
                </div>
            </div>

            <div class="bp-question-body">
                <div class="bp-question-text" id="questionText"></div>
                <div class="bp-question-image" id="questionImage" style="display:none;">
                    <img src="" alt="" id="questionImg">
                </div>
            </div>

            <div class="bp-answers" id="answersContainer">
                <!-- Answers will be inserted here -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="bp-navigation">
            <button class="bp-nav-btn prev" id="prevBtn" disabled>
                <i class="bi bi-arrow-left"></i>
                Oldingi
            </button>
            <button class="bp-nav-btn next" id="nextBtn">
                Keyingi
                <i class="bi bi-arrow-right"></i>
            </button>
        </div>

        <!-- Keyboard Hint -->
        <div class="bp-keyboard-hint">
            <kbd>1</kbd>-<kbd>4</kbd> javob tanlash ‚Ä¢ <kbd>‚Üê</kbd><kbd>‚Üí</kbd> navigatsiya ‚Ä¢ <kbd>Enter</kbd> keyingi
        </div>
    </div>
</div>

<!-- Finish Modal -->
<div class="bp-modal-overlay" id="finishModal">
    <div class="bp-modal">
        <div class="bp-modal-icon">‚öîÔ∏è</div>
        <h3>Jangni yakunlaysizmi?</h3>
        <p>Barcha javoblaringiz saqlanadi</p>

        <div class="bp-modal-stats">
            <div class="bp-modal-stat">
                <div class="bp-modal-stat-value green" id="modalAnswered">0</div>
                <div class="bp-modal-stat-label">Javob berilgan</div>
            </div>
            <div class="bp-modal-stat">
                <div class="bp-modal-stat-value gray" id="modalUnanswered">0</div>
                <div class="bp-modal-stat-label">Javobsiz</div>
            </div>
        </div>

        <div class="bp-modal-actions">
            <button class="bp-modal-btn cancel" id="modalCancel">Davom etish</button>
            <button class="bp-modal-btn confirm" id="modalConfirm">Yakunlash</button>
        </div>
    </div>
</div>

<!-- Hidden Form -->
<form id="submitForm" method="post" action="{% url 'competitions:battle_submit' uuid=battle.uuid %}" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="answers" id="answersInput">
    <input type="hidden" name="time_spent" id="timeSpentInput">
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Questions data from Django
    const questions = {{ questions|safe }};
    const totalTime = {{ total_time }};
    const totalQuestions = questions.length;

    // State
    let currentIndex = 0;
    let answers = {};
    let timeRemaining = totalTime;
    let timerInterval;
    let startTime = Date.now();

    // Elements
    const timerDisplay = document.getElementById('timerDisplay');
    const mainTimer = document.getElementById('mainTimer');
    const questionText = document.getElementById('questionText');
    const questionImage = document.getElementById('questionImage');
    const questionImg = document.getElementById('questionImg');
    const questionBadge = document.getElementById('questionBadge');
    const answersContainer = document.getElementById('answersContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const currentNum = document.getElementById('currentNum');
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('progressFill');
    const questionDots = document.getElementById('questionDots');
    const finishModal = document.getElementById('finishModal');
    const yourScore = document.getElementById('yourScore');

    // Initialize
    loadQuestion(0);
    startTimer();

    // Timer
    function startTimer() {
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                submitBattle();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Timer styling
        mainTimer.classList.remove('warning', 'danger');
        if (timeRemaining <= 30) {
            mainTimer.classList.add('danger');
        } else if (timeRemaining <= 60) {
            mainTimer.classList.add('warning');
        }
    }

    // Load question
    function loadQuestion(index) {
        const q = questions[index];
        currentIndex = index;

        // Update header
        questionBadge.textContent = index + 1;
        currentNum.textContent = index + 1;

        // Question text
        questionText.textContent = q.text;

        // Question image
        if (q.image) {
            questionImage.style.display = 'block';
            questionImg.src = q.image;
        } else {
            questionImage.style.display = 'none';
        }

        // Answers
        const letters = ['A', 'B', 'C', 'D'];
        answersContainer.innerHTML = q.answers.map((ans, i) => `
            <label class="bp-answer ${answers[q.id] === ans.id ? 'selected' : ''}" data-id="${ans.id}">
                <input type="radio" name="answer" value="${ans.id}" ${answers[q.id] === ans.id ? 'checked' : ''}>
                <div class="bp-answer-letter">${letters[i]}</div>
                <div class="bp-answer-text">${ans.text}</div>
            </label>
        `).join('');

        // Attach answer handlers
        document.querySelectorAll('.bp-answer').forEach(answer => {
            answer.addEventListener('click', function() {
                selectAnswer(q.id, parseInt(this.dataset.id));
            });
        });

        // Navigation buttons
        prevBtn.disabled = index === 0;

        if (index === totalQuestions - 1) {
            nextBtn.innerHTML = '<i class="bi bi-check-lg"></i> Yakunlash';
            nextBtn.classList.add('finish');
        } else {
            nextBtn.innerHTML = 'Keyingi <i class="bi bi-arrow-right"></i>';
            nextBtn.classList.remove('finish');
        }

        // Update dots
        updateDots();
        updateProgress();
    }

    // Select answer
    function selectAnswer(questionId, answerId) {
        answers[questionId] = answerId;

        // Update UI
        document.querySelectorAll('.bp-answer').forEach(a => a.classList.remove('selected'));
        document.querySelector(`.bp-answer[data-id="${answerId}"]`).classList.add('selected');

        // Update score display
        yourScore.textContent = Object.keys(answers).length * 10;

        updateDots();
        updateProgress();
    }

    // Update dots
    function updateDots() {
        document.querySelectorAll('.bp-dot').forEach((dot, i) => {
            dot.classList.remove('current', 'answered', 'unanswered');

            if (i === currentIndex) {
                dot.classList.add('current');
            }

            const qId = questions[i].id;
            if (answers[qId]) {
                dot.classList.add('answered');
            } else {
                dot.classList.add('unanswered');
            }
        });
    }

    // Update progress
    function updateProgress() {
        const answered = Object.keys(answers).length;
        answeredCount.textContent = answered;
        progressFill.style.width = `${(answered / totalQuestions) * 100}%`;
    }

    // Navigation
    prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
            loadQuestion(currentIndex - 1);
        }
    });

    nextBtn.addEventListener('click', () => {
        if (currentIndex < totalQuestions - 1) {
            loadQuestion(currentIndex + 1);
        } else {
            showFinishModal();
        }
    });

    // Dot navigation
    document.querySelectorAll('.bp-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            loadQuestion(parseInt(this.dataset.index));
        });
    });

    // Finish modal
    function showFinishModal() {
        const answered = Object.keys(answers).length;
        document.getElementById('modalAnswered').textContent = answered;
        document.getElementById('modalUnanswered').textContent = totalQuestions - answered;
        finishModal.classList.add('active');
    }

    document.getElementById('modalCancel').addEventListener('click', () => {
        finishModal.classList.remove('active');
    });

    document.getElementById('modalConfirm').addEventListener('click', submitBattle);

    // Submit battle
    function submitBattle() {
        clearInterval(timerInterval);

        const timeSpent = Math.floor((Date.now() - startTime) / 1000);
        const answersArray = Object.entries(answers).map(([qId, aId]) => ({
            question_id: parseInt(qId),
            answer_id: aId
        }));

        document.getElementById('answersInput').value = JSON.stringify(answersArray);
        document.getElementById('timeSpentInput').value = timeSpent;
        document.getElementById('submitForm').submit();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (finishModal.classList.contains('active')) return;

        const q = questions[currentIndex];

        switch(e.key) {
            case '1':
            case '2':
            case '3':
            case '4':
                const ansIndex = parseInt(e.key) - 1;
                if (q.answers[ansIndex]) {
                    selectAnswer(q.id, q.answers[ansIndex].id);
                }
                break;
            case 'ArrowLeft':
                if (currentIndex > 0) loadQuestion(currentIndex - 1);
                break;
            case 'ArrowRight':
            case 'Enter':
                if (currentIndex < totalQuestions - 1) {
                    loadQuestion(currentIndex + 1);
                } else {
                    showFinishModal();
                }
                break;
        }
    });
});
</script>
{% endblock %}