{% extends 'base.html' %}
{% load static %}

{% block title %}Jang ‚Äî {{ battle.subject.name|default:"Umumiy" }} | TestMakon{% endblock %}

{% block extra_css %}
<style>
    .bd-page { padding: 2rem 0 4rem; }

    .bd-bread {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }

    .bd-bread a { color: var(--primary); text-decoration: none; font-weight: 600; }
    .bd-bread a:hover { text-decoration: underline; }

    .bd-layout {
        max-width: 600px;
        margin: 0 auto;
    }

    /* ========== HERO ========== */
    .bd-hero {
        background: linear-gradient(135deg, #DC2626, #991B1B);
        border-radius: 20px;
        padding: 2.5rem 2rem;
        text-align: center;
        color: white;
        position: relative;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .bd-hero::after {
        content: '‚öîÔ∏è';
        position: absolute;
        right: -10px;
        bottom: -20px;
        font-size: 8rem;
        opacity: 0.06;
        pointer-events: none;
    }

    .bd-hero-inner { position: relative; z-index: 1; }

    .bd-hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.8rem;
        border-radius: 50px;
        font-size: 0.78rem;
        font-weight: 700;
        margin-bottom: 1.25rem;
    }

    .bd-hero-badge.waiting { background: rgba(255,255,255,0.2); }
    .bd-hero-badge.in_progress { background: rgba(16,185,129,0.3); }
    .bd-hero-badge.completed { background: rgba(255,255,255,0.2); }

    /* VS Section */
    .bd-vs {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.75rem;
        margin-bottom: 1.25rem;
    }

    .bd-vs-player { text-align: center; }

    .bd-vs-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 800;
        margin: 0 auto 0.5rem;
        background: rgba(255,255,255,0.15);
        border: 2px solid rgba(255,255,255,0.3);
    }

    .bd-vs-name {
        font-size: 0.95rem;
        font-weight: 700;
    }

    .bd-vs-label {
        font-size: 0.72rem;
        opacity: 0.7;
    }

    .bd-vs-text {
        font-size: 1.5rem;
        font-weight: 900;
        opacity: 0.4;
    }

    .bd-hero-subject {
        font-size: 0.92rem;
        opacity: 0.85;
        margin: 0;
    }

    /* ========== INFO CARD ========== */
    .bd-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
    }

    .bd-card h3 {
        font-size: 1rem;
        font-weight: 800;
        color: var(--dark);
        margin: 0 0 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bd-info-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .bd-info-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.7rem 0;
        font-size: 0.9rem;
    }

    .bd-info-list li + li { border-top: 1px solid var(--gray-100); }
    .bd-info-list li span:first-child { color: var(--gray-500); font-weight: 600; }
    .bd-info-list li span:last-child { color: var(--dark); font-weight: 700; }

    /* ========== ACTION BUTTONS ========== */
    .bd-actions {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
    }

    .bd-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.9rem;
        border-radius: 14px;
        font-size: 0.95rem;
        font-weight: 700;
        text-decoration: none;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .bd-btn.danger {
        background: linear-gradient(135deg, #DC2626, #B91C1C);
        color: white;
        box-shadow: 0 4px 14px -3px rgba(220,38,38,0.4);
    }

    .bd-btn.danger:hover { transform: translateY(-1px); color: white; }

    .bd-btn.success {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
    }

    .bd-btn.success:hover { transform: translateY(-1px); color: white; }

    .bd-btn.outline {
        background: transparent;
        border: 2px solid var(--gray-200);
        color: var(--dark);
    }

    .bd-btn.outline:hover { border-color: var(--gray-300); color: var(--dark); }

    .bd-btn.disabled {
        background: var(--gray-100);
        color: var(--gray-400);
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Decline btn */
    .bd-btn-sm {
        padding: 0.65rem 1.25rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        background: #FEE2E2;
        color: #DC2626;
    }

    .bd-btn-sm:hover { background: #FECACA; }

    /* Status message */
    .bd-status-msg {
        padding: 1rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        text-align: center;
        margin-bottom: 1.25rem;
    }

    .bd-status-msg.waiting { background: #FEF3C7; color: #D97706; }
    .bd-status-msg.your_turn { background: #D1FAE5; color: #059669; }
    .bd-status-msg.opponent_turn { background: #DBEAFE; color: #2563EB; }

    @media (max-width: 575px) {
        .bd-hero { padding: 1.75rem 1.25rem; }
        .bd-vs { gap: 1rem; }
        .bd-vs-avatar { width: 52px; height: 52px; font-size: 1.15rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="bd-page">
    <div class="container">

        <div class="bd-bread">
            <a href="{% url 'competitions:competitions_list' %}">Musobaqalar</a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'competitions:battles_list' %}">Janglar</a>
            <i class="bi bi-chevron-right"></i>
            <span>Jang tafsiloti</span>
        </div>

        <div class="bd-layout">

            <!-- Hero -->
            <div class="bd-hero">
                <div class="bd-hero-inner">
                    <div class="bd-hero-badge {{ battle.status }}">
                        {% if battle.status == 'waiting' %}‚è≥ Kutilmoqda
                        {% elif battle.status == 'in_progress' %}üî¥ Davom etmoqda
                        {% elif battle.status == 'completed' %}‚úÖ Yakunlangan
                        {% endif %}
                    </div>

                    <div class="bd-vs">
                        <!-- Challenger -->
                        <div class="bd-vs-player">
                            <div class="bd-vs-avatar">
                                {{ battle.challenger.first_name|default:"?"|slice:":1" }}
                            </div>
                            <div class="bd-vs-name">
                                {% if is_challenger %}Siz{% else %}{{ battle.challenger.first_name|default:"Noma'lum" }}{% endif %}
                            </div>
                            <div class="bd-vs-label">Tashabbuskor</div>
                        </div>

                        <div class="bd-vs-text">VS</div>

                        <!-- Opponent -->
                        <div class="bd-vs-player">
                            <div class="bd-vs-avatar">
                                {% if battle.opponent_type == 'bot' %}ü§ñ
                                {% elif battle.opponent %}{{ battle.opponent.first_name|default:"?"|slice:":1" }}
                                {% else %}?
                                {% endif %}
                            </div>
                            <div class="bd-vs-name">
                                {% if battle.opponent_type == 'bot' %}Bot ({{ battle.get_bot_difficulty_display }})
                                {% elif battle.opponent %}
                                    {% if is_challenger %}{{ battle.opponent.first_name|default:"Raqib" }}{% else %}Siz{% endif %}
                                {% else %}Kutilmoqda...
                                {% endif %}
                            </div>
                            <div class="bd-vs-label">
                                {% if battle.opponent_type == 'bot' %}Sun'iy intellekt{% else %}Raqib{% endif %}
                            </div>
                        </div>
                    </div>

                    <p class="bd-hero-subject">
                        {{ battle.subject.name|default:"Umumiy" }} ‚Ä¢ {{ battle.question_count }} savol
                    </p>
                </div>
            </div>

            <!-- Status Message -->
            {% if battle.status == 'waiting' and is_challenger %}
            <div class="bd-status-msg waiting">
                ‚è≥ Raqibingiz taklifni qabul qilishini kutmoqdasiz
            </div>
            {% elif battle.status == 'waiting' and is_invited %}
            <div class="bd-status-msg your_turn">
                ‚úâÔ∏è Sizni jangga taklif qilishdi!
            </div>
            {% elif battle.status == 'in_progress' and can_play %}
            <div class="bd-status-msg your_turn">
                üü¢ Sizning navbatingiz ‚Äî jangni boshlang!
            </div>
            {% elif battle.status == 'in_progress' and not can_play %}
            <div class="bd-status-msg opponent_turn">
                ‚è≥ Raqibingiz javob berishi kutilmoqda
            </div>
            {% endif %}

            <!-- Info Card -->
            <div class="bd-card">
                <h3><i class="bi bi-info-circle-fill"></i> Jang ma'lumoti</h3>
                <ul class="bd-info-list">
                    <li>
                        <span>Fan</span>
                        <span>{{ battle.subject.name|default:"Umumiy" }}</span>
                    </li>
                    <li>
                        <span>Savollar</span>
                        <span>{{ battle.question_count }} ta</span>
                    </li>
                    <li>
                        <span>Raqib turi</span>
                        <span>
                            {% if battle.opponent_type == 'bot' %}ü§ñ Bot
                            {% elif battle.opponent_type == 'friend' %}üë§ Do'st
                            {% else %}üé≤ Random
                            {% endif %}
                        </span>
                    </li>
                    <li>
                        <span>Yaratilgan</span>
                        <span>{{ battle.created_at|date:"d.m.Y H:i" }}</span>
                    </li>
                    <li>
                        <span>Holat</span>
                        <span>
                            {% if battle.status == 'waiting' %}‚è≥ Kutilmoqda
                            {% elif battle.status == 'in_progress' %}üî¥ Davom etmoqda
                            {% elif battle.status == 'completed' %}‚úÖ Yakunlangan
                            {% endif %}
                        </span>
                    </li>
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="bd-actions">
                {% if can_play %}
                <a href="{% url 'competitions:battle_play' uuid=battle.uuid %}" class="bd-btn danger">
                    <i class="bi bi-lightning-fill"></i> Jangni boshlash!
                </a>
                {% endif %}

                {% if is_invited and battle.status == 'waiting' %}
                <form method="post" action="{% url 'competitions:battle_accept' uuid=battle.uuid %}">
                    {% csrf_token %}
                    <button type="submit" class="bd-btn success" style="width:100%;">
                        <i class="bi bi-check-circle-fill"></i> Qabul qilish
                    </button>
                </form>
                <form method="post" action="{% url 'competitions:battle_decline' uuid=battle.uuid %}">
                    {% csrf_token %}
                    <button type="submit" class="bd-btn-sm" style="width:100%;text-align:center;">
                        <i class="bi bi-x-lg"></i> Rad etish
                    </button>
                </form>
                {% endif %}

                {% if battle.status == 'completed' %}
                <a href="{% url 'competitions:battle_result' uuid=battle.uuid %}" class="bd-btn danger">
                    <i class="bi bi-bar-chart-fill"></i> Natijani ko'rish
                </a>
                {% endif %}

                {% if battle.status == 'waiting' and is_challenger %}
                <div class="bd-btn disabled">
                    <i class="bi bi-hourglass-split"></i> Raqib javobini kutmoqda...
                </div>
                {% endif %}

                <a href="{% url 'competitions:battles_list' %}" class="bd-btn outline">
                    <i class="bi bi-arrow-left"></i> Janglarga qaytish
                </a>
            </div>

        </div>
    </div>
</div>
{% endblock %}