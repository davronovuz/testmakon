{% extends 'base.html' %}
{% load static %}

{% block title %}Jang yaratish | TestMakon{% endblock %}

{% block extra_css %}
<style>
    .bc-page { padding: 2rem 0 4rem; }

    /* Breadcrumb */
    .bc-bread {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }

    .bc-bread a { color: var(--primary); text-decoration: none; font-weight: 600; }
    .bc-bread a:hover { text-decoration: underline; }

    /* Layout */
    .bc-layout {
        max-width: 680px;
        margin: 0 auto;
    }

    /* Title */
    .bc-title {
        font-size: 1.5rem;
        font-weight: 900;
        color: var(--dark);
        margin: 0 0 0.35rem;
        display: flex;
        align-items: center;
        gap: 0.65rem;
    }

    .bc-subtitle {
        font-size: 0.92rem;
        color: var(--gray-500);
        margin: 0 0 2rem;
    }

    /* ========== STEP SECTIONS ========== */
    .bc-step {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
    }

    .bc-step-head {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        margin-bottom: 1.15rem;
    }

    .bc-step-num {
        width: 30px;
        height: 30px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.82rem;
        font-weight: 800;
        flex-shrink: 0;
    }

    .bc-step-title { font-size: 1rem; font-weight: 800; color: var(--dark); margin: 0; }

    /* ========== OPPONENT TYPE ========== */
    .bc-types {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }

    .bc-type-card {
        border: 2px solid var(--gray-200);
        border-radius: 14px;
        padding: 1.25rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .bc-type-card:hover { border-color: var(--gray-300); background: var(--gray-50); }

    .bc-type-card.active {
        border-color: var(--primary);
        background: rgba(139,197,64,0.05);
    }

    .bc-type-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .bc-type-name { font-size: 0.92rem; font-weight: 700; color: var(--dark); margin-bottom: 0.15rem; }
    .bc-type-desc { font-size: 0.78rem; color: var(--gray-500); }

    /* ========== FRIEND SELECT ========== */
    .bc-friends {
        display: none;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
        max-height: 250px;
        overflow-y: auto;
    }

    .bc-friends.show { display: flex; }

    .bc-friend {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .bc-friend:hover { border-color: var(--gray-300); background: var(--gray-50); }
    .bc-friend.active { border-color: var(--primary); background: rgba(139,197,64,0.05); }

    .bc-friend-avatar {
        width: 40px;
        height: 40px;
        background: var(--gray-200);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--gray-500);
        flex-shrink: 0;
    }

    .bc-friend-name { font-size: 0.92rem; font-weight: 700; color: var(--dark); }
    .bc-friend-check { margin-left: auto; color: var(--primary); font-size: 1.15rem; display: none; }
    .bc-friend.active .bc-friend-check { display: block; }

    .bc-no-friends {
        text-align: center;
        padding: 1.25rem;
        color: var(--gray-400);
        font-size: 0.88rem;
        background: var(--gray-50);
        border-radius: 12px;
        margin-top: 1rem;
    }

    /* ========== BOT DIFFICULTY ========== */
    .bc-bots {
        display: none;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.65rem;
        margin-top: 1rem;
    }

    .bc-bots.show { display: grid; }

    .bc-bot {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 0.85rem 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .bc-bot:hover { border-color: var(--gray-300); }
    .bc-bot.active { border-color: var(--primary); background: rgba(139,197,64,0.05); }

    .bc-bot-icon { font-size: 1.35rem; margin-bottom: 0.25rem; }
    .bc-bot-name { font-size: 0.8rem; font-weight: 700; color: var(--dark); }
    .bc-bot-acc { font-size: 0.7rem; color: var(--gray-500); }

    /* ========== SUBJECT SELECT ========== */
    .bc-subjects {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.65rem;
    }

    .bc-subject {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 0.85rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .bc-subject:hover { border-color: var(--gray-300); background: var(--gray-50); }
    .bc-subject.active { border-color: var(--primary); background: rgba(139,197,64,0.05); }

    .bc-subject-name { font-size: 0.85rem; font-weight: 700; color: var(--dark); }

    /* ========== SETTINGS ========== */
    .bc-setting {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 0;
    }

    .bc-setting + .bc-setting { border-top: 1px solid var(--gray-100); }

    .bc-setting-label { font-size: 0.92rem; font-weight: 600; color: var(--gray-600); }

    .bc-setting-options {
        display: flex;
        gap: 0.5rem;
    }

    .bc-setting-opt {
        padding: 0.45rem 0.85rem;
        border: 2px solid var(--gray-200);
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--gray-500);
        cursor: pointer;
        transition: all 0.2s;
    }

    .bc-setting-opt:hover { border-color: var(--gray-300); }

    .bc-setting-opt.active {
        border-color: var(--primary);
        background: rgba(139,197,64,0.05);
        color: var(--primary);
    }

    /* ========== SUBMIT ========== */
    .bc-submit-wrap { margin-top: 0.5rem; }

    .bc-submit {
        width: 100%;
        padding: 0.95rem;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .bc-submit:hover { box-shadow: 0 6px 20px -4px rgba(139,197,64,0.4); transform: translateY(-1px); }
    .bc-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Responsive */
    @media (max-width: 575px) {
        .bc-types { grid-template-columns: 1fr; }
        .bc-bots { grid-template-columns: repeat(2, 1fr); }
        .bc-subjects { grid-template-columns: repeat(2, 1fr); }
    }
</style>
{% endblock %}

{% block content %}
<div class="bc-page">
    <div class="container">

        <!-- Breadcrumb -->
        <div class="bc-bread">
            <a href="{% url 'competitions:competitions_list' %}">Musobaqalar</a>
            <i class="bi bi-chevron-right"></i>
            <a href="{% url 'competitions:battles_list' %}">Janglar</a>
            <i class="bi bi-chevron-right"></i>
            <span>Yangi jang</span>
        </div>

        <div class="bc-layout">
            <h1 class="bc-title">‚öîÔ∏è Yangi jang yaratish</h1>
            <p class="bc-subtitle">Raqibingizni tanlang, fanni belgilang va jangovar maydonga tushing!</p>

            <form method="post" id="battleForm">
                {% csrf_token %}
                <input type="hidden" name="opponent_type" id="opponentType" value="">
                <input type="hidden" name="opponent_id" id="opponentId" value="">
                <input type="hidden" name="subject_id" id="subjectId" value="">
                <input type="hidden" name="question_count" id="questionCount" value="10">
                <input type="hidden" name="bot_difficulty" id="botDifficulty" value="medium">

                <!-- Step 1: Raqib -->
                <div class="bc-step">
                    <div class="bc-step-head">
                        <div class="bc-step-num">1</div>
                        <h3 class="bc-step-title">Raqibni tanlang</h3>
                    </div>

                    <div class="bc-types">
                        <div class="bc-type-card" data-type="bot" onclick="selectType('bot')">
                            <div class="bc-type-icon">ü§ñ</div>
                            <div class="bc-type-name">Bot</div>
                            <div class="bc-type-desc">Sun'iy intellekt</div>
                        </div>
                        <div class="bc-type-card" data-type="friend" onclick="selectType('friend')">
                            <div class="bc-type-icon">üë§</div>
                            <div class="bc-type-name">Do'st</div>
                            <div class="bc-type-desc">Taklif yuboring</div>
                        </div>
                        <div class="bc-type-card" data-type="random" onclick="selectType('random')">
                            <div class="bc-type-icon">üé≤</div>
                            <div class="bc-type-name">Random</div>
                            <div class="bc-type-desc">Tasodifiy raqib</div>
                        </div>
                    </div>

                    <!-- Bot difficulty -->
                    <div class="bc-bots" id="botSection">
                        <div class="bc-bot" data-diff="easy" onclick="selectBot('easy')">
                            <div class="bc-bot-icon">üòä</div>
                            <div class="bc-bot-name">Oson</div>
                            <div class="bc-bot-acc">40-60%</div>
                        </div>
                        <div class="bc-bot active" data-diff="medium" onclick="selectBot('medium')">
                            <div class="bc-bot-icon">ü§î</div>
                            <div class="bc-bot-name">O'rta</div>
                            <div class="bc-bot-acc">60-80%</div>
                        </div>
                        <div class="bc-bot" data-diff="hard" onclick="selectBot('hard')">
                            <div class="bc-bot-icon">üò§</div>
                            <div class="bc-bot-name">Qiyin</div>
                            <div class="bc-bot-acc">80-90%</div>
                        </div>
                        <div class="bc-bot" data-diff="expert" onclick="selectBot('expert')">
                            <div class="bc-bot-icon">üß†</div>
                            <div class="bc-bot-name">Ekspert</div>
                            <div class="bc-bot-acc">90-98%</div>
                        </div>
                    </div>

                    <!-- Friends list -->
                    <div class="bc-friends" id="friendsSection">
                        {% if friends %}
                            {% for friend in friends %}
                            <div class="bc-friend" data-id="{{ friend.id }}" onclick="selectFriend({{ friend.id }})">
                                <div class="bc-friend-avatar">{{ friend.first_name|default:"?"|slice:":1" }}</div>
                                <span class="bc-friend-name">{{ friend.first_name }} {{ friend.last_name|default:"" }}</span>
                                <i class="bi bi-check-circle-fill bc-friend-check"></i>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="bc-no-friends">
                                <i class="bi bi-people"></i> Hozircha do'stlar yo'q
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Step 2: Fan -->
                <div class="bc-step">
                    <div class="bc-step-head">
                        <div class="bc-step-num">2</div>
                        <h3 class="bc-step-title">Fan tanlang</h3>
                    </div>

                    <div class="bc-subjects">
                        {% for subject in subjects %}
                        <div class="bc-subject" data-id="{{ subject.id }}" onclick="selectSubject({{ subject.id }})">
                            <div class="bc-subject-name">{{ subject.name }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Step 3: Sozlamalar -->
                <div class="bc-step">
                    <div class="bc-step-head">
                        <div class="bc-step-num">3</div>
                        <h3 class="bc-step-title">Sozlamalar</h3>
                    </div>

                    <div class="bc-setting">
                        <span class="bc-setting-label">Savollar soni</span>
                        <div class="bc-setting-options">
                            <div class="bc-setting-opt" data-count="5" onclick="selectCount(5)">5</div>
                            <div class="bc-setting-opt active" data-count="10" onclick="selectCount(10)">10</div>
                            <div class="bc-setting-opt" data-count="15" onclick="selectCount(15)">15</div>
                            <div class="bc-setting-opt" data-count="20" onclick="selectCount(20)">20</div>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="bc-submit-wrap">
                    <button type="submit" class="bc-submit" id="submitBtn" disabled>
                        <i class="bi bi-lightning-fill"></i> Jangga chiqish
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var state = {
        type: '',
        opponentId: '',
        subjectId: '',
        questionCount: 10,
        botDifficulty: 'medium'
    };

    // Opponent type
    window.selectType = function(type) {
        state.type = type;
        state.opponentId = '';
        document.getElementById('opponentType').value = type;
        document.getElementById('opponentId').value = '';

        // UI
        document.querySelectorAll('.bc-type-card').forEach(function(el) {
            el.classList.toggle('active', el.dataset.type === type);
        });

        document.getElementById('botSection').classList.toggle('show', type === 'bot');
        document.getElementById('friendsSection').classList.toggle('show', type === 'friend');

        // Reset friend selection
        document.querySelectorAll('.bc-friend').forEach(function(el) { el.classList.remove('active'); });

        checkReady();
    };

    // Bot difficulty
    window.selectBot = function(diff) {
        state.botDifficulty = diff;
        document.getElementById('botDifficulty').value = diff;

        document.querySelectorAll('.bc-bot').forEach(function(el) {
            el.classList.toggle('active', el.dataset.diff === diff);
        });
    };

    // Friend
    window.selectFriend = function(id) {
        state.opponentId = id;
        document.getElementById('opponentId').value = id;

        document.querySelectorAll('.bc-friend').forEach(function(el) {
            el.classList.toggle('active', parseInt(el.dataset.id) === id);
        });

        checkReady();
    };

    // Subject
    window.selectSubject = function(id) {
        if (state.subjectId === id) {
            state.subjectId = '';
            document.getElementById('subjectId').value = '';
        } else {
            state.subjectId = id;
            document.getElementById('subjectId').value = id;
        }

        document.querySelectorAll('.bc-subject').forEach(function(el) {
            el.classList.toggle('active', parseInt(el.dataset.id) === state.subjectId);
        });

        checkReady();
    };

    // Question count
    window.selectCount = function(count) {
        state.questionCount = count;
        document.getElementById('questionCount').value = count;

        document.querySelectorAll('.bc-setting-opt').forEach(function(el) {
            el.classList.toggle('active', parseInt(el.dataset.count) === count);
        });
    };

    // Check if form is ready
    function checkReady() {
        var ready = false;

        if (state.type === 'bot') {
            ready = true; // Bot - faqat type kerak
        } else if (state.type === 'friend') {
            ready = !!state.opponentId;
        } else if (state.type === 'random') {
            ready = true;
        }

        document.getElementById('submitBtn').disabled = !ready;

        // Button text
        var btn = document.getElementById('submitBtn');
        if (state.type === 'bot') {
            btn.innerHTML = '<i class="bi bi-lightning-fill"></i> Bot bilan jang';
        } else if (state.type === 'friend') {
            btn.innerHTML = '<i class="bi bi-send-fill"></i> Taklif yuborish';
        } else if (state.type === 'random') {
            btn.innerHTML = '<i class="bi bi-search"></i> Raqib qidirish';
        } else {
            btn.innerHTML = '<i class="bi bi-lightning-fill"></i> Jangga chiqish';
        }
    }
})();
</script>
{% endblock %}