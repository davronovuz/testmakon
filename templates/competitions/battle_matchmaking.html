{% extends 'base.html' %}
{% load static %}

{% block title %}Raqib qidirilmoqda | TestMakon{% endblock %}

{% block extra_css %}
<style>
  .mm-page {
    min-height: 100vh;
    background: #F8FAFC;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }

  .mm-wrap {
    width: 100%;
    max-width: 520px;
  }

  /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
  .mm-card {
    background: white;
    border-radius: 24px;
    border: 1px solid #E2E8F0;
    padding: 2.5rem 2rem;
    text-align: center;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
  }

  /* ‚îÄ‚îÄ Radar animation ‚îÄ‚îÄ */
  .mm-radar {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0 auto 2rem;
    flex-shrink: 0;
  }

  .mm-radar-ring {
    position: absolute;
    border-radius: 50%;
    border: 2px solid rgba(139,197,64,0.3);
    animation: mm-pulse 2s ease-out infinite;
  }
  .mm-radar-ring:nth-child(1) { inset: 0; animation-delay: 0s; }
  .mm-radar-ring:nth-child(2) { inset: 20px; animation-delay: 0.5s; }
  .mm-radar-ring:nth-child(3) { inset: 40px; animation-delay: 1s; }

  @keyframes mm-pulse {
    0%   { transform: scale(0.9); opacity: 0; }
    40%  { opacity: 1; }
    100% { transform: scale(1.1); opacity: 0; }
  }

  .mm-radar-center {
    position: absolute;
    inset: 55px;
    background: linear-gradient(135deg, #8BC540, #6BA832);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    box-shadow: 0 8px 24px rgba(139,197,64,0.35);
    animation: mm-float 3s ease-in-out infinite;
  }

  @keyframes mm-float {
    0%, 100% { transform: translateY(0); }
    50%       { transform: translateY(-5px); }
  }

  /* ‚îÄ‚îÄ Found state radar ‚îÄ‚îÄ */
  .mm-card.found .mm-radar-ring {
    border-color: rgba(34,197,94,0.4);
    animation: mm-found-ring 0.6s ease forwards;
  }
  @keyframes mm-found-ring {
    to { border-color: rgba(34,197,94,0.8); opacity: 0.8; }
  }

  /* ‚îÄ‚îÄ VS Section ‚îÄ‚îÄ */
  .mm-vs {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    justify-content: center;
    margin-bottom: 1.75rem;
  }

  .mm-player { flex: 1; max-width: 120px; }

  .mm-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    font-weight: 800;
    margin: 0 auto 0.5rem;
    position: relative;
  }

  .mm-avatar.me {
    background: linear-gradient(135deg, #8BC540, #6BA832);
    color: white;
    box-shadow: 0 4px 16px rgba(139,197,64,0.3);
  }

  .mm-avatar.them {
    background: #F1F5F9;
    color: #94A3B8;
    border: 2px dashed #CBD5E1;
    animation: mm-blink 1.4s ease infinite;
  }

  .mm-avatar.them.filled {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
    border: none;
    box-shadow: 0 4px 16px rgba(239,68,68,0.3);
    animation: mm-pop 0.5s cubic-bezier(0.34,1.56,0.64,1);
  }

  @keyframes mm-blink {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.35; }
  }

  @keyframes mm-pop {
    0%   { transform: scale(0.5); }
    100% { transform: scale(1); }
  }

  .mm-pname {
    font-size: 0.82rem;
    font-weight: 700;
    color: #0F172A;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mm-psub {
    font-size: 0.72rem;
    color: #94A3B8;
    margin-top: 0.15rem;
  }

  .mm-vs-badge {
    width: 40px;
    height: 40px;
    background: #F8FAFC;
    border: 2px solid #E2E8F0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 900;
    color: #64748B;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Title ‚îÄ‚îÄ */
  .mm-title {
    font-size: 1.3rem;
    font-weight: 800;
    color: #0F172A;
    margin: 0 0 0.4rem;
  }

  .mm-subtitle {
    font-size: 0.88rem;
    color: #64748B;
    margin: 0 0 1.5rem;
  }

  /* ‚îÄ‚îÄ Subject pill ‚îÄ‚îÄ */
  .mm-subj {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: linear-gradient(135deg, rgba(139,197,64,0.12), rgba(107,168,50,0.08));
    border: 1px solid rgba(139,197,64,0.25);
    padding: 0.4rem 1rem;
    border-radius: 50px;
    font-size: 0.82rem;
    font-weight: 700;
    color: #5A8E24;
    margin-bottom: 1.5rem;
  }

  /* ‚îÄ‚îÄ Timer bar ‚îÄ‚îÄ */
  .mm-timer-wrap {
    margin-bottom: 1.5rem;
  }

  .mm-timer-label {
    font-size: 0.78rem;
    color: #94A3B8;
    margin-bottom: 0.4rem;
    display: flex;
    justify-content: space-between;
  }

  .mm-timer-bar {
    height: 4px;
    background: #F1F5F9;
    border-radius: 4px;
    overflow: hidden;
  }

  .mm-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #8BC540, #6BA832);
    border-radius: 4px;
    width: 100%;
    transform-origin: left;
    transition: width 1s linear;
  }

  /* ‚îÄ‚îÄ Status pills ‚îÄ‚îÄ */
  .mm-status {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.6rem 1.25rem;
    border-radius: 50px;
    margin-bottom: 1.5rem;
  }

  .mm-status.searching {
    display: inline-flex;
    background: #FEF9C3;
    color: #854D0E;
  }

  .mm-status.found {
    display: inline-flex;
    background: #DCFCE7;
    color: #166534;
    animation: mm-pop 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }

  .mm-status.timeout {
    display: inline-flex;
    background: #FEE2E2;
    color: #991B1B;
  }

  /* dot spinner inside status */
  .mm-dot {
    display: inline-flex;
    gap: 3px;
  }
  .mm-dot span {
    width: 5px;
    height: 5px;
    background: currentColor;
    border-radius: 50%;
    animation: mm-dotbounce 1.2s ease infinite;
  }
  .mm-dot span:nth-child(2) { animation-delay: 0.2s; }
  .mm-dot span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes mm-dotbounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40%           { transform: scale(1); opacity: 1; }
  }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .mm-btns { display: flex; justify-content: center; gap: 0.75rem; flex-wrap: wrap; }

  .mm-btn-cancel {
    padding: 0.75rem 1.75rem;
    background: white;
    border: 1.5px solid #E2E8F0;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 700;
    color: #64748B;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }
  .mm-btn-cancel:hover { border-color: #EF4444; color: #EF4444; }

  .mm-btn-play {
    display: none;
    padding: 0.85rem 2rem;
    background: linear-gradient(135deg, #8BC540, #6BA832);
    color: white !important;
    border: none;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 16px rgba(139,197,64,0.35);
    animation: mm-pop 0.5s cubic-bezier(0.34,1.56,0.64,1);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .mm-btn-play:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139,197,64,0.45); }
  .mm-btn-play.show { display: inline-flex; }

  .mm-btn-retry {
    display: none;
    padding: 0.75rem 1.75rem;
    background: linear-gradient(135deg, #8BC540, #6BA832);
    color: white !important;
    border: none;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    text-decoration: none;
    align-items: center;
    gap: 0.4rem;
  }
  .mm-btn-retry.show { display: inline-flex; }

  /* ‚îÄ‚îÄ Found countdown ‚îÄ‚îÄ */
  .mm-found-cd {
    display: none;
    flex-direction: column;
    align-items: center;
    margin-bottom: 1.25rem;
  }
  .mm-found-cd.show { display: flex; }
  .mm-found-cd-num {
    font-size: 3.5rem;
    font-weight: 900;
    color: #8BC540;
    line-height: 1;
    animation: mm-numtick 0.35s ease;
  }
  .mm-found-cd-label {
    font-size: 0.78rem;
    color: #94A3B8;
    margin-top: 0.2rem;
  }
  @keyframes mm-numtick {
    0% { transform: scale(1.4); opacity: 0.3; }
    100% { transform: scale(1); opacity: 1; }
  }

  /* ‚îÄ‚îÄ Tips ‚îÄ‚îÄ */
  .mm-tip {
    margin-top: 1.75rem;
    padding-top: 1.25rem;
    border-top: 1px solid #F1F5F9;
    font-size: 0.8rem;
    color: #94A3B8;
    font-style: italic;
    min-height: 2.5em;
    transition: opacity 0.4s;
  }

  @media(max-width: 480px) {
    .mm-page { padding: 1rem 0.75rem; align-items: flex-start; padding-top: 1.5rem; }
    .mm-card { padding: 1.75rem 1.25rem 2rem; border-radius: 20px; }
    .mm-radar { width: 130px; height: 130px; margin-bottom: 1.5rem; }
    .mm-radar-center { inset: 38px; font-size: 1.3rem; }
    .mm-radar-ring:nth-child(2) { inset: 14px; }
    .mm-radar-ring:nth-child(3) { inset: 28px; }
    .mm-title { font-size: 1.1rem; }
    .mm-subtitle { font-size: 0.82rem; margin-bottom: 1.1rem; }
    .mm-vs { gap: 1rem; margin-bottom: 1.25rem; }
    .mm-avatar { width: 54px; height: 54px; font-size: 1.2rem; }
    .mm-pname { font-size: 0.78rem; }
    .mm-psub { font-size: 0.68rem; }
    .mm-vs-badge { width: 34px; height: 34px; font-size: 0.68rem; }
    .mm-btns { flex-direction: column; gap: 0.5rem; }
    .mm-btn-cancel, .mm-btn-play, .mm-btn-retry {
      width: 100%;
      justify-content: center;
      box-sizing: border-box;
    }
    .mm-tip { font-size: 0.75rem; margin-top: 1.25rem; padding-top: 1rem; }
    .mm-found-cd-num { font-size: 3rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="mm-page">
  <div class="mm-wrap">
    <div class="mm-card" id="mmCard">

      <!-- Radar -->
      <div class="mm-radar">
        <div class="mm-radar-ring"></div>
        <div class="mm-radar-ring"></div>
        <div class="mm-radar-ring"></div>
        <div class="mm-radar-center" id="radarIcon">‚öîÔ∏è</div>
      </div>

      <!-- VS -->
      <div class="mm-vs">
        <div class="mm-player">
          <div class="mm-avatar me">{{ request.user.first_name|default:"?"|slice:":1" }}</div>
          <div class="mm-pname">{{ request.user.first_name|default:"Siz" }}</div>
          <div class="mm-psub">Reyting: {{ request.user.rating|default:1000 }}</div>
        </div>

        <div class="mm-vs-badge">VS</div>

        <div class="mm-player">
          <div class="mm-avatar them" id="opponentAvatar">?</div>
          <div class="mm-pname" id="opponentName">Qidirilmoqda</div>
          <div class="mm-psub" id="opponentSub">‚Äî</div>
        </div>
      </div>

      <!-- Title -->
      <h2 class="mm-title" id="mmTitle">Raqib qidirilmoqda...</h2>
      <p class="mm-subtitle" id="mmSub">Rating ¬±300 oralig'ida mos o'yinchi izlanmoqda</p>

      {% if subject %}
      <div class="mm-subj">
        <i class="bi bi-book-fill"></i> {{ subject.name }}
      </div>
      {% endif %}

      <!-- Timer bar -->
      <div class="mm-timer-wrap" id="timerWrap">
        <div class="mm-timer-label">
          <span>Kutish vaqti</span>
          <span id="timerText">0:00</span>
        </div>
        <div class="mm-timer-bar">
          <div class="mm-timer-fill" id="timerFill"></div>
        </div>
      </div>

      <!-- Status -->
      <div class="mm-status searching" id="stSearching">
        <div class="mm-dot"><span></span><span></span><span></span></div>
        Qidiruv davom etmoqda
      </div>
      <div class="mm-status found" id="stFound" style="display:none;">
        <i class="bi bi-check-circle-fill"></i> Raqib topildi!
      </div>
      <div class="mm-status timeout" id="stTimeout" style="display:none;">
        <i class="bi bi-exclamation-circle-fill"></i> Raqib topilmadi
      </div>

      <!-- Found countdown (hidden until match) -->
      <div class="mm-found-cd" id="foundCd">
        <div class="mm-found-cd-num" id="foundCdNum">5</div>
        <div class="mm-found-cd-label">soniyada boshlanadi</div>
      </div>

      <!-- Buttons -->
      <div class="mm-btns">
        <button class="mm-btn-cancel" id="cancelBtn" onclick="doCancel()">
          <i class="bi bi-x-lg"></i> Bekor qilish
        </button>
        <a href="#" class="mm-btn-play" id="playBtn">
          <i class="bi bi-lightning-charge-fill"></i> Hozir boshlash
        </a>
        <a href="{% url 'competitions:battle_create' %}?type=random" class="mm-btn-retry" id="retryBtn">
          <i class="bi bi-arrow-clockwise"></i> Qayta urinish
        </a>
      </div>

      <!-- Tip -->
      <div class="mm-tip" id="tipEl">
        üí° Eng tez javob bergan o'yinchi teng ball bo'lsa g'olib bo'ladi.
      </div>

    </div><!-- /mm-card -->
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  var MAX_WAIT = 120;
  var elapsed  = 0;
  var done     = false;

  var timerFill  = document.getElementById('timerFill');
  var timerText  = document.getElementById('timerText');
  var opAvatar   = document.getElementById('opponentAvatar');
  var opName     = document.getElementById('opponentName');
  var opSub      = document.getElementById('opponentSub');
  var mmTitle    = document.getElementById('mmTitle');
  var mmSub      = document.getElementById('mmSub');
  var stSearch   = document.getElementById('stSearching');
  var stFound    = document.getElementById('stFound');
  var stTimeout  = document.getElementById('stTimeout');
  var cancelBtn  = document.getElementById('cancelBtn');
  var playBtn    = document.getElementById('playBtn');
  var retryBtn   = document.getElementById('retryBtn');
  var timerWrap  = document.getElementById('timerWrap');
  var tipEl      = document.getElementById('tipEl');
  var radarIcon  = document.getElementById('radarIcon');
  var foundCd    = document.getElementById('foundCd');
  var foundCdNum = document.getElementById('foundCdNum');

  var tips = [
    'üí° Eng tez javob bergan o\'yinchi teng ball bo\'lsa g\'olib bo\'ladi.',
    'üí° Bot bilan mashq qilish ham XP beradi.',
    'üí° Har kuni challenge yechsangiz bonus XP olasiz.',
    'üí° Haftalik ligada top 3 ga kirganlar maxsus mukofot oladi.',
    'üí° Sertifikat uchun musobaqada 70% dan yuqori to\'plang.',
    'üí° Do\'stingizni taklif qilsangiz do\'stlik bonusi olasiz.',
  ];

  /* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
  var timerInt = setInterval(function () {
    if (done) return;
    elapsed++;

    var m = Math.floor(elapsed / 60);
    var s = elapsed % 60;
    timerText.textContent = m + ':' + (s < 10 ? '0' : '') + s;

    // Shrink bar (100% ‚Üí 0% over MAX_WAIT seconds)
    var pct = Math.max(0, 100 - (elapsed / MAX_WAIT) * 100);
    timerFill.style.width = pct + '%';

    // Rotate tips
    if (elapsed > 0 && elapsed % 12 === 0) {
      var idx = Math.floor(elapsed / 12) % tips.length;
      tipEl.style.opacity = '0';
      setTimeout(function () {
        tipEl.textContent = tips[idx];
        tipEl.style.opacity = '1';
      }, 350);
    }

    if (elapsed >= MAX_WAIT) {
      clearInterval(timerInt);
      clearInterval(pollInt);
      showTimeout();
    }
  }, 1000);

  /* ‚îÄ‚îÄ Poll ‚îÄ‚îÄ */
  function poll() {
    if (done) return;
    fetch("{% url 'competitions:api_matchmaking_status' %}", {
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(function (r) { return r.json(); })
    .then(function (d) {
      if (d.status === 'matched' && d.battle_uuid) {
        done = true;
        clearInterval(timerInt);
        clearInterval(pollInt);
        showFound(d.battle_uuid, d.opponent_name || 'Raqib');
      } else if (d.status === 'not_in_queue' || d.status === 'expired') {
        done = true;
        clearInterval(timerInt);
        clearInterval(pollInt);
        showTimeout();
      }
    })
    .catch(function () {});
  }

  var pollInt = setInterval(poll, 3000);
  setTimeout(poll, 800);

  /* ‚îÄ‚îÄ WebSocket ham tinglaydi (birinchi kelgani ishga tushadi) ‚îÄ‚îÄ */
  document.addEventListener('ws:match_found_raw', function (e) {
    if (done) return;
    done = true;
    clearInterval(timerInt);
    clearInterval(pollInt);
    var d = e.detail;
    showFound(d.battle_uuid, d.opponent ? d.opponent.name : 'Raqib');
  });

  /* ‚îÄ‚îÄ showFound ‚îÄ‚îÄ */
  function showFound(uuid, name) {
    // Avatar
    opAvatar.textContent = (name || '?')[0].toUpperCase();
    opAvatar.classList.remove('them');
    opAvatar.classList.add('filled');
    opName.textContent = name;
    opSub.textContent  = 'Raqib topildi!';

    // Title
    mmTitle.textContent = '\uD83C\uDF89 Raqib topildi!';
    mmSub.textContent   = name + ' bilan jang ' + 5 + ' soniyada boshlanadi';

    // Status
    stSearch.style.display = 'none';
    stFound.style.display  = 'inline-flex';

    // Timer off
    timerWrap.style.display = 'none';
    cancelBtn.style.display  = 'none';
    tipEl.style.display = 'none';

    // Emoji
    radarIcon.textContent = '\uD83C\uDFC6';

    // Play button
    playBtn.href = '/competitions/battle/' + uuid + '/play/';
    playBtn.classList.add('show');

    // Countdown 5 ‚Üí 0
    var secs = 5;
    foundCd.classList.add('show');
    foundCdNum.textContent = secs;

    var cd = setInterval(function () {
      secs--;
      foundCdNum.style.animation = 'none';
      // retrigger animation
      void foundCdNum.offsetWidth;
      foundCdNum.style.animation = '';
      if (secs > 0) {
        foundCdNum.textContent = secs;
        mmSub.textContent = name + ' bilan jang ' + secs + ' soniyada boshlanadi';
      } else {
        clearInterval(cd);
        window.location.href = playBtn.href;
      }
    }, 1000);
  }

  /* ‚îÄ‚îÄ showTimeout ‚îÄ‚îÄ */
  function showTimeout() {
    stSearch.style.display  = 'none';
    stTimeout.style.display = 'inline-flex';
    timerWrap.style.display = 'none';
    cancelBtn.style.display = 'none';
    radarIcon.textContent   = 'üòî';
    mmTitle.textContent     = 'Raqib topilmadi';
    mmSub.textContent       = 'Hozircha mos raqib yo\'q. Keyinroq urinib ko\'ring.';
    retryBtn.classList.add('show');
  }

  /* ‚îÄ‚îÄ Cancel ‚îÄ‚îÄ */
  window.doCancel = function () {
    done = true;
    clearInterval(timerInt);
    clearInterval(pollInt);
    fetch("{% url 'competitions:api_matchmaking_cancel' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).finally(function () {
      window.location.href = "{% url 'competitions:battle_create' %}";
    });
  };

})();
</script>
{% endblock %}
