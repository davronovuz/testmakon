{% extends 'base.html' %}
{% load static %}

{% block title %}Janglar | TestMakon{% endblock %}

{% block extra_css %}
{% include 'competitions/_sidebar_css.html' %}
<style>
    /* Stats bar */
    .battles-stats-bar {
        display: grid;
        grid-template-columns: repeat(4,1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .battles-stat-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 14px;
        padding: 1rem;
        text-align: center;
    }
    .battles-stat-val { font-size: 1.75rem; font-weight: 800; color: var(--dark); }
    .battles-stat-lbl { font-size: 0.78rem; color: var(--gray-500); }

    /* Quick battle */
    .battles-quick-grid {
        display: grid;
        grid-template-columns: repeat(3,1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .quick-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 14px;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.2s;
        text-decoration: none;
    }
    .quick-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); border-color: var(--primary); }
    .quick-icon {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        font-size: 1.5rem;
    }
    .quick-icon.friend { background: #DBEAFE; }
    .quick-icon.random { background: #EDE9FE; }
    .quick-icon.bot { background: #FEE2E2; }
    .quick-title { font-size: 0.92rem; font-weight: 700; color: var(--dark); margin-bottom: 0.2rem; }
    .quick-sub { font-size: 0.78rem; color: var(--gray-500); }

    /* Tabs */
    .battles-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--gray-200);
        margin-bottom: 1.25rem;
    }
    .battles-tab {
        padding: 0.75rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--gray-500);
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        transition: color 0.2s;
        white-space: nowrap;
    }
    .battles-tab:hover { color: var(--dark); }
    .battles-tab.active { color: var(--primary); }
    .battles-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0; right: 0;
        height: 3px;
        background: var(--primary);
        border-radius: 3px 3px 0 0;
    }
    .battles-tab-badge {
        background: var(--gray-200);
        color: var(--gray-600);
        font-size: 0.72rem;
        font-weight: 700;
        padding: 0.15rem 0.45rem;
        border-radius: 10px;
        margin-left: 0.4rem;
    }
    .battles-tab.active .battles-tab-badge { background: var(--primary); color: white; }

    .battles-tab-content { display: none; }
    .battles-tab-content.active { display: block; }

    /* Battle cards */
    .battles-grid {
        display: grid;
        grid-template-columns: repeat(2,1fr);
        gap: 1.25rem;
    }
    .battle-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        overflow: hidden;
        transition: transform 0.2s;
    }
    .battle-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.07); }
    .battle-card.pending { border-left: 4px solid #F59E0B; }
    .battle-card.active-card { border-left: 4px solid #10B981; }
    .battle-card.completed-card { border-left: 4px solid var(--gray-300); }

    .battle-card-header {
        padding: 0.75rem 1.25rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .battle-status {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.78rem;
        font-weight: 600;
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
    }
    .battle-status.pending { background: #FEF3C7; color: #D97706; }
    .battle-status.accepted { background: #DBEAFE; color: #2563EB; }
    .battle-status.in_progress { background: #D1FAE5; color: #059669; }
    .battle-status.completed { background: var(--gray-100); color: var(--gray-600); }
    .battle-time { font-size: 0.78rem; color: var(--gray-500); }

    .battle-card-body { padding: 1.25rem; }
    .battle-players { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .battle-player { text-align: center; flex: 1; }
    .battle-player-avatar {
        width: 56px; height: 56px;
        background: var(--gray-100);
        border-radius: 50%;
        margin: 0 auto 0.5rem;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem; font-weight: 700; color: var(--dark);
        overflow: hidden;
        border: 3px solid var(--gray-200);
        position: relative;
    }
    .battle-player-avatar img { width:100%; height:100%; object-fit:cover; }
    .battle-player-avatar.you { border-color: var(--primary); }
    .battle-player-avatar.winner { border-color: #10B981; }
    .battle-player-avatar.winner::after { content:'üëë'; position:absolute; top:-8px; right:-8px; font-size:0.9rem; }
    .battle-player-avatar.bot { background: linear-gradient(135deg, #8B5CF6, #6D28D9); color: white; }
    .battle-player-name { font-size: 0.85rem; font-weight: 700; color: var(--dark); }
    .battle-player-score { font-size: 0.78rem; color: var(--gray-500); }
    .battle-player-score.winner { color: #10B981; font-weight: 600; }
    .battle-vs { padding: 0 1rem; text-align: center; }
    .battle-vs-text { font-size: 1.25rem; font-weight: 800; color: var(--gray-300); }
    .battle-vs-sub { font-size: 0.72rem; color: var(--gray-400); }

    .battle-info {
        display: flex;
        justify-content: center;
        gap: 1.25rem;
        padding: 0.6rem;
        background: var(--gray-50);
        border-radius: 10px;
        margin-bottom: 0.875rem;
        font-size: 0.82rem;
        color: var(--gray-600);
    }
    .battle-info span { display:flex; align-items:center; gap:0.3rem; }
    .battle-info i { color: var(--primary); }

    .battle-actions { display: flex; gap: 0.625rem; }
    .battle-btn {
        flex: 1;
        padding: 0.65rem 1rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        border: none;
    }
    .battle-btn.primary { background: var(--gradient-primary); color: white; }
    .battle-btn.primary:hover { box-shadow: var(--shadow-primary); color: white; }
    .battle-btn.success { background: linear-gradient(135deg,#10B981,#059669); color: white; }
    .battle-btn.success:hover { box-shadow: 0 4px 15px rgba(16,185,129,0.4); color: white; }
    .battle-btn.outline { background: transparent; color: var(--dark); border: 1px solid var(--gray-200); }
    .battle-btn.outline:hover { background: var(--gray-100); color: var(--dark); }
    .battle-btn.danger { background: transparent; color: #DC2626; border: 1px solid #FCA5A5; }
    .battle-btn.danger:hover { background: #FEE2E2; }

    /* Invite card */
    .battle-invite-card {
        background: linear-gradient(135deg,#FEF3C7,#FDE68A);
        border: 2px solid #F59E0B;
        border-radius: 14px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    .invite-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:0.875rem; }
    .invite-icon { width:44px; height:44px; background:#F59E0B; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.1rem; color:white; flex-shrink:0; }
    .invite-title { font-size:0.95rem; font-weight:700; color:#92400E; }
    .invite-from { font-size:0.82rem; color:#B45309; }
    .invite-info { display:flex; gap:1.25rem; margin-bottom:0.875rem; font-size:0.85rem; color:#92400E; }
    .invite-actions { display:flex; gap:0.625rem; }
    .invite-btn { flex:1; padding:0.65rem; border-radius:10px; font-size:0.85rem; font-weight:600; text-align:center; cursor:pointer; transition:all 0.2s; border:none; }
    .invite-btn.accept { background:#10B981; color:white; }
    .invite-btn.reject { background:white; color:#DC2626; border:1px solid #FCA5A5; }

    /* Empty */
    .battles-empty { text-align:center; padding:3rem 2rem; background:var(--gray-50); border-radius:14px; }
    .battles-empty i { font-size:3rem; color:var(--gray-300); display:block; margin-bottom:0.75rem; }

    @media (max-width: 768px) {
        .battles-stats-bar { grid-template-columns: repeat(2,1fr); }
        .battles-quick-grid { grid-template-columns: 1fr; }
        .battles-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<section class="section-sm">
    <div class="container">
        <div class="comp-layout">
            {% include 'competitions/_sidebar.html' with active='battles_list' %}

            <div>
                <!-- Stats bar -->
                {% if user.is_authenticated %}
                <div class="battles-stats-bar">
                    <div class="battles-stat-card">
                        <div class="battles-stat-val">{{ stats.total }}</div>
                        <div class="battles-stat-lbl">Jami janglar</div>
                    </div>
                    <div class="battles-stat-card">
                        <div class="battles-stat-val" style="color:#22C55E;">{{ stats.won }}</div>
                        <div class="battles-stat-lbl">G'alabalar</div>
                    </div>
                    <div class="battles-stat-card">
                        <div class="battles-stat-val" style="color:#EF4444;">{{ stats.lost }}</div>
                        <div class="battles-stat-lbl">Mag'lubiyatlar</div>
                    </div>
                    <div class="battles-stat-card">
                        <div class="battles-stat-val" style="color:var(--gray-500);">{{ stats.draw }}</div>
                        <div class="battles-stat-lbl">Durrang</div>
                    </div>
                </div>
                {% endif %}

                <!-- Quick battle -->
                <div class="battles-quick-grid">
                    <a href="{% url 'competitions:battle_create' %}?type=friend" class="quick-card">
                        <div class="quick-icon friend"><i class="bi bi-people-fill" style="color:#2563EB;"></i></div>
                        <div class="quick-title">Do'st bilan</div>
                        <div class="quick-sub">Do'stingizni tanlang</div>
                    </a>
                    <a href="{% url 'competitions:battle_matchmaking' %}" class="quick-card">
                        <div class="quick-icon random"><i class="bi bi-shuffle" style="color:#7C3AED;"></i></div>
                        <div class="quick-title">Random raqib</div>
                        <div class="quick-sub">Tasodifiy o'yinchi bilan</div>
                    </a>
                    <a href="{% url 'competitions:battle_create' %}?type=bot" class="quick-card">
                        <div class="quick-icon bot"><i class="bi bi-robot" style="color:#DC2626;"></i></div>
                        <div class="quick-title">Bot bilan</div>
                        <div class="quick-sub">AI raqibga qarshi</div>
                    </a>
                </div>

                <!-- Pending invites -->
                {% if pending_received %}
                <div style="margin-bottom:1.25rem;">
                    <div style="font-size:0.88rem;font-weight:700;color:var(--dark);margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                        <i class="bi bi-envelope-fill" style="color:var(--primary);"></i> Kelgan takliflar
                    </div>
                    {% for battle in pending_received %}
                    <div class="battle-invite-card">
                        <div class="invite-header">
                            <div class="invite-icon"><i class="bi bi-lightning-fill"></i></div>
                            <div>
                                <div class="invite-title">Jang taklifi!</div>
                                <div class="invite-from">{{ battle.challenger.first_name }} sizni jangga chaqirmoqda</div>
                            </div>
                        </div>
                        <div class="invite-info">
                            <span><i class="bi bi-journal-text"></i> {{ battle.question_count }} savol</span>
                            {% if battle.subject %}<span><i class="bi bi-book"></i> {{ battle.subject.name }}</span>{% endif %}
                            <span><i class="bi bi-clock"></i> {{ battle.total_time }}s</span>
                        </div>
                        <div class="invite-actions">
                            <form action="{% url 'competitions:battle_accept' uuid=battle.uuid %}" method="post" style="flex:1;">
                                {% csrf_token %}
                                <button type="submit" class="invite-btn accept" style="width:100%;"><i class="bi bi-check-lg"></i> Qabul</button>
                            </form>
                            <form action="{% url 'competitions:battle_reject' uuid=battle.uuid %}" method="post" style="flex:1;">
                                {% csrf_token %}
                                <button type="submit" class="invite-btn reject" style="width:100%;"><i class="bi bi-x-lg"></i> Rad etish</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Tabs -->
                <div class="battles-tabs">
                    <button class="battles-tab active" data-tab="active">
                        <i class="bi bi-play-circle"></i> Faol
                        {% if active or pending_sent %}<span class="battles-tab-badge">{{ active.count|add:pending_sent.count }}</span>{% endif %}
                    </button>
                    <button class="battles-tab" data-tab="completed">
                        <i class="bi bi-check-circle"></i> Yakunlangan
                        {% if completed %}<span class="battles-tab-badge">{{ completed.count }}</span>{% endif %}
                    </button>
                </div>

                <!-- Active tab -->
                <div class="battles-tab-content active" id="tab-active">
                    {% if active or pending_sent %}
                    <div class="battles-grid">
                        {% for battle in pending_sent %}
                        <div class="battle-card pending">
                            <div class="battle-card-header">
                                <span class="battle-status pending"><i class="bi bi-hourglass-split"></i> Kutilmoqda</span>
                                <span class="battle-time">{{ battle.created_at|timesince }} oldin</span>
                            </div>
                            <div class="battle-card-body">
                                <div class="battle-players">
                                    <div class="battle-player">
                                        <div class="battle-player-avatar you">
                                            {% if request.user.avatar %}<img src="{{ request.user.avatar.url }}" alt="">
                                            {% else %}{{ request.user.first_name|slice:":1" }}{% endif %}
                                        </div>
                                        <div class="battle-player-name">Siz</div>
                                    </div>
                                    <div class="battle-vs">
                                        <div class="battle-vs-text">VS</div>
                                        {% if battle.subject %}<div class="battle-vs-sub">{{ battle.subject.name }}</div>{% endif %}
                                    </div>
                                    <div class="battle-player">
                                        <div class="battle-player-avatar">
                                            {% if battle.opponent and battle.opponent.avatar %}<img src="{{ battle.opponent.avatar.url }}" alt="">
                                            {% else %}{{ battle.opponent.first_name|slice:":1"|default:"?" }}{% endif %}
                                        </div>
                                        <div class="battle-player-name">{{ battle.opponent.first_name|default:"Kutilmoqda" }}</div>
                                    </div>
                                </div>
                                <div class="battle-info">
                                    <span><i class="bi bi-journal-text"></i> {{ battle.question_count }} savol</span>
                                    <span><i class="bi bi-clock"></i> {{ battle.total_time }}s</span>
                                </div>
                                <div class="battle-actions">
                                    <a href="{% url 'competitions:battle_detail' uuid=battle.uuid %}" class="battle-btn outline">Ko'rish</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {% for battle in active %}
                        <div class="battle-card active-card">
                            <div class="battle-card-header">
                                <span class="battle-status {{ battle.status }}">
                                    {% if battle.status == 'accepted' %}<i class="bi bi-check-circle"></i> Qabul qilindi
                                    {% else %}<i class="bi bi-play-circle"></i> Davom etmoqda{% endif %}
                                </span>
                                <span class="battle-time">{{ battle.created_at|timesince }} oldin</span>
                            </div>
                            <div class="battle-card-body">
                                <div class="battle-players">
                                    <div class="battle-player">
                                        <div class="battle-player-avatar {% if battle.challenger == request.user %}you{% endif %}">
                                            {% if battle.challenger.avatar %}<img src="{{ battle.challenger.avatar.url }}" alt="">
                                            {% else %}{{ battle.challenger.first_name|slice:":1" }}{% endif %}
                                        </div>
                                        <div class="battle-player-name">{% if battle.challenger == request.user %}Siz{% else %}{{ battle.challenger.first_name }}{% endif %}</div>
                                    </div>
                                    <div class="battle-vs">
                                        <div class="battle-vs-text">VS</div>
                                        {% if battle.subject %}<div class="battle-vs-sub">{{ battle.subject.name }}</div>{% endif %}
                                    </div>
                                    <div class="battle-player">
                                        <div class="battle-player-avatar {% if battle.opponent == request.user %}you{% elif battle.opponent_type == 'bot' %}bot{% endif %}">
                                            {% if battle.opponent_type == 'bot' %}ü§ñ
                                            {% elif battle.opponent and battle.opponent.avatar %}<img src="{{ battle.opponent.avatar.url }}" alt="">
                                            {% else %}{{ battle.opponent.first_name|slice:":1"|default:"?" }}{% endif %}
                                        </div>
                                        <div class="battle-player-name">
                                            {% if battle.opponent_type == 'bot' %}Bot ({{ battle.get_bot_difficulty_display }})
                                            {% elif battle.opponent == request.user %}Siz
                                            {% else %}{{ battle.opponent.first_name|default:"Kutilmoqda" }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="battle-info">
                                    <span><i class="bi bi-journal-text"></i> {{ battle.question_count }} savol</span>
                                    <span><i class="bi bi-clock"></i> {{ battle.total_time }}s</span>
                                </div>
                                <div class="battle-actions">
                                    <a href="{% url 'competitions:battle_play' uuid=battle.uuid %}" class="battle-btn success">
                                        <i class="bi bi-play-fill"></i> O'ynash
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="battles-empty">
                        <i class="bi bi-lightning"></i>
                        <h5 style="font-weight:700;margin-bottom:0.5rem;">Faol janglar yo'q</h5>
                        <p style="color:var(--gray-500);margin-bottom:1rem;">Yangi jang boshlang yoki taklif yuboring</p>
                        <a href="{% url 'competitions:battle_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i> Yangi jang
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Completed tab -->
                <div class="battles-tab-content" id="tab-completed">
                    {% if completed %}
                    <div class="battles-grid">
                        {% for battle in completed %}
                        <div class="battle-card completed-card">
                            <div class="battle-card-header">
                                <span class="battle-status completed"><i class="bi bi-check-circle"></i> Yakunlangan</span>
                                <span class="battle-time">{{ battle.completed_at|timesince }} oldin</span>
                            </div>
                            <div class="battle-card-body">
                                <div class="battle-players">
                                    <div class="battle-player">
                                        <div class="battle-player-avatar {% if battle.challenger == request.user %}you{% endif %} {% if battle.winner == battle.challenger %}winner{% endif %}">
                                            {% if battle.challenger.avatar %}<img src="{{ battle.challenger.avatar.url }}" alt="">
                                            {% else %}{{ battle.challenger.first_name|slice:":1" }}{% endif %}
                                        </div>
                                        <div class="battle-player-name">{% if battle.challenger == request.user %}Siz{% else %}{{ battle.challenger.first_name }}{% endif %}</div>
                                        <div class="battle-player-score {% if battle.winner == battle.challenger %}winner{% endif %}">{{ battle.challenger_correct }}/{{ battle.question_count }}</div>
                                    </div>
                                    <div class="battle-vs">
                                        <div class="battle-vs-text" style="font-size:1.5rem;">
                                            {% if battle.is_draw %}ü§ù{% elif battle.winner == request.user %}üèÜ{% else %}üò¢{% endif %}
                                        </div>
                                    </div>
                                    <div class="battle-player">
                                        <div class="battle-player-avatar {% if battle.opponent == request.user %}you{% elif battle.opponent_type == 'bot' %}bot{% endif %} {% if battle.winner == battle.opponent or battle.winner_is_bot %}winner{% endif %}">
                                            {% if battle.opponent_type == 'bot' %}ü§ñ
                                            {% elif battle.opponent and battle.opponent.avatar %}<img src="{{ battle.opponent.avatar.url }}" alt="">
                                            {% else %}{{ battle.opponent.first_name|slice:":1"|default:"?" }}{% endif %}
                                        </div>
                                        <div class="battle-player-name">
                                            {% if battle.opponent_type == 'bot' %}Bot
                                            {% elif battle.opponent == request.user %}Siz
                                            {% else %}{{ battle.opponent.first_name|default:"-" }}{% endif %}
                                        </div>
                                        <div class="battle-player-score {% if battle.winner == battle.opponent or battle.winner_is_bot %}winner{% endif %}">{{ battle.opponent_correct }}/{{ battle.question_count }}</div>
                                    </div>
                                </div>
                                <div class="battle-actions">
                                    <a href="{% url 'competitions:battle_result' uuid=battle.uuid %}" class="battle-btn outline">Natija</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="battles-empty">
                        <i class="bi bi-clipboard"></i>
                        <h5 style="font-weight:700;margin-bottom:0.5rem;">Yakunlangan janglar yo'q</h5>
                        <p style="color:var(--gray-500);margin:0;">Birinchi jangingizni boshlang!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.battles-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.battles-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.battles-tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});
</script>
{% endblock %}
