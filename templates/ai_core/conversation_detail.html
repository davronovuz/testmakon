{% extends 'base.html' %}
{% load static %}

{% block title %}Chat | AI Mentor{% endblock %}

{% block extra_css %}
<style>
    /* Chat Layout */
    .chat-container {
        height: calc(100vh - 140px); /* Navbar balandligini hisobga olib */
        display: flex;
        flex-direction: column;
        background: #f8fafc;
    }

    .messages-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Message Bubbles */
    .message {
        display: flex;
        gap: 1rem;
        max-width: 85%;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-content {
        padding: 1rem 1.25rem;
        border-radius: 18px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.6;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .message.user .message-content {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
        background: white;
        color: var(--dark);
        border: 1px solid var(--gray-200);
        border-bottom-left-radius: 4px;
    }

    .avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }

    .input-area {
        background: white;
        padding: 1rem;
        border-top: 1px solid var(--gray-200);
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="bg-white border-bottom px-4 py-3 d-flex align-items-center justify-content-between shadow-sm z-1">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'ai_core:ai_mentor' %}" class="btn btn-light btn-sm rounded-circle"><i class="bi bi-arrow-left"></i></a>
            <div>
                <h6 class="fw-bold mb-0 text-dark">{{ conversation.title }}</h6>
                <small class="text-success"><i class="bi bi-circle-fill" style="font-size: 8px;"></i> AI Online</small>
            </div>
        </div>
        <div class="dropdown">
            <button class="btn btn-light btn-sm" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item text-danger" href="#">Suhbatni o'chirish</a></li>
            </ul>
        </div>
    </div>

    <div class="messages-area" id="messagesArea">
        {% for msg in messages %}
            <div class="message {{ msg.role }}">
                <div class="avatar shadow-sm {% if msg.role == 'user' %}bg-dark text-white{% else %}bg-primary text-white{% endif %}">
                    {% if msg.role == 'user' %}
                        <i class="bi bi-person"></i>
                    {% else %}
                        <i class="bi bi-robot"></i>
                    {% endif %}
                </div>
                <div class="message-content">
                    {{ msg.content|linebreaksbr }}
                </div>
            </div>
        {% empty %}
            <div class="text-center text-muted my-auto">
                <div class="icon-box-lg bg-light rounded-circle mb-3 mx-auto">
                    <i class="bi bi-stars text-warning"></i>
                </div>
                <h5>Salom! Men sizning AI yordamchingizman.</h5>
                <p>Menga istalgan savolingizni bering yoki yordam so'rang.</p>
            </div>
        {% endfor %}
    </div>

    <div class="input-area">
        <form method="post" class="container">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" name="message" class="form-control form-control-lg bg-light border-0"
                       placeholder="Xabar yozing..." required autocomplete="off" autofocus>
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Auto scroll to bottom
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
</script>
{% endblock %}