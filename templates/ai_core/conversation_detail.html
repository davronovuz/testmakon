{% extends 'base.html' %}
{% load static %}

{% block title %}{{ conversation.title|default:"Yangi suhbat" }} | AI Mentor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<style>
    .chat-page {
        height: calc(100vh - 65px);
        display: flex;
        flex-direction: column;
        background: var(--gray-50);
        overflow: hidden;
    }
    [data-theme="dark"] .chat-page { background: var(--dark); }

    .chat-header {
        flex-shrink: 0;
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--gray-200);
        padding: 0.65rem 1.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 20;
    }
    [data-theme="dark"] .chat-header {
        background: rgba(15,23,42,0.98);
        border-color: var(--dark-800);
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .chat-back {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid var(--gray-200);
        background: var(--white);
        color: var(--dark-600);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    .chat-back:hover { background: var(--gray-100); color: var(--primary-dark); border-color: var(--gray-300); }
    [data-theme="dark"] .chat-back {
        background: var(--dark-800);
        border-color: var(--dark-700);
        color: var(--gray-300);
    }
    [data-theme="dark"] .chat-back:hover { background: var(--dark-700); color: var(--primary); }

    .chat-title-wrap h1 {
        font-size: 1rem;
        font-weight: 800;
        color: var(--dark);
        margin: 0 0 0.15rem 0;
        line-height: 1.3;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    [data-theme="dark"] .chat-title-wrap h1 { color: var(--gray-100); }
    .chat-title-wrap .chat-meta {
        font-size: 0.7rem;
        color: var(--gray-500);
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    .chat-meta-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #22C55E;
        animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

    .chat-header-actions .btn-icon {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid var(--gray-200);
        background: var(--white);
        color: var(--dark-600);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .chat-header-actions .btn-icon:hover { background: var(--gray-100); color: var(--primary); }
    [data-theme="dark"] .chat-header-actions .btn-icon {
        background: var(--dark-800);
        border-color: var(--dark-700);
        color: var(--gray-400);
    }
    [data-theme="dark"] .chat-header-actions .btn-icon:hover { background: var(--dark-700); color: var(--primary); }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 1.25rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        scroll-behavior: smooth;
    }
    .chat-messages-inner { max-width: 820px; margin: 0 auto; width: 100%; }

    .msg-row {
        display: flex;
        gap: 0.85rem;
        max-width: 100%;
        animation: msgIn 0.25s ease-out;
    }
    @keyframes msgIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .msg-row.user { flex-direction: row-reverse; }
    .msg-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }
    .msg-row.user .msg-avatar {
        background: var(--dark-700);
        color: #fff;
    }
    .msg-row.assistant .msg-avatar {
        background: var(--gradient-primary);
        color: #fff;
        box-shadow: 0 2px 8px rgba(139,197,64,0.25);
    }
    .msg-body { min-width: 0; max-width: 85%; }
    .msg-bubble {
        padding: 0.95rem 1.2rem;
        border-radius: 1rem;
        font-size: 0.95rem;
        line-height: 1.6;
        word-wrap: break-word;
    }
    .msg-row.user .msg-bubble {
        background: var(--dark-800);
        color: #fff;
        border-top-right-radius: 0.25rem;
    }
    [data-theme="dark"] .msg-row.user .msg-bubble { background: var(--dark-600); }
    .msg-row.assistant .msg-bubble {
        background: var(--white);
        color: var(--dark);
        border: 1px solid var(--gray-200);
        border-top-left-radius: 0.25rem;
    }
    [data-theme="dark"] .msg-row.assistant .msg-bubble {
        background: var(--dark-800);
        border-color: var(--dark-700);
        color: var(--gray-200);
    }
    .msg-time {
        font-size: 0.68rem;
        color: var(--gray-400);
        margin-top: 0.35rem;
        padding: 0 0.15rem;
    }
    .msg-row.user .msg-time { text-align: right; }

    .markdown-body p:last-child { margin-bottom: 0; }
    .markdown-body pre {
        background: #1a1a1a;
        border-radius: 0.6rem;
        padding: 1rem;
        margin: 0.75rem 0;
        overflow-x: auto;
        font-size: 0.85em;
    }
    .markdown-body code { font-family: 'Consolas', 'Monaco', monospace; }
    .markdown-body :not(pre) > code {
        background: rgba(139,197,64,0.15);
        color: var(--primary-dark);
        padding: 0.15em 0.4em;
        border-radius: 0.35em;
        font-size: 0.9em;
    }
    [data-theme="dark"] .markdown-body :not(pre) > code {
        background: rgba(139,197,64,0.2);
        color: var(--primary-light);
    }
    .markdown-body ul, .markdown-body ol { padding-left: 1.4rem; margin: 0.5rem 0; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-size: 1.05rem; margin: 1rem 0 0.5rem; font-weight: 700; }
    .markdown-body a { color: var(--primary); text-decoration: underline; }

    .chat-welcome {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        text-align: center;
    }
    .chat-welcome-icon {
        width: 72px;
        height: 72px;
        border-radius: 20px;
        background: var(--gradient-primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 8px 24px rgba(139,197,64,0.35);
    }
    .chat-welcome h2 {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
    }
    [data-theme="dark"] .chat-welcome h2 { color: var(--gray-100); }
    .chat-welcome p {
        font-size: 0.9rem;
        color: var(--gray-500);
        max-width: 380px;
        margin: 0 auto 1.5rem;
        line-height: 1.55;
    }
    .chat-prompts {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }
    .chat-prompt-btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--dark-600);
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .chat-prompt-btn:hover {
        border-color: var(--primary);
        color: var(--primary-dark);
        background: rgba(139,197,64,0.06);
    }
    [data-theme="dark"] .chat-prompt-btn {
        background: var(--dark-800);
        border-color: var(--dark-700);
        color: var(--gray-300);
    }
    [data-theme="dark"] .chat-prompt-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(139,197,64,0.1);
    }

    .typing-wrap {
        display: flex;
        gap: 0.85rem;
        max-width: 820px;
        margin: 0 auto;
        padding: 0 0 1rem;
    }
    .typing-wrap.hidden { display: none !important; }
    .typing-bubble {
        padding: 1rem 1.25rem;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 1rem;
        border-top-left-radius: 0.25rem;
        width: fit-content;
        display: flex;
        gap: 5px;
        align-items: center;
    }
    [data-theme="dark"] .typing-bubble {
        background: var(--dark-800);
        border-color: var(--dark-700);
    }
    .typing-bubble span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--gray-400);
        animation: typingBounce 1.2s ease-in-out infinite both;
    }
    .typing-bubble span:nth-child(1) { animation-delay: -0.32s; }
    .typing-bubble span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingBounce { 0%,80%,100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

    .chat-input-bar {
        flex-shrink: 0;
        background: var(--white);
        border-top: 1px solid var(--gray-200);
        padding: 1rem 1.25rem 1.25rem;
        z-index: 10;
    }
    [data-theme="dark"] .chat-input-bar {
        background: var(--dark-800);
        border-color: var(--dark-700);
    }
    .chat-input-box {
        max-width: 820px;
        margin: 0 auto;
        display: flex;
        align-items: flex-end;
        gap: 0.65rem;
        background: var(--gray-50);
        border: 2px solid var(--gray-200);
        border-radius: 1rem;
        padding: 0.5rem 0.6rem 0.5rem 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .chat-input-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-glow);
        background: var(--white);
    }
    [data-theme="dark"] .chat-input-box { background: var(--dark); border-color: var(--dark-600); }
    [data-theme="dark"] .chat-input-box:focus-within {
        background: var(--dark-800);
        border-color: var(--primary);
    }
    .chat-input-box.disabled { opacity: 0.85; pointer-events: none; }

    .chat-input {
        flex: 1;
        border: none;
        background: transparent;
        resize: none;
        min-height: 24px;
        max-height: 160px;
        font-size: 0.95rem;
        line-height: 1.5;
        color: var(--dark);
    }
    .chat-input::placeholder { color: var(--gray-400); }
    .chat-input:focus { outline: none; }
    [data-theme="dark"] .chat-input { color: var(--gray-100); }

    .chat-send {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: var(--gradient-primary);
        color: #fff;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .chat-send:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 14px rgba(139,197,64,0.4);
    }
    .chat-send:disabled {
        background: var(--gray-300);
        cursor: not-allowed;
        transform: none;
    }
    [data-theme="dark"] .chat-send:disabled { background: var(--dark-600); }

    .chat-error {
        max-width: 820px;
        margin: 0.5rem auto 0;
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
        color: #B91C1C;
        background: #FEE2E2;
        border-radius: 0.5rem;
        display: none;
    }
    .chat-error.show { display: block; }
    [data-theme="dark"] .chat-error { background: rgba(185,28,28,0.2); color: #FCA5A5; }

    .chat-footer-note {
        text-align: center;
        margin-top: 0.5rem;
        font-size: 0.7rem;
        color: var(--gray-400);
    }

    @media (max-width: 768px) {
        .chat-page { height: calc(100vh - 56px); }
        .chat-messages { padding: 1rem; }
        .msg-avatar { width: 34px; height: 34px; font-size: 1rem; }
        .msg-body { max-width: 90%; }
        .chat-title-wrap h1 { font-size: 0.9rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-page">
    <header class="chat-header">
        <div class="chat-header-left">
            <a href="{% url 'ai_core:ai_mentor' %}" class="chat-back" aria-label="Orqaga">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="chat-title-wrap">
                <h1 id="chatTitle">
                    <i class="bi bi-robot text-primary"></i>
                    <span id="chatTitleText">{{ conversation.title|default:"Yangi suhbat"|truncatechars:40 }}</span>
                </h1>
                <div class="chat-meta">
                    <span class="chat-meta-dot"></span>
                    <span>AI online</span>
                    <span>¬∑</span>
                    <span>Gemini 2.5 Flash</span>
                </div>
            </div>
        </div>
        <div class="chat-header-actions">
            <div class="dropdown">
                <button class="btn-icon" type="button" data-bs-toggle="dropdown" aria-label="Menyu">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 py-2">
                    <li><a class="dropdown-item" href="{% url 'ai_core:ai_chat' %}"><i class="bi bi-plus-lg me-2"></i> Yangi suhbat</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" id="deleteChatBtn" data-uuid="{{ conversation.uuid }}"><i class="bi bi-trash me-2"></i> O'chirish</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="chat-messages" id="chatMessages">
        <div class="chat-messages-inner" id="messagesInner">
            {% for msg in messages %}
            <div class="msg-row {{ msg.role }}">
                <div class="msg-avatar">
                    {% if msg.role == 'user' %}<i class="bi bi-person-fill"></i>{% else %}<i class="bi bi-stars"></i>{% endif %}
                </div>
                <div class="msg-body">
                    <div class="msg-bubble markdown-body">{{ msg.content }}</div>
                    <div class="msg-time">{{ msg.created_at|date:"H:i" }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="typing-wrap hidden" id="typingWrap">
            <div class="msg-avatar"><i class="bi bi-stars"></i></div>
            <div class="typing-bubble">
                <span></span><span></span><span></span>
            </div>
        </div>
    </div>

    {% if not messages %}
    <div class="chat-welcome" id="chatWelcome">
        <div class="chat-welcome-icon"><i class="bi bi-robot"></i></div>
        <h2>Salom, {{ request.user.first_name }}!</h2>
        <p>Men sizning AI mentorman. DTM, fanlar, universitetlar ‚Äî istalgan savolingizni yozing.</p>
        <div class="chat-prompts">
            <button type="button" class="chat-prompt-btn" data-prompt="DTM testlariga qanday tayyorlanish kerak?">üìù DTM ga tayyorlanish</button>
            <button type="button" class="chat-prompt-btn" data-prompt="Fizika formulalarini tushuntirib ber">‚ö° Fizika</button>
            <button type="button" class="chat-prompt-btn" data-prompt="Toshkentdagi eng yaxshi IT universitetlari">üéì IT universitetlar</button>
            <button type="button" class="chat-prompt-btn" data-prompt="Matematikadan muhim formulalar">üìê Matematika</button>
        </div>
    </div>
    {% endif %}

    <div class="chat-input-bar">
        <div class="chat-input-box" id="inputBox">
            <textarea class="chat-input" id="chatInput" rows="1" placeholder="Savolingizni yozing..." autofocus></textarea>
            <button type="button" class="chat-send" id="sendBtn" disabled aria-label="Yuborish">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
        <div class="chat-error" id="chatError"></div>
        <p class="chat-footer-note">AI xato qilishi mumkin. Muhim ma'lumotlarni tekshiring.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script>
(function() {
    const API_URL = '{% url "ai_core:api_chat" %}';
    const CSRF_TOKEN = '{{ csrf_token }}';
    const CONVERSATION_UUID = '{{ conversation.uuid }}';

    const messagesInner = document.getElementById('messagesInner');
    const chatWelcome = document.getElementById('chatWelcome');
    const typingWrap = document.getElementById('typingWrap');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const inputBox = document.getElementById('inputBox');
    const chatError = document.getElementById('chatError');
    const chatMessages = document.getElementById('chatMessages');
    const chatTitleText = document.getElementById('chatTitleText');

    function scrollBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderMarkdown(text) {
        if (typeof marked === 'undefined') return escapeHtml(text);
        try {
            // Protect LaTeX math from markdown parser
            const saved = [];
            let processed = text.replace(/\$\$([\s\S]+?)\$\$/g, function(m) {
                saved.push(m);
                return '\x02MATH' + (saved.length - 1) + '\x03';
            });
            processed = processed.replace(/\$([^\$\n]+?)\$/g, function(m) {
                saved.push(m);
                return '\x02MATH' + (saved.length - 1) + '\x03';
            });
            let html = marked.parse(processed, { breaks: true });
            // Restore math blocks
            html = html.replace(/\x02MATH(\d+)\x03/g, function(_, i) {
                return saved[+i];
            });
            return html;
        } catch (e) {
            return escapeHtml(text);
        }
    }

    function renderMath(el) {
        if (typeof renderMathInElement !== 'undefined' && el) {
            renderMathInElement(el, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true},
                ],
                throwOnError: false,
                ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            });
        }
    }

    function applyHighlight(el) {
        if (typeof hljs !== 'undefined' && el) {
            el.querySelectorAll('pre code').forEach(function(block) {
                hljs.highlightElement(block);
            });
        }
    }

    function addMessage(role, content, isMarkdown) {
        if (!messagesInner) return;
        if (chatWelcome) chatWelcome.style.display = 'none';

        const row = document.createElement('div');
        row.className = 'msg-row ' + role;

        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.innerHTML = role === 'user' ? '<i class="bi bi-person-fill"></i>' : '<i class="bi bi-stars"></i>';

        const body = document.createElement('div');
        body.className = 'msg-body';

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble markdown-body';
        if (isMarkdown) {
            bubble.innerHTML = renderMarkdown(content);
            applyHighlight(bubble);
            renderMath(bubble);
        } else {
            bubble.textContent = content;
        }

        const time = document.createElement('div');
        time.className = 'msg-time';
        time.textContent = new Date().toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' });

        body.appendChild(bubble);
        body.appendChild(time);
        row.appendChild(avatar);
        row.appendChild(body);
        messagesInner.appendChild(row);
        scrollBottom();
    }

    function setLoading(loading) {
        sendBtn.disabled = loading;
        inputBox.classList.toggle('disabled', loading);
        typingWrap.classList.toggle('hidden', !loading);
        if (loading) scrollBottom();
        chatError.classList.remove('show');
    }

    function setError(msg) {
        chatError.textContent = msg || 'Xatolik yuz berdi. Qayta urinib ko‚Äòring.';
        chatError.classList.add('show');
        scrollBottom();
    }

    function updateTitle(title) {
        if (title && chatTitleText) chatTitleText.textContent = title.length > 40 ? title.slice(0, 40) + '‚Ä¶' : title;
    }

    const TASK_STATUS_URL = '{% url "ai_core:api_task_status" task_id="TASK_ID_PLACEHOLDER" %}';

    function pollTaskStatus(taskId) {
        const url = TASK_STATUS_URL.replace('TASK_ID_PLACEHOLDER', taskId);
        fetch(url)
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.status === 'done') {
                    addMessage('assistant', data.response, true);
                    if (data.title) updateTitle(data.title);
                    setLoading(false);
                } else if (data.status === 'error') {
                    setError('AI javob berishda xatolik yuz berdi');
                    setLoading(false);
                } else {
                    setTimeout(function() { pollTaskStatus(taskId); }, 1500);
                }
            })
            .catch(function() {
                setError('Ulanishda xatolik');
                setLoading(false);
            });
    }

    function sendMessage() {
        const text = (chatInput.value || '').trim();
        if (!text) return;

        chatInput.value = '';
        chatInput.style.height = 'auto';

        addMessage('user', text, false);
        setLoading(true);

        fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: JSON.stringify({
                message: text,
                conversation_uuid: CONVERSATION_UUID || undefined
            })
        })
        .then(function(res) {
            return res.json().then(function(data) {
                if (!res.ok) throw new Error(data.error || 'Xatolik');
                return data;
            });
        })
        .then(function(data) {
            if (data.task_id) {
                pollTaskStatus(data.task_id);
            } else if (data.response) {
                addMessage('assistant', data.response, true);
                if (data.title) updateTitle(data.title);
                setLoading(false);
            }
        })
        .catch(function(err) {
            setError(err.message || 'Javob olinmadi');
            setLoading(false);
        });
    }

    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('input', function() {
        sendBtn.disabled = !this.value.trim();
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 160) + 'px';
    });

    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (this.value.trim()) sendMessage();
        }
    });

    document.querySelectorAll('.chat-prompt-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var prompt = this.getAttribute('data-prompt');
            if (prompt) {
                chatInput.value = prompt;
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 160) + 'px';
                sendBtn.disabled = false;
                chatInput.focus();
            }
        });
    });

    document.querySelectorAll('#messagesInner .markdown-body').forEach(function(el) {
        el.innerHTML = renderMarkdown(el.textContent.trim());
        applyHighlight(el);
        renderMath(el);
    });
    scrollBottom();

    // Delete conversation
    var deleteBtn = document.getElementById('deleteChatBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!confirm("Suhbatni o'chirishni xohlaysizmi?")) return;
            var uuid = this.dataset.uuid;
            var deleteUrl = '{% url "ai_core:conversation_delete" uuid="00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', uuid);
            fetch(deleteUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'deleted') {
                    window.location.href = '{% url "ai_core:conversations_list" %}';
                }
            })
            .catch(function() {
                alert('O\'chirishda xatolik yuz berdi.');
            });
        });
    }
})();
</script>
{% endblock %}
