{% extends 'base.html' %}
{% load static %}

{% block title %}{{ plan.title }} | O'quv Reja{% endblock %}

{% block extra_css %}
<style>
{% include 'includes/_sidebar_css.html' %}

.detail-header {
    margin-bottom: 1.5rem;
}

.detail-title {
    font-size: 1.35rem;
    font-weight: 800;
    color: var(--dark);
    margin: 0 0 0.35rem;
}

.detail-meta {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    font-size: 0.8rem;
    color: var(--gray-400);
}

.detail-meta i {
    margin-right: 0.2rem;
}

.detail-progress {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem 1.5rem;
    margin-bottom: 2rem;
}

.detail-progress-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.detail-progress-label {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--dark);
}

.detail-progress-pct {
    font-weight: 800;
    font-size: 1rem;
    color: var(--primary);
}

.detail-progress-bar {
    width: 100%;
    height: 10px;
    background: var(--gray-100);
    border-radius: 999px;
    overflow: hidden;
}

.detail-progress-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 999px;
    transition: width 0.3s ease;
}

.detail-progress-info {
    font-size: 0.8rem;
    color: var(--gray-400);
    margin-top: 0.5rem;
}

.tasks-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 1rem;
}

.task-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.2s ease;
}

.task-card:hover {
    transform: translateX(4px);
}

.task-card.completed {
    opacity: 0.65;
    background: var(--gray-50);
}

.task-check {
    flex-shrink: 0;
}

.task-check-done {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #16a34a;
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.95rem;
}

.task-check-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid var(--gray-200);
    color: var(--gray-400);
    text-decoration: none;
    transition: border-color 0.15s ease;
}

.task-check-link:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.task-body {
    flex: 1;
    min-width: 0;
}

.task-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
}

.task-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--dark);
    margin: 0;
}

.task-title.done {
    text-decoration: line-through;
    color: var(--gray-400);
}

.task-type-badge {
    flex-shrink: 0;
    padding: 0.15rem 0.6rem;
    font-size: 0.72rem;
    font-weight: 600;
    border: 1px solid var(--gray-200);
    border-radius: 999px;
    background: var(--gray-50);
    color: var(--dark);
}

.task-subtitle {
    font-size: 0.8rem;
    color: var(--gray-400);
    margin: 0.2rem 0 0;
}

.task-subtitle i {
    margin-right: 0.2rem;
}

.tasks-empty {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray-400);
}

.ai-advice-card {
    background: rgba(139, 92, 246, 0.06);
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-top: 2rem;
}

.ai-advice-title {
    font-size: 1rem;
    font-weight: 700;
    color: #7C3AED;
    margin: 0 0 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-advice-text {
    font-size: 0.88rem;
    color: var(--dark);
    opacity: 0.8;
    line-height: 1.6;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="tl-layout">
        {% include 'includes/_sidebar.html' with active='plans' %}
        <main>
            <div class="detail-header">
                <h1 class="detail-title">{{ plan.title }}</h1>
                <div class="detail-meta">
                    <span><i class="bi bi-calendar3"></i> {{ plan.created_at|date:"d.m.Y" }}</span>
                    <span><i class="bi bi-flag"></i> Maqsad: {{ plan.target_score }} ball</span>
                </div>
            </div>

            <div class="detail-progress">
                <div class="detail-progress-top">
                    <span class="detail-progress-label">Umumiy Progress</span>
                    <span class="detail-progress-pct">{{ plan.progress_percentage }}%</span>
                </div>
                <div class="detail-progress-bar">
                    <div class="detail-progress-fill" style="width: {{ plan.progress_percentage }}%"></div>
                </div>
                <div class="detail-progress-info">{{ plan.completed_tasks }} / {{ plan.total_tasks }} vazifa bajarildi</div>
            </div>

            <h2 class="tasks-title">Vazifalar ro'yxati</h2>

            {% for task in tasks %}
            <div class="task-card {% if task.is_completed %}completed{% endif %}">
                <div class="task-check">
                    {% if task.is_completed %}
                        <div class="task-check-done">
                            <i class="bi bi-check-lg"></i>
                        </div>
                    {% else %}
                        <a href="{% url 'ai_core:task_complete' task_id=task.id %}" class="task-check-link">
                            <i class="bi bi-circle"></i>
                        </a>
                    {% endif %}
                </div>

                <div class="task-body">
                    <div class="task-title-row">
                        <h3 class="task-title {% if task.is_completed %}done{% endif %}">{{ task.title }}</h3>
                        <span class="task-type-badge">{{ task.get_task_type_display }}</span>
                    </div>
                    <p class="task-subtitle">
                        <i class="bi bi-clock"></i> {{ task.estimated_minutes }} daqiqa &bull; {{ task.subject.name }}
                    </p>
                </div>
            </div>
            {% empty %}
            <div class="tasks-empty">
                Vazifalar hali shakllantirilmagan.
            </div>
            {% endfor %}

            <div class="ai-advice-card">
                <div class="ai-advice-title">
                    <i class="bi bi-robot"></i> AI Maslahati
                </div>
                <p class="ai-advice-text">
                    {{ plan.ai_analysis|default:"Rejani muntazam bajarib boring. Agar qiyinchilik tug'ilsa, AI Mentordan yordam so'rang." }}
                </p>
            </div>
        </main>
    </div>
</div>
{% endblock %}
