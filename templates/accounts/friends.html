{% extends 'base.html' %}
{% load static %}

{% block title %}Do'stlarim{% endblock %}

{% block extra_css %}
<style>
  .friends-page { background: var(--bg-secondary); min-height: 100vh; padding: 2rem 0; }
  .page-header { background: white; border-radius: 16px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
  .page-header h1 { font-size: 1.5rem; font-weight: 700; color: var(--dark); margin: 0; }
  .search-card { background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
  .search-card h2 { font-size: 1rem; font-weight: 600; color: var(--dark); margin-bottom: 1rem; }
  .search-input-wrap { position: relative; }
  .search-input-wrap input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; outline: none; transition: border-color 0.2s; }
  .search-input-wrap input:focus { border-color: var(--primary); }
  .search-input-wrap .search-icon { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 1rem; }
  .search-results { margin-top: 1rem; }
  .user-card { display: flex; align-items: center; gap: 0.9rem; padding: 0.75rem; border-radius: 10px; border: 1px solid #f1f5f9; transition: background 0.15s; }
  .user-card:hover { background: #f8fafc; }
  .user-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
  .user-avatar-placeholder { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; flex-shrink: 0; }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-weight: 600; color: var(--dark); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-level { font-size: 0.75rem; color: #64748b; }
  .btn-add { padding: 0.35rem 0.9rem; font-size: 0.8rem; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
  .btn-add-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
  .btn-add-primary:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-add-sent { background: #f1f5f9; color: #64748b; cursor: default; }
  .section-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 1.5rem; }
  .section-header { padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; }
  .section-header h2 { font-size: 1rem; font-weight: 700; color: var(--dark); margin: 0; display: flex; align-items: center; gap: 0.5rem; }
  .badge-count { background: var(--primary); color: white; border-radius: 20px; padding: 0.1rem 0.5rem; font-size: 0.72rem; font-weight: 700; }
  .request-item { display: flex; align-items: center; gap: 0.9rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f8fafc; }
  .request-item:last-child { border-bottom: none; }
  .request-actions { display: flex; gap: 0.5rem; margin-left: auto; }
  .btn-accept { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 0.35rem 0.85rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
  .btn-decline { background: #f1f5f9; color: #64748b; border: none; padding: 0.35rem 0.85rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
  .btn-accept:hover { opacity: 0.9; color: white; }
  .btn-decline:hover { background: #e2e8f0; color: #475569; }
  .friends-grid { padding: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
  .friend-card { padding: 1rem; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; transition: all 0.2s; }
  .friend-card:hover { border-color: #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .friend-avatar-wrap { position: relative; display: inline-block; margin-bottom: 0.5rem; }
  .friend-avatar { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
  .friend-avatar-placeholder { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem; margin: 0 auto; }
  .online-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; background: #22c55e; border: 2px solid white; }
  .offline-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; border: 2px solid white; }
  .friend-name { font-weight: 600; font-size: 0.85rem; color: var(--dark); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .friend-online-text { font-size: 0.72rem; color: #22c55e; font-weight: 500; }
  .friend-offline-text { font-size: 0.72rem; color: #94a3b8; }
  .friend-actions { margin-top: 0.6rem; display: flex; gap: 0.4rem; justify-content: center; }
  .btn-battle { font-size: 0.72rem; padding: 0.25rem 0.65rem; border-radius: 6px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; }
  .btn-battle:hover { opacity: 0.9; color: white; }
  .btn-remove { font-size: 0.72rem; padding: 0.25rem 0.65rem; border-radius: 6px; background: #fee2e2; color: #ef4444; border: none; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; }
  .btn-remove:hover { background: #fecaca; color: #dc2626; }
  .empty-state { padding: 2.5rem 1.5rem; text-align: center; color: #94a3b8; }
  .empty-state i { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }
  .empty-state p { font-size: 0.9rem; margin: 0; }
</style>
{% endblock %}

{% block content %}
<div class="friends-page">
  <div class="container">
    <div class="page-header">
      <h1><i class="bi bi-people-fill me-2" style="color:var(--primary);"></i>Do'stlarim</h1>
      <a href="{% url 'competitions:battle_create' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-lightning-charge-fill me-1"></i>Jang boshlash
      </a>
    </div>

    <div class="row g-4">
      <div class="col-lg-4">
        <!-- Qidiruv -->
        <div class="search-card">
          <h2><i class="bi bi-search me-2" style="color:var(--primary);"></i>Do'st qidirish</h2>
          <div class="search-input-wrap">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="friendSearchInput" placeholder="Ism yoki telefon raqam..." autocomplete="off">
          </div>
          <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Kiruvchi so'rovlar -->
        {% if pending_requests %}
        <div class="section-card">
          <div class="section-header">
            <h2>
              <i class="bi bi-person-plus-fill" style="color:var(--primary);"></i>
              Kutilayotgan so'rovlar
              <span class="badge-count">{{ pending_count }}</span>
            </h2>
          </div>
          {% for req in pending_requests %}
          <div class="request-item">
            <div class="friend-avatar-wrap">
              {% if req.from_user.avatar %}
                <img src="{{ req.from_user.avatar.url }}" class="user-avatar" alt="">
              {% else %}
                <div class="user-avatar-placeholder">{{ req.from_user.first_name|first }}</div>
              {% endif %}
            </div>
            <div class="user-info">
              <div class="user-name">{{ req.from_user.first_name }} {{ req.from_user.last_name }}</div>
              <div class="user-level">{{ req.created_at|timesince }} oldin</div>
            </div>
            <div class="request-actions">
              <a href="{% url 'accounts:friend_accept' req.id %}" class="btn-accept">
                <i class="bi bi-check-lg"></i>
              </a>
              <a href="{% url 'accounts:friend_reject' req.id %}" class="btn-decline">
                <i class="bi bi-x-lg"></i>
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <div class="col-lg-8">
        <!-- Do'stlar ro'yxati -->
        <div class="section-card">
          <div class="section-header">
            <h2>
              <i class="bi bi-people-fill" style="color:var(--primary);"></i>
              Barcha do'stlar
              <span class="badge-count">{{ friends|length }}</span>
            </h2>
          </div>

          {% if friends %}
          <div class="friends-grid">
            {% for friend in friends %}
            <div class="friend-card" data-user-id="{{ friend.id }}">
              <div class="friend-avatar-wrap">
                {% if friend.avatar %}
                  <img src="{{ friend.avatar.url }}" class="friend-avatar" alt="{{ friend.first_name }}">
                {% else %}
                  <div class="friend-avatar-placeholder">{{ friend.first_name|first }}</div>
                {% endif %}
                {% if friend.is_online %}
                  <span class="online-dot" title="Online"></span>
                {% else %}
                  <span class="offline-dot" title="Offline"></span>
                {% endif %}
              </div>
              <div class="friend-name">{{ friend.first_name }} {{ friend.last_name }}</div>
              {% if friend.is_online %}
                <div class="friend-online-text"><i class="bi bi-circle-fill" style="font-size:0.55rem;"></i> Online</div>
              {% else %}
                <div class="friend-offline-text">Offline</div>
              {% endif %}
              <div class="friend-actions">
                <a href="{% url 'competitions:battle_create' %}?opponent={{ friend.id }}" class="btn-battle">
                  <i class="bi bi-lightning-charge-fill"></i> Jang
                </a>
                <a href="{% url 'accounts:friend_remove' friend.id %}" class="btn-remove"
                   onclick="return confirm('Do\'stlikni bekor qilasizmi?')">
                  <i class="bi bi-person-x"></i>
                </a>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <p>Hali do'stlar yo'q. Yuqoridagi qidiruv orqali do'st qo'shing!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const input = document.getElementById('friendSearchInput');
  const results = document.getElementById('searchResults');
  let timer = null;

  input.addEventListener('input', function() {
    clearTimeout(timer);
    const q = this.value.trim();
    if (q.length < 2) {
      results.innerHTML = '';
      return;
    }
    timer = setTimeout(() => searchFriends(q), 350);
  });

  function searchFriends(q) {
    fetch(`{% url 'accounts:friend_search' %}?q=${encodeURIComponent(q)}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => renderResults(data.users || []))
    .catch(() => {});
  }

  function renderResults(users) {
    if (!users.length) {
      results.innerHTML = '<p style="color:#94a3b8;font-size:0.85rem;margin-top:0.75rem;">Hech kim topilmadi</p>';
      return;
    }
    results.innerHTML = users.map(u => {
      const initials = (u.name || '?')[0].toUpperCase();
      const avatar = u.avatar
        ? `<img src="${u.avatar}" class="user-avatar" alt="">`
        : `<div class="user-avatar-placeholder">${initials}</div>`;

      let btn = '';
      if (u.friendship_status === 'sent') {
        btn = `<span class="btn-add btn-add-sent">Yuborildi</span>`;
      } else if (u.friendship_status === 'received') {
        btn = `<span class="btn-add btn-add-sent">Keldi</span>`;
      } else {
        btn = `<a href="/accounts/friends/add/${u.id}/" class="btn-add btn-add-primary">+ Do'st</a>`;
      }

      return `<div class="user-card">
        ${avatar}
        <div class="user-info">
          <div class="user-name">${u.name}</div>
          <div class="user-level">${u.level || ''}</div>
        </div>
        ${btn}
      </div>`;
    }).join('');
  }

  // Online status real-time yangilash (WebSocket orqali)
  document.addEventListener('ws:online_status', function(e) {
    const { user_id, is_online } = e.detail;
    const card = document.querySelector(`[data-user-id="${user_id}"]`);
    if (!card) return;
    const dot = card.querySelector('.online-dot, .offline-dot');
    const txt = card.querySelector('.friend-online-text, .friend-offline-text');
    if (dot) {
      dot.className = is_online ? 'online-dot' : 'offline-dot';
    }
    if (txt) {
      txt.className = is_online ? 'friend-online-text' : 'friend-offline-text';
      txt.innerHTML = is_online
        ? '<i class="bi bi-circle-fill" style="font-size:0.55rem;"></i> Online'
        : 'Offline';
    }
  });
})();
</script>
{% endblock %}
