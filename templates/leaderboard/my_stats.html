{% extends 'base.html' %}
{% load static %}

{% block title %}Mening statistikam - TestMakon{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 768px) {
    .mystats-hero { padding: 1.5rem 0 !important; }
    .mystats-hero h1 { font-size: 1.5rem; }
    .mystats-hero div[style*="width: 80px"] { width: 60px !important; height: 60px !important; }
    .col-6 .card.p-4 { padding: 1rem !important; }
    .col-6 .card div[style*="font-size: 2.5rem"] { font-size: 1.5rem !important; }
    .card-body { padding: 1rem !important; }
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="mystats-hero" style="background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 50%, #F1F5F9 100%); padding: 3rem 0;">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Bosh sahifa</a></li>
                <li class="breadcrumb-item"><a href="{% url 'leaderboard:leaderboard_main' %}">Reyting</a></li>
                <li class="breadcrumb-item active">Statistikam</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-4">
            <div style="width: 80px; height: 80px; background: var(--gray-200); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--primary);">
                {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <i class="bi bi-person-fill" style="font-size: 2.5rem; color: var(--gray-500);"></i>
                {% endif %}
            </div>
            <div>
                <h1 class="mb-2">{{ user.full_name|default:user.phone_number }}</h1>
                <div class="d-flex flex-wrap gap-3">
                    <span class="badge badge-primary">Level {{ user.level }}</span>
                    <span style="color: var(--gray-500);"><i class="bi bi-star-fill text-warning me-1"></i> {{ user.xp_points }} XP</span>
                    <span style="color: var(--gray-500);"><i class="bi bi-fire text-danger me-1"></i> {{ user.current_streak }} kun streak</span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section-sm">
    <div class="container">
        <!-- Quick Stats -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card p-4 text-center h-100">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);">{{ test_stats.total }}</div>
                    <div style="color: var(--gray-500);">Jami testlar</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-4 text-center h-100">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--dark);">{{ test_stats.total_xp }}</div>
                    <div style="color: var(--gray-500);">Jami XP</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-4 text-center h-100">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--dark);">{{ test_stats.avg_score|floatformat:0 }}%</div>
                    <div style="color: var(--gray-500);">O'rtacha ball</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-4 text-center h-100">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--dark);">#{{ user.global_rank|default:"â€”" }}</div>
                    <div style="color: var(--gray-500);">Umumiy o'rin</div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Main Stats -->
            <div class="col-lg-8">
                <!-- Detailed Stats -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">
                            <i class="bi bi-graph-up me-2" style="color: var(--primary);"></i> Batafsil statistika
                        </h5>

                        <div class="row g-4">
                            <!-- Test Stats -->
                            <div class="col-md-6">
                                <h6 class="text-uppercase small fw-bold mb-3" style="color: var(--gray-500);">Test statistikasi</h6>
                                <div class="d-flex flex-column gap-3">
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Jami savollar</span>
                                        <span class="fw-bold">{{ stats.total_questions_answered }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">To'g'ri javoblar</span>
                                        <span class="fw-bold text-success">{{ stats.total_correct }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Noto'g'ri javoblar</span>
                                        <span class="fw-bold text-danger">{{ stats.total_wrong }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Aniqlik</span>
                                        <span class="fw-bold" style="color: var(--primary);">{{ stats.accuracy_rate }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Time & Streak -->
                            <div class="col-md-6">
                                <h6 class="text-uppercase small fw-bold mb-3" style="color: var(--gray-500);">Vaqt va streak</h6>
                                <div class="d-flex flex-column gap-3">
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Jami vaqt</span>
                                        <span class="fw-bold">{{ stats.total_time_spent }} daqiqa</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">O'rtacha vaqt/savol</span>
                                        <span class="fw-bold">{{ stats.average_time_per_question|floatformat:1 }}s</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Joriy streak</span>
                                        <span class="fw-bold">{{ user.current_streak }} kun</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Eng uzun streak</span>
                                        <span class="fw-bold" style="color: var(--accent);">{{ stats.best_streak }} kun</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Competition Stats -->
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h6 class="text-uppercase small fw-bold mb-3" style="color: var(--gray-500);">Jang statistikasi</h6>
                                <div class="d-flex flex-column gap-3">
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Yutilgan janglar</span>
                                        <span class="fw-bold text-success">{{ stats.battles_won }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Yutqazilgan</span>
                                        <span class="fw-bold text-danger">{{ stats.battles_lost }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Durrang</span>
                                        <span class="fw-bold">{{ stats.battles_draw }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Yutish foizi</span>
                                        <span class="fw-bold" style="color: var(--primary);">{{ stats.win_rate }}%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-uppercase small fw-bold mb-3" style="color: var(--gray-500);">Eng yaxshi natijalar</h6>
                                <div class="d-flex flex-column gap-3">
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Eng yuqori ball</span>
                                        <span class="fw-bold" style="color: var(--accent);">{{ stats.best_score|floatformat:0 }}%</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Eng yuqori aniqlik</span>
                                        <span class="fw-bold">{{ stats.best_accuracy|floatformat:0 }}%</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Musobaqalar</span>
                                        <span class="fw-bold">{{ stats.competitions_participated }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span style="color: var(--gray-500);">Top 3 musobaqalar</span>
                                        <span class="fw-bold" style="color: var(--primary);">{{ stats.competitions_top3 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subject Stats -->
                {% if subject_stats %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">
                            <i class="bi bi-book me-2" style="color: var(--primary);"></i> Fanlar bo'yicha
                        </h5>

                        <div class="d-flex flex-column gap-3">
                            {% for item in subject_stats %}
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="font-size: 1.25rem;">{{ item.subject.icon|default:"ðŸ“š" }}</span>
                                        <span class="fw-bold">{{ item.subject.name }}</span>
                                        <small style="color: var(--gray-500);">({{ item.count }} test)</small>
                                    </div>
                                    <span class="fw-bold" style="color: var(--primary);">{{ item.avg_score }}%</span>
                                </div>
                                <div style="background: var(--gray-200); border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: var(--gradient-primary); height: 100%; width: {{ item.avg_score }}%; border-radius: 10px;"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Today Stats -->
                <div class="card mb-4" style="background: var(--gradient-primary); border: none;">
                    <div class="card-body">
                        <h6 class="text-white mb-3">Bugungi natija</h6>
                        <div class="d-flex justify-content-between text-white mb-2">
                            <span style="opacity: 0.8;">XP</span>
                            <span class="fw-bold">+{{ stats.today_xp }}</span>
                        </div>
                        <div class="d-flex justify-content-between text-white mb-2">
                            <span style="opacity: 0.8;">Testlar</span>
                            <span class="fw-bold">{{ stats.today_tests }}</span>
                        </div>
                        <div class="d-flex justify-content-between text-white">
                            <span style="opacity: 0.8;">To'g'ri javoblar</span>
                            <span class="fw-bold">{{ stats.today_correct }}</span>
                        </div>
                    </div>
                </div>

                <!-- Weekly Stats -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-calendar-week me-2" style="color: var(--primary);"></i> Haftalik natija
                        </h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span style="color: var(--gray-500);">XP</span>
                            <span class="fw-bold">+{{ stats.weekly_xp }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span style="color: var(--gray-500);">Testlar</span>
                            <span class="fw-bold">{{ stats.weekly_tests }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span style="color: var(--gray-500);">To'g'ri javoblar</span>
                            <span class="fw-bold">{{ stats.weekly_correct }}</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Achievements -->
                {% if achievements %}
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">
                                <i class="bi bi-award me-2" style="color: var(--accent);"></i> Oxirgi yutuqlar
                            </h6>
                            <a href="{% url 'leaderboard:achievements_list' %}" class="small">Barchasi</a>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            {% for ua in achievements %}
                            <div class="d-flex align-items-center gap-2 p-2" style="background: var(--gray-100); border-radius: var(--radius);">
                                <div style="width: 36px; height: 36px; background: var(--gradient-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    {% if ua.achievement.icon %}
                                        <img src="{{ ua.achievement.icon.url }}" alt="" style="width: 20px; height: 20px; object-fit: contain;">
                                    {% else %}
                                        <i class="bi bi-award text-white" style="font-size: 0.9rem;"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="small fw-bold">{{ ua.achievement.name }}</div>
                                    <div class="small" style="color: var(--gray-500);">{{ ua.earned_at|timesince }} oldin</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}